/*! recallTests 23-03-2015 */

angular.module("recall",[]),angular.module("recall").factory("recallAdapterResponse",[function(){var a=function(b,c,d,e,f){this.data=b,this.count=c||0,this.status=d||a.OK,this.headers=e,this.config=f};return a.OK=200,a.CREATED=201,a.ACCEPTED=202,a.NO_CONTENT=204,a.BAD_REQUEST=400,a.UNAUTHORIZED=401,a.NOT_FOUND=404,a.CONFLICT=409,a.INTERNAL_SERVER_ERROR=500,a.NOT_IMPLEMENTED=501,a}]),angular.module("recall.adapter.indexedDB",["recall"]).provider("recallIndexedDBAdapter",[function(){var a={};a.dbName="recall",this.setDbName=function(b){return a.dbName=b,this},a.dbVersion=1,this.setDbVersion=function(b){return a.dbVersion=b,this},a.pkGenerator=function(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()},this.setPkGenerator=function(b){return a.pkGenerator=b,this},this.dropDatabase=function(){try{window.indexedDB.deleteDatabase(a.dbName)}catch(b){return b}return!0},this.$get=["$log","$q","$window","recall","recallAdapterResponse",function(b,c,d,e,f){var g,h={},i=a.pkGenerator,j=function(a){var b,c,d,f,g,h=e.getModels();for(b=0;b<h.length;b++)if(c=h[b],!a.objectStoreNames.contains(c.dataSourceName)){g=a.createObjectStore(c.dataSourceName,{keyPath:c.primaryKeyFieldName});for(d in c.fields)c.fields.hasOwnProperty(d)&&(c.fields[d].unique===!0||c.fields[d].index!==!1)&&(f=c.fields[d].index===!0?d:c.fields[d].index,g.createIndex(d,f,{unique:c.fields[d].unique}))}},k=function(a){g=a,g.onversionchange=function(){g.close(),b.error("IndexedDBAdapter: DB version changed in a different window"),alert("A new version of this page is ready. Please reload!")}},l=function(){var e=c.defer();if(g)e.resolve(g);else{var f=d.indexedDB.open(a.dbName,a.dbVersion);f.onupgradeneeded=function(a){b.info("IndexedDBAdapter: Migrating...",a),k(a.target.result),j(a.target.result)},f.onsuccess=function(a){b.debug("IndexedDBAdapter: Connection Success",a),k(a.target.result),e.resolve(g)},f.onerror=function(a){b.error("IndexedDBAdapter: Connection Error",a),e.reject(a.target.errorCode)}}return e.promise};h.create=function(a,d){var e,h=c.defer(),j=function(c){return e=new f(c,0,f.INTERNAL_SERVER_ERROR),b.error("IndexedDBAdapter: Create "+a.modelName,e,d),e};return d[a.primaryKeyFieldName]=i(),d=a.getRawModelObject(d,!1),d[a.lastModifiedFieldName]=(new Date).toISOString(),l().then(function(){var c=[a.dataSourceName],i=g.transaction(c,"readwrite"),k=i.objectStore(a.dataSourceName),l=k.add(d);l.onsuccess=function(){e=new f(d,1,f.CREATED),b.debug("IndexedDBAdapter: Create "+a.modelName,e),h.resolve(e)},l.onerror=function(){h.reject(j(this.error))}},function(a){h.reject(j(a))}),h.promise},h.findOne=function(a,d,e,h){var i,j=c.defer(),k=function(c,g){return i=new f(c,0,g||f.INTERNAL_SERVER_ERROR),b.error("IndexedDBAdapter: FindOne "+a.modelName,i,d,e),i};return l().then(function(){var c=[a.dataSourceName].concat(p(a,e)),l=g.transaction(c),m=l.objectStore(a.dataSourceName),n=m.get(d);n.onsuccess=function(){!n.result||!h&&n.result[a.deletedFieldName]?j.reject(k("Not Found",f.NOT_FOUND)):t(n.result,a,e,l).then(function(){i=new f(n.result,1),b.debug("IndexedDBAdapter: FindOne "+a.modelName,i,d,e),j.resolve(i)},function(a){j.reject(k(a))})},n.onerror=function(){j.reject(k(this.error))}},function(a){j.reject(k(a))}),j.promise},h.find=function(a,d,e){var h,i=c.defer(),j=function(c){return h=new f(c,0,f.INTERNAL_SERVER_ERROR),b.error("IndexedDBAdapter: Find "+a.modelName,h,d),h};return l().then(function(){var k,l=[a.dataSourceName].concat(p(a,d)),m=g.transaction(l),n=m.objectStore(a.dataSourceName),o=n.openCursor(),q=[];d&&d.$filter()&&(k=d.$filter()),o.onsuccess=function(g){var l=g.target.result;if(l)(e||!l.value[a.deletedFieldName])&&(k?u(l.value,k)&&q.push(l.value):q.push(l.value)),l["continue"]();else{var n,o=[];for(n=0;n<q.length;n++)o.push(t(q[n],a,d,m));c.all(o).then(function(){q=v(q,k),q=w(q,d);var c=q.length;q=x(q,d),h=new f(q,c),b.debug("IndexedDBAdapter: Find "+a.modelName,h,d),i.resolve(h)},function(a){i.reject(j(a))})}},o.onerror=function(){i.reject(j(this.error))}},function(a){i.reject(j(a))}),i.promise},h.update=function(a,d,e,h){var i,j=c.defer(),k=function(c){return i=new f(c,0,f.INTERNAL_SERVER_ERROR),b.error("IndexedDBAdapter: Update "+a.modelName,i,e),i};return l().then(function(){var c=[a.dataSourceName],l=g.transaction(c,"readwrite"),m=l.objectStore(a.dataSourceName),n=m.get(d);n.onsuccess=function(){if(!n.result||!h&&n.result[a.deletedFieldName])j.reject(k("Not Found",f.NOT_FOUND));else{var c=n.result;delete e[a.primaryKeyFieldName],angular.extend(c,e),c[a.lastModifiedFieldName]=(new Date).toISOString(),c=a.getRawModelObject(c,!1);var d=m.put(c);d.onsuccess=function(){i=new f(c,1),b.debug("IndexedDBAdapter: Update "+a.modelName,i,e),j.resolve(i)},d.onerror=function(){j.reject(k(this.error))}}},n.onerror=function(){j.reject(k(this.error))}},function(a){j.reject(k(a))}),j.promise},h.remove=function(a,d){var e,h=c.defer(),i=function(c){return e=new f(c,0,f.INTERNAL_SERVER_ERROR),b.error("IndexedDBAdapter: Remove "+a.modelName,e),e};return l().then(function(){var c=[a.dataSourceName],j=g.transaction(c,"readwrite"),k=j.objectStore(a.dataSourceName),l=k.get(d);l.onsuccess=function(){if(l.result&&!l.result[a.deletedFieldName]){var c=l.result;c[a.deletedFieldName]=!0,c[a.lastModifiedFieldName]=(new Date).toISOString();var d=k.put(c);d.onsuccess=function(){e=new f(null,1,f.NO_CONTENT),b.debug("IndexedDBAdapter: Remove "+a.modelName,e),h.resolve(e)},d.onerror=function(){h.reject(i(this.error))}}else h.reject(i("Not Found",f.NOT_FOUND))},l.onerror=function(){h.reject(i(this.error))}},function(a){h.reject(i(a))}),h.promise},h.synchronize=function(a,d){var e,h=c.defer(),i=function(c){return e=new f(c,0,f.INTERNAL_SERVER_ERROR),b.error("IndexedDBAdapter: Synchronize "+a.modelName,e,d),e};return l().then(function(){var j,k=[a.dataSourceName],l=g.transaction(k,"readwrite"),o=[];for(j=0;j<d.length;j++)o.push(d[j][a.deletedFieldName]?n(a,l,d[j][a.primaryKeyFieldName]):m(a,l,d[j]));c.all(o).then(function(c){e=new f(c,c.length,f.OK),b.debug("IndexedDBAdapter: Synchronize "+a.modelName,e,d),h.resolve(e)},function(a){h.reject(i(a))})},function(a){h.reject(i(a))}),h.promise};var m=function(a,b,d){var e=c.defer(),f=b.objectStore(a.dataSourceName),g=f.get(d[a.primaryKeyFieldName]);return g.onsuccess=function(){var b=g.result;if(b){angular.extend(b,d),b=a.getRawModelObject(b,!1);var c=f.put(b);c.onsuccess=function(){e.resolve(b)},c.onerror=function(){e.reject(this.error)}}else{var h=f.add(d);h.onsuccess=function(){e.resolve(d)},h.onerror=function(){e.reject(this.error)}}},g.onerror=function(){e.reject(this.error)},e.promise},n=function(a,b,d){var e=c.defer(),f=b.objectStore(a.dataSourceName),g=f["delete"](d);return g.onsuccess=function(){e.resolve()},g.onerror=function(){e.reject(this.error)},e.promise},o=function(a,b){var c=[],d=b.split("."),e=d[0];if(e){var f=a.getAssociationByAlias(e),g=f.getModel();f&&g&&(c.push(g.dataSourceName),d.length>1&&(c=c.concat(o(g,d.substring(d.indexOf(".")+1)))))}return c},p=function(a,b){var c,d=[];if(b&&(c=b.$expand()),c){var e,f=c.split(",");for(e=0;e<f.length;e++)d=d.concat(o(a,f[e]))}return d},q=function(a,b,d,e,f){var g=c.defer(),h=e.objectStore(a.dataSourceName),i=f.join("."),j=h.get(b[d.mappedBy]);return j.onsuccess=function(){b[d.alias]=j.result,f.length>1?s(j.result,a,i.substring(i.indexOf(".")+1),e).then(function(){g.resolve()},function(a){g.reject(a)}):g.resolve()},j.onerror=function(){g.reject(this.error)},g.promise},r=function(a,b,d,e,f){var g=c.defer(),h=e.objectStore(a.dataSourceName),i=f.join("."),j=h.index(d.mappedBy),k=j.openCursor(),l=[];return k.onsuccess=function(h){var j=h.target.result;if(j)j.key===b[a.primaryKeyFieldName]&&l.push(j.value),j["continue"]();else if(b[d.alias]=l,f.length>1){var k,m=[];for(k=0;k<l.length;k++)m.push(s(l[k],a,i.substring(i.indexOf(".")+1),e));c.all(m).then(function(){g.resolve()},function(a){g.reject(a)})}else g.resolve()},k.onerror=function(){g.reject(this.error)},g.promise},s=function(a,b,d,e){var f=d.split("."),g=f[0];if(g){var h=b.getAssociationByAlias(g),i=h.getModel();if(h&&i){if("hasOne"===h.type)return q(i,a,h,e,f);if("hasMany"===h.type)return r(i,a,h,e,f)}}var j=c.defer();return j.resolve(),j.promise},t=function(a,d,e,f){var g,h=c.defer(),i=[];if(e&&(g=e.$expand()),g){var j,k=g.split(",");for(j=0;j<k.length;j++)i.push(s(a,d,k[j],f));c.all(i).then(function(){h.resolve()},function(c){b.error("IndexedDBAdapter: PerformExpand",c,g,a),h.reject(c)})}else h.resolve();return h.promise},u=function(a,b){return b.test(a)},v=function(a,b){return b&&a&&a.filter(function(a){return u(a,b)}),a},w=function(a,b){if(!b)return a;var c=b.$orderBy();if(c){var d=c.split(" ")[0],e=c.split(" ")[1]||"";a.sort(function(a,b){return a[d]>b[d]?"desc"===e.toLowerCase()?-1:1:b[d]>a[d]?"desc"===e.toLowerCase()?1:-1:0})}return a},x=function(a,b){if(!b)return a;var c=b.$top(),d=b.$skip();return c>0&&d>=0&&(a=a.slice(d,d+c)),a};return h}]}]),angular.module("recall.adapter.oDataREST",["recall"]).provider("recallODataRESTAdapter",[function(){var a={};a.serverAPILocation="/api/",this.setServerAPILocation=function(b){return"/"!==b.substring(b.length-1)&&(b+="/"),a.serverAPILocation=b,this},a.resultsField="results",this.setResultsField=function(b){return a.resultsField=b,this},a.totalCountFiled="totalCount",this.setTotalCountFiled=function(b){return a.totalCountFiled=b,this},this.$get=["$http","$log","$q","recallAdapterResponse",function(b,c,d,e){var f={},g=function(a,b){return a+=b?b.parseOptions():""};return f.create=function(f,g){var h,i=d.defer(),j=a.serverAPILocation+f.dataSourceName;return b.post(j,g).success(function(a,b,d,g){h=new e(a,1,b,d,g),c.debug("ODataRESTAdapter: Create "+f.modelName,h),i.resolve(h)}).error(function(a,b,d,j){h=new e(a,0,b,d,j),c.error("ODataRESTAdapter: Create "+f.modelName,h,g),i.reject(h)}),i.promise},f.findOne=function(f,h,i){var j,k=d.defer();if(!h)return j=new e("No Primary Key was supplied",0,e.BAD_REQUEST),c.error("ODataRESTAdapter: FindOne "+f.modelName,j,h,i),d.reject(j);var l=g(a.serverAPILocation+f.dataSourceName+"/"+h,i);return b.get(l).success(function(a,b,d,g){j=new e(a,1,b,d,g),c.debug("ODataRESTAdapter: FindOne "+f.modelName,j,h,i),k.resolve(j)}).error(function(a,b,d,g){j=new e(a,0,b,d,g),c.error("ODataRESTAdapter: FindOne "+f.modelName,j,h,i),k.reject(j)}),k.promise},f.find=function(f,h){var i,j=d.defer(),k=g(a.serverAPILocation+f.dataSourceName);return b.get(k).success(function(b,d,g,k){var l,m=b;a.resultsField&&(b[a.resultsField]&&(m=b[a.resultsField]),a.totalCountFiled&&b[a.totalCountFiled]&&(l=b[a.totalCountFiled])),i=new e(m,l,d,g,k),c.debug("ODataRESTAdapter: Find "+f.modelName,i,h),j.resolve(i)}).error(function(a,b,d,g){i=new e(a,0,b,d,g),c.error("ODataRESTAdapter: Find "+f.modelName,i,h),j.reject(i)}),j.promise},f.update=function(f,g,h){var i,j=d.defer();if(!g)return i=new e("No Primary Key was supplied",0,e.BAD_REQUEST),c.error("ODataRESTAdapter: Update "+f.modelName,i,h),d.reject(i);var k=a.serverAPILocation+f.dataSourceName+"/"+g;return b.put(k,h).success(function(a,b,d,g){i=new e(a,1,b,d,g),c.debug("ODataRESTAdapter: Update "+f.modelName,i,h),j.resolve(i)}).error(function(a,b,d,g){i=new e(a,0,b,d,g),c.error("ODataRESTAdapter: Update "+f.modelName,i,h),j.reject(i)}),j.promise},f.remove=function(f,g){var h,i=d.defer();if(!g)return h=new e("No Primary Key was supplied",0,e.BAD_REQUEST),c.error("ODataRESTAdapter: Remove "+f.modelName,h,g),d.reject(h);var j=a.serverAPILocation+f.dataSourceName+"/"+g;return b({method:"DELETE",url:j}).success(function(a,b,d,j){h=new e(a,1,b,d,j),c.debug("ODataRESTAdapter: Remove "+f.modelName,h,g),i.resolve(h)}).error(function(a,b,d,j){h=new e(a,0,b,d,j),c.error("ODataRESTAdapter: Remove "+f.modelName,h,g),i.reject(h)}),i.promise},f.synchronize=function(f,g,h){var i,j=d.defer(),k=a.serverAPILocation+f.dataSourceName;return b.put(k,{data:g,lastSync:h}).success(function(b,d,h,k){var l,m=b;a.resultsField&&(b[a.resultsField]&&(m=b[a.resultsField]),a.totalCountFiled&&b[a.totalCountFiled]&&(l=b[a.totalCountFiled])),i=new e(m,l,d,h,k),c.debug("ODataRESTAdapter: Synchronize "+f.modelName,i,g),j.resolve(i)}).error(function(a,b,d,h){i=new e(a,0,b,d,h),c.error("ODataRESTAdapter: Synchronize "+f.modelName,i,g),j.reject(i)}),j.promise},f}]}]),angular.module("recall").factory("recallAssociation",["$log","$q","recallPredicate","recallPreparedQueryOptions",function(a,b,c,d){var e=function(b){this.invalid=!1,b.type?this.type=b.type:"string"==typeof b.hasOne?this.type="hasOne":"string"==typeof b.hasMany&&(this.type="hasMany"),this.modelName=b.modelName||b.hasOne||b.hasMany,this.alias=b.as||b.alias||this.modelName,this.mappedBy=b.mappedBy||b.foreignKey,this.getModel=function(){return e.getAssociationModel(this.modelName)},this.modelName&&this.type&&this.mappedBy||(a.error("Association: The association definition is invalid",b),this.invalid=!0)};return e.prototype.expand=function(e,f){var g=b.defer(),h=this,i=h.getModel();if(!i)return b.reject("Association: Expand could not find the association's Model");var j=f===!0&&i.remoteAdapter?i.remoteAdapter:i.localAdapter;if("hasOne"===h.type)j.findOne(i,e[h.mappedBy]).then(function(b){e[h.alias]=i.getRawModelObject(b.data),e.$entity.storedState[h.alias]=i.getRawModelObject(b.data),a.debug("Association: Expand",h.type,h.alias,e,b),g.resolve()},function(b){a.error("Association: Expand",h.type,h.alias,e,b),g.reject(b)});else if("hasMany"===h.type){var k=new c(h.mappedBy).equals(e.$getPrimaryKey()),l=(new d).$filter(k);j.find(i,l).then(function(b){var c,d=[],f=[];for(c=0;c<b.data.length;c++)d.push(i.getRawModelObject(b.data[c])),f.push(i.getRawModelObject(b.data[c]));e[h.alias]=d,e.$entity.storedState[h.alias]=f,a.debug("Association: Expand",h.type,h.alias,e,b),g.resolve()},function(b){a.error("Association: Expand",h.type,h.alias,e,b),g.reject(b)})}return g.promise()},e.getAssociationModel=null,e}]),angular.module("recall").factory("recallBaseModelService",["$injector","$log","$q","recallAssociation","recallModelField","recallPreparedQueryOptions","recallPredicate","recallSyncHandler",function(a,b,c,d,e,f,g,h){var i={dirtyCheckThreshold:30,lastModifiedFieldName:"",deletedFieldName:"",localAdapter:{},remoteAdapter:{},models:{}},j=function(a){return c.reject(a)},k=function(a){angular.extend(this,a)},l=function(a){angular.extend(this,a)},m=function(){return this};return d.getAssociationModel=function(a){return i.getModel(a)},i.setDirtyCheckThreshold=function(a){i.dirtyCheckThreshold=a||30},i.setLastModifiedFieldName=function(a){i.lastModifiedFieldName=a},i.setDeletedFieldName=function(a){i.deletedFieldName=a},i.setLocalAdapter=function(a){i.localAdapter=a},i.setRemoteAdapter=function(a){i.remoteAdapter=a},i.getModels=function(){var a,b=[];for(a in i.models)i.models.hasOwnProperty(a)&&b.push(i.models[a]);return b},i.getModel=function(a){return i.models[a]||null},i.defineModel=function(f,g,n){if(g=g||i.localAdapter,n=n||i.remoteAdapter,g="string"==typeof g?a.get(g):g,n="string"==typeof n?a.get(n):n,!n&&!g)return null;if(n&&!g&&(g=n,n=null),!f||!f.name)return null;if(i.models[f.name])return i.models[f.name];var o=function(a,b,c){o.extendFromRawObject(this,a),this.$entity={adapter:c||g,lastDirtyCheck:(new Date).getTime(),lastDirtyState:!1,persisted:b===!0,saveInProgress:!1,storedState:null},this.$storeState()};o.fields={},o.associations=[],o.primaryKeyFieldName=null,o.lastModifiedFieldName=i.lastModifiedFieldName,o.deletedFieldName=i.deletedFieldName,o.localAdapter=g,o.remoteAdapter=n,o.modelName=f.name,o.dataSourceName=f.dataSourceName||f.name;var p=function(){var a,c,d,g;for(a in f.fields)f.fields.hasOwnProperty(a)&&(c=new e(a,f.fields[a]),c.primaryKey&&(o.primaryKeyFieldName=a),c.invalid||(o.fields[a]=c),a===i.lastModifiedFieldName&&(d=c),a===i.deletedFieldName&&(g=a));return d&&"Date"!==d.type?(b.error("BaseModelService: The last modified field is not a Date field"),!1):(i.lastModifiedFieldName&&!d&&(o.fields[i.lastModifiedFieldName]=new e(i.lastModifiedFieldName,{type:"Date",index:!0})),i.deletedFieldName&&!g&&(o.fields[i.deletedFieldName]=new e(i.deletedFieldName,{type:"Boolean",index:!0})),!0)};if(!p())return null;var q=function(){if(f.associations){var a,b;for(a=0;a<f.associations.length;a++)b=new d(f.associations[a]),b&&!b.invalid&&("hasOne"===b.type&&(o.fields[b.mappedBy]?o.fields[b.mappedBy].index=b.mappedBy:o.fields[b.mappedBy]=new e(b.mappedBy,{type:o.fields[o.primaryKeyFieldName].type,index:b.mappedBy})),o.associations.push(b))}};return q(),o.getAssociationByAlias=function(a){var b;for(b=0;b<o.associations.length;b++)if(o.associations[b].alias===a)return o.associations[b]},o.extendFromRawObject=function(a,b){angular.extend(a,o.getRawModelObject(b))},o.getRawModelObject=function(a,b){var c,d=new m;for(c in o.fields)o.fields.hasOwnProperty(c)&&(d[c]=a[c]);var e,f,g,h,i;for(e=0;e<o.associations.length;e++)if(f=o.associations[e].alias,h=o.associations[e].getModel(),"hasOne"===o.associations[e].type)void 0!==a[f]&&b!==!1&&(g=a[f][h.primaryKeyFieldName],d[o.associations[e].mappedBy]=g,d[f]=h.getRawModelObject(a[f])),a[o.associations[e].mappedBy]&&(d[o.associations[e].mappedBy]=a[o.associations[e].mappedBy]);else if("hasMany"===o.associations[e].type&&b!==!1&&void 0!==a[f]&&a[f]instanceof Array)for(d[f]=[],i=0;i<a[f].length;i++)d[f].push(h.getRawModelObject(a[f][i]));return d},o.applyDefaultValues=function(a){var b;for(b in o.fields)o.fields.hasOwnProperty(b)&&"function"==typeof o.fields[b].getDefaultValue&&void 0===a[b]&&(a[b]=o.fields[b].getDefaultValue(a))},o.transformResult=function(a){return a=o.getRawModelObject(a),"function"==typeof f.transformResult?f.transformResult(a):a},o.preSave=function(a){return a=o.getRawModelObject(a),"function"==typeof f.preSave?f.preSave(a):a},o.preCreate=function(a){return o.applyDefaultValues(a),"function"==typeof f.preCreate?f.preCreate(a):a},o.preUpdate=function(a){return"function"==typeof f.preUpdate?f.preUpdate(a):a},o.findOne=function(a,d,e){if(!a)return b.error("BaseModelService: FindOne","The primary key was not supplied"),c.reject("The primary key was not supplied.");var f=e===!0&&n?n:g;return f.findOne(new k(o),a,d).then(function(a){var c=o.transformResult(a.data),e=new o(c,!0,f);return b.debug("BaseModelService: FindOne",new l(e),a,d),e},j)},o.find=function(a,c){var d=c===!0&&n?n:g;return d.find(new k(o),a).then(function(c){var e,f=[];for(e=0;e<c.data.length;e++)f.push(new o(o.transformResult(c.data[e]),!0,d));var g={results:f,totalCount:c.count};return b.debug("BaseModelService: Find",new l(g),c,a),g},j)},o.remove=function(a,d){if(!a)return b.error("BaseModelService: Remove","The primary key was not supplied"),c.reject("The primary key was not supplied.");var e=d===!0&&n?n:g;return e.remove(new k(o),a)},o.synchronize=function(){return h.model(o)},o.prototype.$sync=function(){return h.entity(o,this)},o.prototype.$getPrimaryKey=function(){return this[o.primaryKeyFieldName]},o.prototype.$expand=function(a){var b=o.getAssociationByAlias(a);return b?b.expand(this,this.$entity.adapter===n):c.reject("BaseModelService: $expand could not find the association to expand.",a,this)},o.prototype.$isValid=function(){var a,c,d=!0,e=!1;for(a in o.fields)if(o.fields.hasOwnProperty(a)){if(c=null===this[a]||void 0===this[a],o.fields[a].notNull===!0&&c)return b.debug("BaseModelService: $isValid returned false","NotNull field was null",a,this),!1;switch(o.fields[a].type){case"String":e="string"==typeof this[a];break;case"Number":e="number"==typeof this[a];break;case"Boolean":e=this[a]===!0||this[a]===!1;break;case"Date":e=this[a]instanceof Date&&!isNaN(Date.parse(this[a]))}if(!e&&!c)return b.debug("BaseModelService: $isValid returned false","The type was not "+o.fields[a].type,a,this),!1;if("function"==typeof o.fields[a].validate&&(d=o.fields[a].validate(this[a]),!d))return b.debug("BaseModelService: $isValid returned false","Custom validator failed",a,this),!1}return d},o.prototype.$save=function(a){var d=this,e=o.preSave(this),f=a===!0&&n?n:d.$entity.adapter;this.$entity.saveInProgress=!0;var g=function(a,b){b!==!1?(d.$storeState(),d.$entity.persisted=!0,d.$entity.saveInProgress=!1,d.$entity.adapter=f):(d.$reset(),d.$entity.saveInProgress=!1)};return d.$entity.persisted&&e[o.primaryKeyFieldName]?(e=o.preUpdate(e),d.$isValid()?f.update(new k(o),e[o.primaryKeyFieldName],e).then(function(a){var c=o.transformResult(a.data);return o.extendFromRawObject(d,c),g(d,!0),b.debug("BaseModelService: $save: update",d,e,a),d},function(a){return g(d,!1),b.error("BaseModelService: $save: update",d,e,a),c.reject(a)}):(b.warn("BaseModelService: $save: aborted",d,d[o.primaryKeyFieldName]),d.$reset(),c.reject("aborted"))):(e=o.preCreate(e),d.$isValid()?f.create(new k(o),e).then(function(a){var c=o.transformResult(a.data);return o.extendFromRawObject(d,c),g(d,!0),b.debug("BaseModelService: $save: create",d,e,a),d},function(a){return g(d,!1),b.error("BaseModelService: $save: create",d,e,a),c.reject(a)}):(b.warn("BaseModelService: $save: aborted",d,d[o.primaryKeyFieldName]),d.$reset(),c.reject("aborted")))},o.prototype.$remove=function(a){if(this[o.primaryKeyFieldName]){var d=a===!0&&n?n:this.$entity.adapter;return d.remove(new k(o),this[o.primaryKeyFieldName])}return b.error("BaseModelService: $remove","The primary key was not found"),c.reject("The primary key was not found.")},o.prototype.$storeState=function(){this.$entity.storedState=o.getRawModelObject(this),this.$entity.lastDirtyCheck=(new Date).getTime(),this.$entity.lastDirtyState=!1},o.prototype.$isDirty=function(){if(this.$entity.saveInProgress)return!1;if(!this.$entity.storedState)return!1;var a=(new Date).getTime(),c=a-this.$entity.lastDirtyCheck;if(this.$entity.lastDirtyCheck&&c<i.dirtyCheckThreshold)return this.$entity.lastDirtyState;this.$entity.lastDirtyCheck=(new Date).getTime();var d,e,f,g=o.getRawModelObject(this);for(d in o.fields)if(o.fields.hasOwnProperty(d)&&(f=this.$entity.storedState[d],e=g[d],f!==e))return b.debug("BaseModelService: $isDirty",this[o.primaryKeyFieldName],!0,c),this.$entity.lastDirtyState=!0,!0;return b.debug("BaseModelService: $isDirty",this[o.primaryKeyFieldName],!1,c),this.$entity.lastDirtyState=!1,!1},o.prototype.$reset=function(){if(!this.$entity.storedState)return this.$storeState(),[];if(!this.$isDirty())return[];var a,c=[];for(a in this.$entity.storedState)this.$entity.storedState.hasOwnProperty(a)&&this[a]!==this.$entity.storedState[a]&&(c.push({name:a,before:this[a],after:this.$entity.storedState[a]}),this[a]=this.$entity.storedState[a]);return this.$entity.lastDirtyState=!1,this.$entity.lastDirtyCheck=(new Date).getTime(),b.debug("BaseModelService: $reset",this[o.primaryKeyFieldName],c),c},i.models[o.modelName]=o,o},i}]),angular.module("recall").factory("recallLocalStorage",[function(){var a={localStorage:window.localStorage,cookie:document.cookie,keys:{LAST_SYNC:"LAST_SYNC"}},b=function(b){return void 0!==a.keys[b]},c=function(a,b){return b&&(a+="_"+b),a};return a.set=function(d,e,f){if(b(d))if(d=c(d,f),a.supportsLocalStorage())a.localStorage.setItem(d,e);else{var g=432e3,h=encodeURIComponent(e);a.cookie=d+"="+h+"; max-age="+g+";"}},a.get=function(d,e){var f="";if(b(d))if(d=c(d,e),a.supportsLocalStorage())f=a.localStorage.getItem(d)||"";else{var g=new RegExp(d+"=([^;]+)","g"),h=g.exec(a.cookie);h&&(f=decodeURIComponent(h[1]))}return f},a.remove=function(d,e){b(d)&&(d=c(d,e),a.supportsLocalStorage()?a.localStorage.removeItem(d):a.cookie=d+"=; max-age=0;")},a.supportsLocalStorage=function(){try{return"localStorage"in window&&null!==window.localStorage}catch(a){return!1}},a}]),angular.module("recall").factory("recallModelField",["$log",function(a){var b=function(b,c){this.invalid=!1,this.name=b,"string"==typeof c?(this.type=c,this.primaryKey=!1,this.unique=!1,this.index=!1,this.notNull=!1):(this.type=c.type,this.primaryKey=c.primaryKey===!0,this.unique=c.unique===!0,this.index="string"==typeof c.index?c.index:c.index===!0?b:!1,this.notNull=c.notNull===!0,"function"==typeof c.getDefaultValue&&(this.getDefaultValue=c.getDefaultValue)),this.primaryKey&&(this.notNull=!1,this.unique=!1,this.index=!1),this.name&&this.type||(this.invalid=!0,a.error("ModelField: The field definition is invalid",this,c))};return b}]),Date.prototype.toISOString||!function(){function a(a){return 10>a?"0"+a:a}Date.prototype.toISOString=function(){return this.getUTCFullYear()+"-"+a(this.getUTCMonth()+1)+"-"+a(this.getUTCDate())+"T"+a(this.getUTCHours())+":"+a(this.getUTCMinutes())+":"+a(this.getUTCSeconds())+"."+(this.getUTCMilliseconds()/1e3).toFixed(3).slice(2,5)+"Z"}}(),angular.module("recall").factory("recallPredicate",[function(){function a(a,b){return this.property=a,this.parser=b,this}a.join=function(b,c){return b instanceof Array&&b.length>0?(new a).join(b,c):null},a.prototype.setProperty=function(a){return this.property=a,this},a.prototype.equals=function(a){return this.parser=function(){return this.property+" eq "+c(a)},this},a.prototype.notEqualTo=function(a){return this.parser=function(){return this.property+" ne "+c(a)},this},a.prototype.greaterThan=function(a){return this.parser=function(){return this.property+" gt "+c(a)},this},a.prototype.greaterThanOrEqualTo=function(a){return this.parser=function(){return this.property+" ge "+c(a)},this},a.prototype.lessThan=function(a){return this.parser=function(){return this.property+" lt "+c(a)},this},a.prototype.lessThanOrEqualTo=function(a){return this.parser=function(){return this.property+" le "+c(a)},this},a.prototype.contains=function(a){return this.parser=function(){return"substringof("+c(a)+", "+this.property+")"},this},a.prototype.startsWith=function(a){return this.parser=function(){return"startswith("+this.property+", "+c(a)+")"},this},a.prototype.endsWith=function(a){return this.parser=function(){return"endswith("+this.property+", "+c(a)+")"},this},a.prototype.join=function(b,c){var d;this.property&&"function"==typeof this.parser&&(d=new a(this.property,this.parser));var e=[];if(b instanceof a)e.push(b);else if(b instanceof Array&&b.length>0){var f;for(f=0;f<b.length;f++)b[f]&&e.push(b[f])}return e.length>0&&(delete this.parser,delete this.property,this.joinedPredicates=this.joinedPredicates?this.joinedPredicates.concat(e):e,(c||!this.groupOperator)&&(this.groupOperator="or"===c?"or":"and"),d&&this.joinedPredicates.unshift(d)),this},a.prototype.and=function(a){return this.join(a,"and")},a.prototype.or=function(a){return this.join(a,"or")},a.prototype.test=function(a,b){return f(this,a,b)},a.prototype.parsePredicate=function(a){a=a===!0;var b="";if(this.property&&"function"==typeof this.parser)return this.parser();if(this.joinedPredicates&&this.joinedPredicates.length>0){var c,d,e;for(c=0;c<this.joinedPredicates.length;c++)d=this.joinedPredicates[c],e=d.parsePredicate(!0),b+=c>0?" "+this.groupOperator+" "+e:e}return a?"("+b+")":b},a.fromString=function(a){if("string"!=typeof a)return null;var c=new RegExp("(substringof\\(.+?\\)|startswith\\(.+?\\)|endswith\\(.+?\\)|[\\w\\.]+?\\s(?:eq|ne|gt|ge|lt|le)\\s(?:\\w+|\\'.+?\\'))","g"),d=a.match(c);if(!d)return null;var e;for(e=0;e<d.length;e++)if(d[e]=k(d[e]),null===d[e])return null;return 0===d.length?null:(e=0,a=a.replace(c,function(){return e++}),1===d.length?""!==a.replace(/[0-9]|\s|and|or/g,"")?null:d[0]:b(a,d))};var b=function(b,c){for(var d,e,f,g,h,i,j=null,k=!0;k;){if(d=b.indexOf(")"),-1!==d?(e=b.lastIndexOf("(",d),f=b.substring(e+1,d),b=b.substring(0,e)+c.length+b.substring(d+1)):(f=b,k=!1),""!==f.replace(/[0-9]|\s|and|or/g,""))return null;if(f.indexOf("and")>=0&&f.indexOf("or")>=0)return null;g=f.match(/[0-9]+/g),h=[];var l;for(l=0;l<g.length;l++)h.push(c[Number(g[l])]);i=f.indexOf("or")>=0?"or":"and",j=(new a).join(h,i),c.push(j)}return j},c=function(a){return a instanceof Date&&(a=a.toISOString()),"string"==typeof a?"'"+a+"'":a.toString()},d=function(a){if("string"==typeof a){if(a.indexOf("'")>=0)return a.replace(/\'/g,"");if("true"===a.toLowerCase())return!0;if("false"===a.toLowerCase())return!1}return isNaN(a)?a:Number(a)},e=function(a,b){var c,d;for(d=0;d<a.joinedPredicates.length;d++){if(c=f(a.joinedPredicates[d],b),"and"===a.groupOperator&&c===!1)return!1;if("or"===a.groupOperator&&c===!0)return!0}return"and"===a.groupOperator},f=function(a,b,c){if(a.joinedPredicates&&a.joinedPredicates.length>0)return e(a,b);if(a.property){var d,f=a.property.split("."),i=b;for(d=0;d<f.length;d++){if(!i.hasOwnProperty(f[d])||void 0===i[f[d]])return c===!1;i=i[f[d]]}var j=a.parsePredicate();return j.indexOf("(")>=0?g(j,i):h(j,i)}return!1},g=function(a,b){var c,d=a.substr(0,a.indexOf("(")),e=a.indexOf("(")+1,f=a.indexOf(")")-e,g=a.substr(e,f);switch(g=g.replace(/\'/g,"").split(", "),d){case"startswith":return c=g[1].toLowerCase(),0===b.indexOf(c);case"endswith":return c=g[1].toLowerCase(),b.indexOf(c)===b.length-1-c.length;case"substringof":return c=g[0].toLowerCase(),b.indexOf(c)>=0}return!1},h=function(a,b){var c=a.split(" "),e=c[1],f=c.slice(2).join(" ");switch(f=d(f),b instanceof Date&&!isNaN(Date.parse(f))?(f=Date.parse(f),b=b.getTime()):"string"!=typeof b||isNaN(Date.parse(b))||(b=Date.parse(b),f=Date.parse(f)),e){case"lt":return f>b;case"gt":return b>f;case"le":return f>=b;case"ge":return b>=f;case"ne":return b!=f;case"eq":return b==f}return!1},i=function(b){var c,e,f=b.indexOf("("),g=b.substring(0,f),h=b.substring(f+1,b.indexOf(")")).split(", ");switch(g){case"startswith":e=d(h[1]),c=new a(h[0]).startsWith(e);break;case"endswith":e=d(h[1]),c=new a(h[0]).endsWith(e);break;case"substringof":e=d(h[0]),c=new a(h[1]).contains(e)}return c},j=function(b){var c=b.split(" "),e=c[1],f=d(c.slice(2).join(" ")),g=new a(c[0]);switch(e){case"eq":g.equals(f);break;case"ne":g.notEqualTo(f);break;case"gt":g.greaterThan(f);break;case"ge":g.greaterThanOrEqualTo(f);break;case"lt":g.lessThan(f);break;case"le":g.lessThanOrEqualTo(f)}return g},k=function(a){return a.indexOf("(")>=0?i(a):j(a)};return a}]),angular.module("recall").factory("recallPreparedQueryOptions",["recallPredicate",function(a){function b(){this.options={}}var c=function(a){return a&&"object"==typeof a&&"function"==typeof a.parsePredicate};return b.prototype.$top=function(a){return 0===arguments.length?this.options.$top||null:("number"==typeof a&&a>=0&&(this.options.$top=a),null===a&&delete this.options.$top,this)},b.prototype.$skip=function(a){return 0===arguments.length?this.options.$skip||null:("number"==typeof a&&a>=0&&(this.options.$skip=a),null===a&&delete this.options.$skip,this)},b.prototype.$orderBy=function(a){return 0===arguments.length?this.options.$orderby||null:(a&&"string"==typeof a&&(this.options.$orderby=a),null===a&&delete this.options.$orderby,this)},b.prototype.$expand=function(a){return 0===arguments.length?this.options.$expand||null:("string"==typeof a?this.options.$expand=a:a instanceof Array&&(this.options.$expand=a.join(",")),null===a&&delete this.options.$expand,this)},b.prototype.$select=function(a){return 0===arguments.length?this.options.$select||null:("string"==typeof a?this.options.$select=a:a instanceof Array&&(this.options.$select=a.join(",")),null===a&&delete this.options.$select,this)},b.prototype.$inlineCount=function(a){return 0===arguments.length?this.options.$inlinecount||null:(a!==!1&&null!==a?this.options.$inlinecount="allpages":delete this.options.$inlinecount,this)},b.prototype.$filter=function(b){return 0===arguments.length?this.options.$filter||null:(b&&"string"==typeof b?this.options.$filter=a.fromString(b):c(b)&&(this.options.$filter=b),null===b&&delete this.options.$filter,this)},b.prototype.custom=function(a,b){return 1===arguments.length?this.options[a]||null:(a&&"string"==typeof a&&0!==a.indexOf("$")&&b&&("string"==typeof b||"number"==typeof b||"boolean"==typeof b)&&(this.options[a]=b),a&&null===b&&delete this.options[a],this)},b.prototype.extend=function(a){var b;for(b in a.options)a.options.hasOwnProperty(b)&&(this.options[b]=a.options[b]);return this},b.prototype.parseOptions=function(){var a,b="",d=function(){
    b+=""===b?"?":"&"};for(a in this.options)this.options.hasOwnProperty(a)&&(d(),b+=c(this.options[a])?a+"="+this.options[a].parsePredicate():a+"="+this.options[a]);return b},b.fromObject=function(a){var c,d=new b;for(c in a)a.hasOwnProperty(c)&&"function"==typeof d[c]&&d[c](a[c]);return d},b}]),angular.module("recall").provider("recall",[function(){var a={};a.localAdapter=null,this.setLocalAdapter=function(b){return a.localAdapter=b,this},a.remoteAdapter=null,this.setRemoteAdapter=function(b){return a.remoteAdapter=b,this},a.dirtyCheckThreshold=30,this.setDirtCheckThreshold=function(b){return a.dirtyCheckThreshold=b,this},a.lastModifiedFieldName=null,this.setLastModifiedFieldName=function(b){return a.lastModifiedFieldName=b,this},a.deletedFieldName=null,this.setDeletedFieldName=function(b){return a.deletedFieldName=b,this},this.$get=["recallBaseModelService",function(b){var c={config:a};return b.setDirtyCheckThreshold(a.dirtyCheckThreshold),b.setLastModifiedFieldName(a.lastModifiedFieldName),b.setDeletedFieldName(a.deletedFieldName),a.localAdapter&&b.setLocalAdapter(a.localAdapter),a.remoteAdapter&&b.setRemoteAdapter(a.remoteAdapter),c.getModels=b.getModels,c.getModel=b.getModel,c.defineModel=b.defineModel,c}]}]),angular.module("recall").factory("recallSyncHandler",["$log","$q","recallLocalStorage","recallPredicate","recallPreparedQueryOptions",function(a,b,c,d,e){var f={},g=function(a,b,c,d){this.sent=a,this.returned=b,this.totalProcessed=c,this.status=d};return f.getLastSyncTime=function(a){return c.get(c.keys.LAST_SYNC,a.modelName)},f.updateLastSyncTimeToNow=function(a){c.set(c.keys.LAST_SYNC,(new Date).toISOString(),a.modelName)},f.validateModel=function(a){return a.localAdapter&&a.remoteAdapter?"function"!=typeof a.remoteAdapter.synchronize?new g([],[],0,"Synchronize handler not found on remote adapter"):"function"!=typeof a.localAdapter.synchronize?new g([],[],0,"Synchronize handler not found on local adapter"):!0:new g([],[],0,"Remote or Local Adapter not Set")},f.sendSyncRequestData=function(a,b){var c=this.getLastSyncTime(a);return a.remoteAdapter.synchronize(a,b,c)},f.processSyncResponseData=function(a,b){var c=this.getLastSyncTime(a);return a.localAdapter.synchronize(a,b,c)},f.processSyncRequest=function(c,d){var e,h=b.defer(),i=f.validateModel(c);if(i!==!0)return i.sent=d,a.error("Sync Handler: "+c.modelName,i),b.reject(i);var j=[],k=d.length,l=function(b){e=new g(d,j,k,b),a.error("Sync Handler: "+c.modelName,e),h.reject(e)},m=function(){e=new g(d,j,k,"Complete"),a.debug("Sync Handler: "+c.modelName,"Sync Complete",e),f.updateLastSyncTimeToNow(c),h.resolve(e)};return a.debug("Sync Handler: Sending "+d.length+" local item(s) to sync"),f.sendSyncRequestData(c,d).then(function(b){a.debug("Sync Handler: Found "+b.data.length+" remote item(s) to sync"),k+=b.data.length,j=b.data,b.data.length>0?f.processSyncResponseData(c,b.data).then(m,l):m()},l),h.promise},f.model=function(c){var h,i=b.defer(),j=f.validateModel(c);if(j!==!0)return a.error("Sync Handler: "+c.modelName,j),b.reject(j);a.debug("Sync Handler: Starting Model Sync");var k=this.getLastSyncTime(c),l=new e;if(k){var m=new d("lastModified").greaterThanOrEqualTo(k);l.$filter(m)}return c.localAdapter.find(c,l,!0).then(function(a){return f.processSyncRequest(c,a.data)},function(b){h=new g([],[],0,b),a.error("Sync Handler: "+c.modelName,h),i.reject(h)}).then(function(a){i.resolve(a)},function(a){i.reject(a)}),i.promise},f.entity=function(b,c){return a.debug("Sync Handler: Starting Entity Sync"),f.processSyncRequest(b,[c])},f}]);
//# sourceMappingURL=recall.min.map