/*! recall 22-07-2015 */

angular.module("recall",[]),angular.module("recall").factory("recallAdapterResponse",[function(){var a=function(b,c,d,e,f){this.data=b,this.count=c>=0?c:null,this.status=d||a.OK,this.headers=e,this.config=f};return a.OK=200,a.CREATED=201,a.ACCEPTED=202,a.NO_CONTENT=204,a.BAD_REQUEST=400,a.UNAUTHORIZED=401,a.NOT_FOUND=404,a.CONFLICT=409,a.INTERNAL_SERVER_ERROR=500,a.NOT_IMPLEMENTED=501,a}]),angular.module("recall").factory("recallBaseClientSideAdapter",["$log","$q","$window","recall","recallAdapterResponse","recallPredicate",function(a,b,c,d,e,f){var g=function(a,b,c,d){this.name=a,this.service=b,this.connectionArguments=c,this.generatePrimaryKey=d,this.db=null,this.connectionPromise=null};return g.prototype.connect=function(){var c=b.defer(),d=this;if(d.db)c.resolve(d.db);else{if(d.connectionPromise)return d.connectionPromise;d.service.connect.apply(this,d.connectionArguments).then(function(b){a.debug(d.name+": Connection Success"),d.db=b,c.resolve(d.db)},function(b){a.error(d.name+": Connect",b),c.reject(b)})}return d.connectionPromise=c.promise,c.promise},g.prototype.create=function(c,d){var f,g=b.defer(),h=this,i=function(b){return f=new e(b,0,e.INTERNAL_SERVER_ERROR),a.error(h.name+": Create "+c.modelName,f,d),f};return d[c.primaryKeyFieldName]=h.generatePrimaryKey(),d=c.getRawModelObject(d,!1),d[c.lastModifiedFieldName]=(new Date).toISOString(),h.connect().then(function(b){h.service.create(b,c,d).then(function(b){f=new e(b,1,e.CREATED),a.debug(h.name+": Create "+c.modelName,f),g.resolve(f)},function(a){g.reject(i(a))})},function(a){g.reject(i(a))}),g.promise},g.prototype.findOne=function(c,d,f,g){var h,i=b.defer(),j=this,k=function(b,g){return h=new e(b,0,g||e.INTERNAL_SERVER_ERROR),a.error(j.name+": FindOne "+c.modelName,h,d,f),h};return j.connect().then(function(b){j.service.findOne(b,c,d).then(function(l){!l||!g&&l[c.deletedFieldName]?i.reject(k("Not Found",e.NOT_FOUND)):j.performExpand(l,c,f,b).then(function(){h=new e(l,1),a.debug(j.name+": FindOne "+c.modelName,h,d,f),i.resolve(h)},function(a){i.reject(k(a))})},function(a){i.reject(k(a))})},function(a){i.reject(k(a))}),i.promise},g.prototype.find=function(c,d,f){var h,i=b.defer(),j=this,k=function(b){return h=new e(b,0,e.INTERNAL_SERVER_ERROR),a.error(j.name+": Find "+c.modelName,h,d),h};return j.connect().then(function(l){var m;d&&d.$filter()&&(m=d.$filter()),j.service.find(l,c,f).then(function(f){var n,o=[];for(n=0;n<f.length;n++)g.resultMatchesFilters(f[n],m)&&o.push(j.performExpand(f[n],c,d,l));b.all(o).then(function(){f=g.applyFilter(f,m),f=g.applyOrderBy(c,f,d);var b=f.length;f=g.applyPaging(f,d),h=new e(f,b),a.debug(j.name+": Find "+c.modelName,h,d),i.resolve(h)},function(a){i.reject(k(a))})},function(a){i.reject(k(a))})},function(a){i.reject(k(a))}),i.promise},g.prototype.update=function(c,d,f){var g,h=b.defer(),i=this,j=function(b,d){return g=new e(b,0,d||e.INTERNAL_SERVER_ERROR),a.error(i.name+": Update "+c.modelName,g,f),g};return delete f[c.primaryKeyFieldName],f[c.lastModifiedFieldName]=(new Date).toISOString(),f=c.getRawModelObject(f,!1),i.connect().then(function(b){i.service.findOne(b,c,d).then(function(k){k&&!k[c.deletedFieldName]?(angular.extend(k,f),i.service.update(b,c,d,k).then(function(b){g=new e(b,1),a.debug(i.name+": Update "+c.modelName,g,f),h.resolve(g)},function(a){h.reject(j(a))})):h.reject(j("Not Found",e.NOT_FOUND))},function(a){h.reject(j(a))})},function(a){h.reject(j(a))}),h.promise},g.prototype.remove=function(c,d){var f,g=b.defer(),h=this,i=function(b,d){return f=new e(b,0,d||e.INTERNAL_SERVER_ERROR),a.error(h.name+": Remove "+c.modelName,f),f};return h.connect().then(function(b){h.service.findOne(b,c,d).then(function(j){j?(j[c.lastModifiedFieldName]=(new Date).toISOString(),j[c.deletedFieldName]=!0,h.service.update(b,c,d,j).then(function(){f=new e(null,1,e.NO_CONTENT),a.debug(h.name+": Remove "+c.modelName,f),g.resolve(f)},function(a){g.reject(i(a))})):g.reject(i("Not Found",e.NOT_FOUND))},function(a){g.reject(i(a))})},function(a){g.reject(i(a))}),g.promise},g.prototype.synchronize=function(c,d,f,g){var h,i=b.defer(),j=this,k=function(b){return h=new e(b,0,e.INTERNAL_SERVER_ERROR),a.error(j.name+": Synchronize "+c.modelName,h,d),h};return d=d||[],j.connect().then(function(l){var m,n=[];for(m=0;m<d.length;m++)n.push(j.syncInstance(l,c,d[m][c.primaryKeyFieldName],d[m],g));b.all(n).then(function(b){var d,g=[];for(d=0;d<b.length;d++)b[d]&&b[d][c.primaryKeyFieldName]&&g.push(b[d][c.primaryKeyFieldName]);j.getSyncList(l,c,f,g).then(function(d){h=new e(d,d.length,e.OK),a.debug(j.name+": Synchronize "+c.modelName,h,b),i.resolve(h)},function(a){i.reject(k(a))})},function(a){i.reject(k(a))})},function(a){i.reject(k(a))}),i.promise},g.prototype.syncInstance=function(a,c,d,e,h){var i=b.defer(),j=this;return j.service.findOne(a,c,d).then(function(b){var k=new f(c.lastModifiedFieldName).lessThan(e[c.lastModifiedFieldName]);b&&g.resultMatchesFilters(b,k)?e[c.deletedFieldName]?h===!0?j.service.remove(a,c,d).then(function(a){i.resolve(a)},function(a){i.reject(a)}):(b[c.lastModifiedFieldName]=(new Date).toISOString(),b[c.deletedFieldName]=!0,j.service.update(a,c,d,b).then(function(a){i.resolve(a)},function(a){i.reject(a)})):(delete e[c.primaryKeyFieldName],angular.extend(b,e),j.service.update(a,c,d,b).then(function(a){i.resolve(a)},function(a){i.reject(a)})):b||e[c.deletedFieldName]?i.resolve(null):(e[c.primaryKeyFieldName]=d,j.service.create(a,c,e).then(function(a){i.resolve(a)},function(a){i.reject(a)}))},function(a){i.reject(a)}),i.promise},g.prototype.getSyncList=function(a,c,d,e){var h=b.defer(),i=this;return e=e||[],i.service.find(a,c).then(function(a){var b,i=[];d&&(b=new f(c.lastModifiedFieldName).greaterThan(new Date(d)));var j;for(j=0;j<a.length;j++)b&&!g.resultMatchesFilters(a[j],b)||-1!==e.indexOf(a[j][c.primaryKeyFieldName])||i.push(a[j]);h.resolve(i)},function(a){h.reject(a)}),h.promise},g.prototype.expandHasOne=function(a,c,d,e,f){var g=b.defer(),h=this;return void 0===c[d.mappedBy]?(c[d.alias]=null,g.resolve(),g.promise):(h.service.findOne(e,a,c[d.mappedBy]).then(function(b){if(b&&!b[a.deletedFieldName])if(c[d.alias]=b,f.length>1){var i=f.join(".");h.expandPath(b,a,i.substring(i.indexOf(".")+1),e).then(function(){g.resolve()},function(a){g.reject(a)})}else g.resolve();else c[d.alias]=null,g.resolve()},function(a){g.reject(a)}),g.promise)},g.prototype.expandHasMany=function(a,c,d,e,f){var h=b.defer(),i=this;return i.service.findByAssociation(e,a,c[a.primaryKeyFieldName],d.mappedBy).then(function(j){var k=d.getOptions(c).$filter();if(k&&(j=g.applyFilter(j,k)),c[d.alias]=j,f.length>1){var l,m=[],n=f.join(".");for(l=0;l<j.length;l++)m.push(i.expandPath(j[l],a,n.substring(n.indexOf(".")+1),e));b.all(m).then(function(){h.resolve()},function(a){h.reject(a)})}else h.resolve()},function(a){h.reject(a)}),h.promise},g.prototype.expandPath=function(a,c,d,e){var f=d.split("."),g=f[0],h=this;if(g){var i=c.getAssociationByAlias(g);if(i){var j=i.getModel();if("hasOne"===i.type)return h.expandHasOne(j,a,i,e,f);if("hasMany"===i.type)return h.expandHasMany(j,a,i,e,f)}}var k=b.defer();return k.resolve(),k.promise},g.prototype.performExpand=function(c,d,e,f){var g,h=b.defer(),i=[];if(e&&(g=e.$expand()),g){var j,k=g.split(",");for(j=0;j<k.length;j++)i.push(this.expandPath(c,d,k[j],f));b.all(i).then(function(){h.resolve()},function(b){a.error("BrowserStorageAdapter: PerformExpand",b,g,c),h.reject(b)})}else h.resolve();return h.promise},g.resultMatchesFilters=function(a,b){return b?b.test(a):!0},g.applyFilter=function(a,b){return b&&a&&(a=a.filter(function(a){return g.resultMatchesFilters(a,b)})),a},g.applyOrderBy=function(a,b,c){if(!c)return b;var d=c.$orderBy();if(d){var e=d.split(" ")[0],f=d.split(" ")[1]||"",g=!1;a.fields[e]&&"DATE"===a.fields[e].type&&(g=!0),b.sort(function(a,b){var c=a[e],d=b[e];return g&&(c=new Date(c),d=new Date(d)),c>d?"desc"===f.toLowerCase()?-1:1:d>c?"desc"===f.toLowerCase()?1:-1:0})}return b},g.applyPaging=function(a,b){if(!b)return a;var c=b.$top(),d=b.$skip();return c>0&&d>=0&&(a=a.slice(d,d+c)),a},g}]),angular.module("recall.adapter.browserStorage",["recall"]).provider("recallBrowserStorageAdapter",[function(){var a={};a.preferredBackend="indexedDB",this.preferIndexedDB=function(){return a.preferredBackend="indexedDB",this},this.preferWebSQL=function(){return a.preferredBackend="webSQL",this},a.dbName="recall",this.setDbName=function(b){return a.dbName=b,this},a.dbVersion=1,this.setDbVersion=function(b){return a.dbVersion=b,this},a.dbSize=5242880,this.setDbSize=function(b){return a.dbSize=b,this},a.pkGenerator=function(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()},this.setPkGenerator=function(b){return a.pkGenerator=b,this},this.$get=["$log","$window","recallBaseClientSideAdapter","recallIndexedDBService","recallWebSQLService",function(b,c,d,e,f){var g=[a.dbName,a.dbVersion,a.dbSize],h=function(){var h;return"webSQL"===a.preferredBackend?void 0!==c.openDatabase?h=f:void 0!==c.indexedDB&&(h=e):void 0!==c.indexedDB?h=e:void 0!==c.openDatabase&&(h=f),h?new d("BrowserStorageAdapter",h,g,a.pkGenerator):(b.error("BrowserStorageAdapter: IndexedDB and WebSQL are not available"),null)};return h()}]}]),angular.module("recall.adapter.browserStorage").factory("recallIndexedDBService",["$q","$window","recall",function(a,b,c){var d={};return d.migrate=function(a){var b,d,e,f,g,h=c.getModels();for(b=0;b<h.length;b++)if(d=h[b],!a.objectStoreNames.contains(d.dataSourceName)){g=a.createObjectStore(d.dataSourceName,{keyPath:d.primaryKeyFieldName});for(e in d.fields)d.fields.hasOwnProperty(e)&&(d.fields[e].unique===!0||d.fields[e].index!==!1)&&(f=d.fields[e].index,g.createIndex(e,f,{unique:d.fields[e].unique}))}},d.handleVersionChange=function(a){a.onversionchange=function(){a.close(),b.alert("A new version of this page is ready. Please reload!")}},d.connect=function(c,e){var f=a.defer(),g=b.indexedDB.open(c,e);return g.onupgradeneeded=function(a){d.handleVersionChange(a.target.result),d.migrate(a.target.result),f.resolve(a.target.result)},g.onsuccess=function(a){d.handleVersionChange(a.target.result),f.resolve(a.target.result)},g.onerror=function(a){f.reject(a.target.errorCode)},f.promise},d.create=function(b,c,d){var e=a.defer(),f=b.transaction([c.dataSourceName],"readwrite"),g=f.objectStore(c.dataSourceName),h=g.add(d);return h.onsuccess=function(){e.resolve(d)},h.onerror=function(){e.reject(this.error)},e.promise},d.findOne=function(b,c,d){var e=a.defer(),f=b.transaction([c.dataSourceName]),g=f.objectStore(c.dataSourceName),h=g.get(d);return h.onsuccess=function(){h.result?e.resolve(h.result):e.resolve(null)},h.onerror=function(){e.reject(this.error)},e.promise},d.find=function(b,c,d){var e=a.defer(),f=b.transaction([c.dataSourceName]),g=f.objectStore(c.dataSourceName),h=g.openCursor(),i=[];return h.onsuccess=function(a){var b=a.target.result;b?((d||!b.value[c.deletedFieldName])&&i.push(b.value),b["continue"]()):e.resolve(i)},h.onerror=function(){e.reject(this.error)},e.promise},d.update=function(b,c,d,e){var f=a.defer(),g=b.transaction([c.dataSourceName],"readwrite"),h=g.objectStore(c.dataSourceName);e[c.primaryKeyFieldName]=d;var i=h.put(e);return i.onsuccess=function(){f.resolve(e)},i.onerror=function(){f.reject(this.error)},f.promise},d.remove=function(b,c,d){var e=a.defer(),f=b.transaction([c.dataSourceName],"readwrite"),g=f.objectStore(c.dataSourceName),h=g["delete"](d);return h.onsuccess=function(){e.resolve(null)},h.onerror=function(){e.reject(this.error)},e.promise},d.findByAssociation=function(b,c,d,e){var f=a.defer(),g=b.transaction([c.dataSourceName]),h=g.objectStore(c.dataSourceName),i=h.index(e),j=i.openCursor(),k=[];return j.onsuccess=function(a){var b=a.target.result;b?(b.value[c.deletedFieldName]||b.key!==d||k.push(b.value),b["continue"]()):f.resolve(k)},j.onerror=function(){f.reject(this.error)},f.promise},d}]),angular.module("recall.adapter.browserStorage").factory("recallWebSQLService",["$log","$q","$window","recall",function(a,b,c,d){var e={};e.migrate=function(a){var c=b.defer();return e.createTables(a).then(function(){e.migrateTables(a).then(function(){c.resolve(null)},function(a){c.reject(a)})},function(a){c.reject(a)}),c.promise},e.connect=function(a,d,f){var g=b.defer();try{var h=c.openDatabase(a,d.toString(),"Recall WebSQL Database",f);e.migrate(h).then(function(){g.resolve(h)},function(a){g.reject(a)})}catch(i){g.reject(i)}return g.promise},e.create=function(c,d,f){var g=b.defer();return c.transaction(function(b){var c,h=[],i=[],j=[];for(c in d.fields)d.fields.hasOwnProperty(c)&&f.hasOwnProperty(c)&&(h.push("`"+c+"`"),i.push(e.convertValueToSQL(d.fields[c],f)),j.push("?"));var k="INSERT INTO `"+d.dataSourceName+"` ("+h.join(",")+") VALUES ("+j.join(",")+")";a.debug("WebSQLService: "+k,i),b.executeSql(k,i,function(){g.resolve(f)},function(a,b){g.reject(b)})}),g.promise},e.findOne=function(c,d,f){var g=b.defer();return c.transaction(function(b){var c="SELECT * FROM `"+d.dataSourceName+"` WHERE `"+d.primaryKeyFieldName+"`=?";a.debug("WebSQLService: "+c,[f]),b.executeSql(c,[f],function(a,b){var c=e.transformSQLResult(d,b);c[0]?g.resolve(c[0]):g.resolve(null)},function(a,b){g.reject(b)})}),g.promise},e.find=function(c,d,f){var g=b.defer();return c.transaction(function(b){var c="SELECT * FROM `"+d.dataSourceName+"`";!f&&d.deletedFieldName&&(c+=" WHERE `"+d.deletedFieldName+"`=0"),a.debug("WebSQLService: "+c),b.executeSql(c,[],function(a,b){var c=e.transformSQLResult(d,b);g.resolve(c)},function(a,b){g.reject(b)})}),g.promise},e.update=function(c,d,f,g){var h=b.defer();return c.transaction(function(b){var c,i=[],j=[],k=[],l=[];for(c in d.fields)d.fields.hasOwnProperty(c)&&g.hasOwnProperty(c)&&c!==d.primaryKeyFieldName&&(i.push("`"+c+"`=?"),k.push(e.convertValueToSQL(d.fields[c],g)),j.push("`"+c+"`"),l.push("?"));k.push(f);var m="UPDATE `"+d.dataSourceName+"` SET "+i.join(",")+" WHERE `"+d.primaryKeyFieldName+"`=?";a.debug("WebSQLService: "+m,k),b.executeSql(m,k,function(){h.resolve(g)},function(a,b){h.reject(b)})}),h.promise},e.remove=function(c,d,e){var f=b.defer();return c.transaction(function(b){var c="DELETE FROM `"+d.dataSourceName+"` WHERE `"+d.primaryKeyFieldName+"`=?";a.debug("WebSQLService: "+c,[e]),b.executeSql(c,[e],function(){f.resolve(null)},function(a,b){f.reject(b)})}),f.promise},e.findByAssociation=function(c,d,f,g){var h=b.defer(),i="SELECT * FROM `"+d.dataSourceName+"` WHERE `"+g+"`=?";return d.deletedFieldName&&(i+=" AND `"+d.deletedFieldName+"`=0"),a.debug("WebSQLService: "+i,[f]),c.transaction(function(a){a.executeSql(i,[f],function(a,b){var c=e.transformSQLResult(d,b);h.resolve(c)},function(a,b){h.reject(b)})}),h.promise};var f=function(c,d,e){var f=b.defer(),g="CREATE TABLE IF NOT EXISTS `"+c.dataSourceName+"` ("+d.join(", ")+")";return a.debug("WebSQLService: "+g),e.executeSql(g,[],function(){f.resolve()},function(a,b){f.reject(b)}),f.promise},g=function(a){var b="`"+a.name+"`";switch(a.type){case"STRING":b+=" TEXT";break;case"NUMBER":b+=" REAL";break;case"DATE":b+=" TEXT";break;case"BOOLEAN":b+=" INTEGER";break;default:return!1}return a.primaryKey&&(b+=" PRIMARY KEY"),a.unique&&(b+=" UNIQUE"),a.notNull&&(b+=" NOT NULL"),b};e.createTables=function(a){var c,e,h,i,j,k=b.defer(),l=[],m=[],n=d.getModels();for(c=0;c<n.length;c++){e=n[c],j=[];for(h in e.fields)if(e.fields.hasOwnProperty(h)){if(i=g(e.fields[h]),!i)return b.reject("WebSQLService: Migrate - An unknown field type was found.");j.push(i)}m.push({model:e,fields:j})}return a.transaction(function(a){for(c=0;c<m.length;c++)l.push(f(m[c].model,m[c].fields,a));b.all(l).then(function(){k.resolve()},function(a){k.reject(a)})}),k.promise},e.addColumnToTable=function(c,d,e){var f=b.defer(),h=g(c);if(!h)return b.reject("WebSQLService: Migrate - An unknown field type was found.");var i="ALTER TABLE `"+d+"` ADD "+h;return a.debug("WebSQLService: "+i),e.executeSql(i,[],function(){f.resolve()},function(a,b){f.reject(b)}),f.promise},e.migrateTable=function(a,c,d){var f,g,h=[],i=null;for(f=0;f<c.length;f++)if(g=c[f],g.tbl_name===a.dataSourceName){i=g.sql;break}if(i){var j,k=[];for(j in a.fields)a.fields.hasOwnProperty(j)&&-1===i.indexOf("`"+j+"`")&&k.push(a.fields[j]);for(f=0;f<k.length;f++)h.push(e.addColumnToTable(k[f],a.dataSourceName,d))}return b.all(h)},e.migrateTables=function(c){var f=b.defer();return c.transaction(function(c){var g="SELECT tbl_name, sql from sqlite_master WHERE type = 'table'";a.debug("WebSQLService: "+g),c.executeSql(g,[],function(a,c){var g,h,i=d.getModels(),j=[],k=[];for(h=0;h<c.rows.length;h++)k.push(c.rows.item(h));for(h=0;h<i.length;h++)g=i[h],j.push(e.migrateTable(g,k,a));b.all(j).then(function(){f.resolve()},function(a){f.reject(a)})},function(a,b){f.reject(b)})}),f.promise},e.convertValueToSQL=function(a,b){switch(a.type){case"STRING":case"NUMBER":return b[a.name];case"DATE":return b[a.name]instanceof Date?b[a.name].toISOString():new Date(b[a.name]).toISOString();case"BOOLEAN":return b[a.name]===!0||1===b[a.name]?1:0}};var h=function(a,b){return"BOOLEAN"===a.type?1===b[a.name]:b[a.name]},i=function(a,b){var c,d={};for(c in a.fields)a.fields.hasOwnProperty(c)&&b.hasOwnProperty(c)&&(d[c]=h(a.fields[c],b));return d};return e.transformSQLResult=function(a,b){var c,d=[];for(c=0;c<b.rows.length;c++)d.push(i(a,b.rows.item(c)));return d},e}]),angular.module("recall.adapter.dropboxDatastore",["recall"]).provider("recallDropboxDatastoreAdapter",[function(){var a={};a.clientKey=null,this.setClientKey=function(b){return a.clientKey=b,this},a.authDriver=null,this.setAuthDriver=function(b){return a.authDriver=b,this},a.pkGenerator=function(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()},this.setPkGenerator=function(b){return a.pkGenerator=b,this},this.$get=["$log","recallBaseClientSideAdapter","recallDropboxDatastoreService",function(b,c,d){if(void 0===Dropbox)return void b.error("DropboxDatastoreAdapter: Dropbox is required");var e=[a.clientKey,a.authDriver];return new c("DropboxDatastoreAdapter",d,e,a.pkGenerator)}]}]),angular.module("recall.adapter.dropboxDatastore").factory("recallDropboxDatastoreService",["$q",function(a){var b={};b.connect=function(b,c){var d=a.defer();if(!b)return a.reject("Client key not set");var e=new Dropbox.Client({key:b});return c&&e.authDriver(c),e.authenticate({interactive:!1},function(a){if(a)d.reject(a);else if(e.isAuthenticated()){var b=e.getDatastoreManager();b.openDefaultDatastore(function(a,b){a?d.reject(a):d.resolve(b)})}else d.reject("Could not authenticate")}),d.promise},b.create=function(b,d,e){var f=a.defer();try{var g=b.getTable(d.dataSourceName),h=e[d.primaryKeyFieldName];delete e[d.primaryKeyFieldName];var i=g.getOrInsert(h,e);i=c(d,i),f.resolve(i)}catch(j){f.reject(j)}return f.promise},b.findOne=function(b,d,e){var f=a.defer();try{var g=b.getTable(d.dataSourceName),h=g.get(e);h?(h=c(d,h),f.resolve(h)):f.resolve(null)}catch(i){f.reject(i)}return f.promise},b.find=function(b,d,e){var f=a.defer();try{var g=b.getTable(d.dataSourceName),h=[];if(!e&&d.deletedFieldName){var i={};i[d.deletedFieldName]=!1,h=g.query(i)}else h=g.query();var j;for(j=0;j<h.length;j++)h[j]=c(d,h[j]);f.resolve(h)}catch(k){f.reject(k)}return f.promise},b.update=function(b,c,e,f){var g=a.defer();try{var h=b.getTable(c.dataSourceName),i=h.get(e);delete f[c.primaryKeyFieldName],i?(i=d(c,f,i),g.resolve(i)):g.reject(null)}catch(j){g.reject(j)}return g.promise},b.remove=function(b,c,d){var e=a.defer();try{var f=b.getTable(c.dataSourceName),g=f.get(d);g&&g.deleteRecord(),e.resolve(null)}catch(h){e.reject(h)}return e.promise},b.findByAssociation=function(b,d,e,f){var g=a.defer();try{var h=b.getTable(d.dataSourceName),i={};i[d.deletedFieldName]=!1;var j,k=h.query(i),l=[];for(j=0;j<k.length;j++)k[j].get(f)===e&&l.push(c(d,k[j]));g.resolve(l)}catch(m){g.reject(m)}return g.promise};var c=function(a,b){var c,d={};for(c in a.fields)a.fields.hasOwnProperty(c)&&(d[c]=b.get(c));return d[a.primaryKeyFieldName]=b.getId(),d},d=function(a,b,d){var e;for(e in a.fields)a.fields.hasOwnProperty(e)&&d.set(e,b[e]);return c(a,d)};return b}]),angular.module("recall.adapter.oDataREST",["recall"]).provider("recallODataRESTAdapter",[function(){var a={};a.serverAPILocation="/api/",this.setServerAPILocation=function(b){return"/"!==b.substring(b.length-1)&&(b+="/"),a.serverAPILocation=b,this},a.resultsField="results",this.setResultsField=function(b){return a.resultsField=b,this},a.totalCountFiled="totalCount",this.setTotalCountFiled=function(b){return a.totalCountFiled=b,this},this.$get=["$http","$log","$q","recallAdapterResponse",function(b,c,d,e){var f={},g=function(a,b){return a+=b?b.parseOptions():""};return f.create=function(f,g){var h,i=d.defer(),j=a.serverAPILocation+f.dataSourceName;return b.post(j,g).success(function(a,b,d,g){h=new e(a,1,b,d,g),c.debug("ODataRESTAdapter: Create "+f.modelName,h),i.resolve(h)}).error(function(a,b,d,j){h=new e(a,0,b,d,j),c.error("ODataRESTAdapter: Create "+f.modelName,h,g),i.reject(h)}),i.promise},f.findOne=function(f,h,i){var j,k=d.defer();if(!h)return j=new e("No Primary Key was supplied",0,e.BAD_REQUEST),c.error("ODataRESTAdapter: FindOne "+f.modelName,j,h,i),d.reject(j);var l=g(a.serverAPILocation+f.dataSourceName+"/"+h,i);return b.get(l).success(function(a,b,d,g){j=new e(a,1,b,d,g),c.debug("ODataRESTAdapter: FindOne "+f.modelName,j,h,i),k.resolve(j)}).error(function(a,b,d,g){j=new e(a,0,b,d,g),c.error("ODataRESTAdapter: FindOne "+f.modelName,j,h,i),k.reject(j)}),k.promise},f.find=function(f,h){var i,j=d.defer(),k=g(a.serverAPILocation+f.dataSourceName,h);return b.get(k).success(function(b,d,g,k){var l,m=b;a.resultsField&&(m=b[a.resultsField],a.totalCountFiled&&b[a.totalCountFiled]&&(l=b[a.totalCountFiled])),i=new e(m,l,d,g,k),c.debug("ODataRESTAdapter: Find "+f.modelName,i,h),j.resolve(i)}).error(function(a,b,d,g){i=new e(a,0,b,d,g),c.error("ODataRESTAdapter: Find "+f.modelName,i,h),j.reject(i)}),j.promise},f.update=function(f,g,h){var i,j=d.defer();if(!g)return i=new e("No Primary Key was supplied",0,e.BAD_REQUEST),c.error("ODataRESTAdapter: Update "+f.modelName,i,h),d.reject(i);var k=a.serverAPILocation+f.dataSourceName+"/"+g;return b.put(k,h).success(function(a,b,d,g){i=new e(a,1,b,d,g),c.debug("ODataRESTAdapter: Update "+f.modelName,i,h),j.resolve(i)}).error(function(a,b,d,g){i=new e(a,0,b,d,g),c.error("ODataRESTAdapter: Update "+f.modelName,i,h),j.reject(i)}),j.promise},f.remove=function(f,g){var h,i=d.defer();if(!g)return h=new e("No Primary Key was supplied",0,e.BAD_REQUEST),c.error("ODataRESTAdapter: Remove "+f.modelName,h,g),d.reject(h);var j=a.serverAPILocation+f.dataSourceName+"/"+g;return b({method:"DELETE",url:j}).success(function(a,b,d,j){h=new e(a,1,b,d,j),c.debug("ODataRESTAdapter: Remove "+f.modelName,h,g),i.resolve(h)}).error(function(a,b,d,j){h=new e(a,0,b,d,j),c.error("ODataRESTAdapter: Remove "+f.modelName,h,g),i.reject(h)}),i.promise},f.synchronize=function(f,g,h){var i,j=d.defer(),k=a.serverAPILocation+f.dataSourceName;return b.put(k,{data:g,lastSync:h}).success(function(b,d,h,k){var l,m=b;a.resultsField&&(m=b[a.resultsField],a.totalCountFiled&&b[a.totalCountFiled]&&(l=b[a.totalCountFiled])),i=new e(m,l,d,h,k),c.debug("ODataRESTAdapter: Synchronize "+f.modelName,i,g),j.resolve(i)}).error(function(a,b,d,h){i=new e(a,0,b,d,h),c.error("ODataRESTAdapter: Synchronize "+f.modelName,i,g),j.reject(i)}),j.promise},f}]}]),angular.module("recall.adapter.sync",["recall"]).provider("recallSyncAdapter",[function(){var a={};a.masterAdapter="",this.setMaster=function(b){return a.masterAdapter=b,this},a.slaveAdapter="",this.setSlave=function(b){return a.slaveAdapter=b,this},this.$get=["$injector","$log","$q","recallAdapterResponse","recallLocalStorage","recallPredicate","recallPreparedQueryOptions",function(b,c,d,e,f,g,h){var i={};i.modelValidationHook=function(a){var b=k(),d=l();return b?d?"function"!=typeof b.synchronize?(c.error("SyncAdapter: Synchronize handler not found on the master adapter",this,a),!1):"function"!=typeof d.synchronize?(c.error("SyncAdapter: Synchronize handler not found on the slave adapter",this,a),!1):("function"!=typeof b.modelValidationHook||b.modelValidationHook(a))&&("function"!=typeof d.modelValidationHook||d.modelValidationHook(a))?!0:!1:(c.error("SyncAdapter: Slave Adapter not Set",this,a),!1):(c.error("SyncAdapter: Master Adapter not Set",this,a),!1)},i.create=function(a,b,c){return c&&c.preferMaster()===!0?k().create(a,b):l().create(a,b)},i.findOne=function(a,b,f){var g;return b?f&&f.preferMaster()===!0?k().findOne(a,b,f):l().findOne(a,b,f):(g=new e("No Primary Key was supplied",0,e.BAD_REQUEST),c.error("SyncAdapter: FindOne "+a.modelName,g,b,f),d.reject(g))},i.find=function(a,b){return b&&b.preferMaster()===!0?k().find(a,b):l().find(a,b)},i.update=function(a,b,f,g){var h;return b?g&&g.preferMaster()===!0?k().update(a,b,f):l().update(a,b,f):(h=new e("No Primary Key was supplied",0,e.BAD_REQUEST),c.error("SyncAdapter: Update "+a.modelName,h,f),d.reject(h))},i.remove=function(a,b,f){var g;return b?f&&f.preferMaster()===!0?k().remove(a,b):l().remove(a,b):(g=new e("No Primary Key was supplied",0,e.BAD_REQUEST),c.error("SyncAdapter: Remove "+a.modelName,g,b),d.reject(g))},i.synchronize=function(a,b){if(a instanceof Array){var c,e=[];for(c=0;c<a.length;c++)b===!0&&p(a[c]),e.push(s(a[c]));return d.all(e)}return b===!0&&p(a),s(a)};var j=function(a){return"string"==typeof a?b.get(a):a},k=function(){return j(a.masterAdapter)},l=function(){return j(a.slaveAdapter)},m=function(a,b,c,d){this.sent=a,this.returned=b,this.totalProcessed=c,this.status=d},n=function(a){return f.get(f.keys.LAST_SYNC,a.modelName)},o=function(a){f.set(f.keys.LAST_SYNC,(new Date).toISOString(),a.modelName)},p=function(a){f.remove(f.keys.LAST_SYNC,a.modelName)},q=function(a,b){var c=n(a);return k().synchronize(a,b,c)},r=function(a,b){var c=n(a);return l().synchronize(a,b,c)},s=function(a){var b,e=d.defer(),f=[],i=[],j=0,k=function(d){b=new m(f,i,j,d),c.error("SyncAdapter: "+a.modelName,b),e.reject(b)},p=function(){b=new m(f,i,j,"Complete"),c.debug("SyncAdapter: "+a.modelName,"Sync Complete",b),o(a),e.resolve(b)};c.debug("SyncAdapter: "+a.modelName+" Sync Started");var s=n(a),t=new h;if(s){var u=new g("lastModified").greaterThanOrEqualTo(s);t.$filter(u)}return l().find(a,t,!0).then(function(b){c.debug("SyncAdapter: Sending "+b.count+" local item(s) to sync"),j+=b.count,f=b.data,q(a,b.data).then(function(b){c.debug("SyncAdapter: Found "+b.data.length+" remote item(s) to sync"),j+=b.data.length,i=b.data,b.data.length>0?r(a,b.data).then(p,k):p()},k)},k),e.promise};return i}]}]),angular.module("recall").factory("recallAssociation",["$injector","$log","$q","recallPredicate","recallPreparedQueryOptions",function(a,b,c,d,e){var f=function(a){this.invalid=!1,a.type?this.type=a.type:"string"==typeof a.hasOne?this.type="hasOne":"string"==typeof a.hasMany&&(this.type="hasMany"),this.modelName=a.modelName||a.hasOne||a.hasMany,this.alias=a.as||a.alias||this.modelName,this.mappedBy=a.mappedBy||a.foreignKey,this.getOptions=a.getOptions||function(){return new e},this.modelName&&this.type&&this.mappedBy||(b.error("Association: The association definition is invalid",a),this.invalid=!0)};return f.prototype.getModel=function(){var b=a.get("recall");return b.getModel(this.modelName)},f.prototype.expand=function(a){var e=c.defer(),f=this,g=f.getModel();if(!g)return c.reject("Association: Expand could not find the association's Model");var h=f.getOptions(a);if("hasOne"===f.type)g.adapter.findOne(g,a[f.mappedBy],h).then(function(c){a[f.alias]=g.getRawModelObject(c.data),a.$entity.storedState[f.alias]=g.getRawModelObject(c.data),b.debug("Association: Expand",f.type,f.alias,a,c),e.resolve()},function(c){b.error("Association: Expand",f.type,f.alias,a,c),e.reject(c)});else if("hasMany"===f.type){var i=new d(f.mappedBy).equals(a.$getPrimaryKey()),j=h.$filter();j&&(i=d.join([i,j])),h.$filter(i),g.adapter.find(g,h).then(function(c){var d,h=[],i=[];for(d=0;d<c.data.length;d++)h.push(g.getRawModelObject(c.data[d])),i.push(g.getRawModelObject(c.data[d]));a[f.alias]=h,a.$entity.storedState[f.alias]=i,b.debug("Association: Expand",f.type,f.alias,a,c),e.resolve()},function(c){b.error("Association: Expand",f.type,f.alias,a,c),e.reject(c)})}else b.error("Association: Expand Association type not supported",f.type,f.alias,a),e.reject("Association type not supported");return e.promise},f}]),angular.module("recall").factory("recallEntity",["$log","$q",function(a,b){var c=function(a,b,c){b.extendFromRawObject(this,a||{}),Object.defineProperty(this,"$entity",{value:{lastDirtyCheck:(new Date).getTime(),lastDirtyState:!1,persisted:c===!0,saveInProgress:!1,storedState:null}}),Object.defineProperty(this,"$model",{value:b}),this.$convertAssociationsToEntities(),this.$storeState()};return c.prototype.$getPrimaryKey=function(){return this[this.$model.primaryKeyFieldName]},c.prototype.$convertAssociationsToEntities=function(){var a,b,c,d;for(a=0;a<this.$model.associations.length;a++)if(b=this.$model.associations[a].alias,c=this.$model.associations[a].getModel(),"hasOne"===this.$model.associations[a].type)void 0===this[b]||this[b].$entity||(this[b]=new c.Entity(this[b],this.$entity.persisted));else if("hasMany"===this.$model.associations[a].type&&void 0!==this[b]&&this[b]instanceof Array)for(d=0;d<this[b].length;d++)this[b][d].$entity||(this[b][d]=new c.Entity(this[b][d],this.$entity.persisted))},c.prototype.$expand=function(a){var c=this.$model.getAssociationByAlias(a);return c?c.expand(this):b.reject("Entity: $expand could not find the association.")},c.prototype.$isValid=function(){var b,c,d=!1;for(b in this.$model.fields)if(this.$model.fields.hasOwnProperty(b)){if(c=null===this[b]||void 0===this[b],this.$model.fields[b].notNull===!0&&c)return a.debug("Entity: $isValid returned false","NotNull field was null",b,this),!1;switch(this.$model.fields[b].type){case"STRING":d="string"==typeof this[b];break;case"NUMBER":d="number"==typeof this[b];break;case"BOOLEAN":d=this[b]===!0||this[b]===!1;break;case"DATE":d=this[b]instanceof Date||!isNaN(Date.parse(this[b]))}if(!d&&!c)return a.debug("Entity: $isValid returned false",b+" was not a "+this.$model.fields[b].type,this),!1;if("function"==typeof this.$model.fields[b].validate&&!this.$model.fields[b].validate(this[b]))return a.debug("Entity: $isValid returned false","Custom validator failed",b,this),!1}return!0},c.prototype.$save=function(c){var d=b.defer(),e=this;if(!e.$isValid())return a.warn("Entity: $save: aborted",e,e[e.$model.primaryKeyFieldName]),e.$reset(),b.reject("aborted");e.$entity.saveInProgress=!0;var f=e.$model.preSave(e),g=function(a,b){a.$entity.saveInProgress=!1,b!==!1?(a.$storeState(),a.$entity.persisted=!0):a.$reset()};if(e.$entity.persisted&&f[e.$model.primaryKeyFieldName]){f=e.$model.preUpdate(f);var h=f[e.$model.primaryKeyFieldName];e.$model.adapter.update(e.$model,h,f,c).then(function(b){var c=e.$model.transformResult(b.data);e.$model.extendFromRawObject(e,c),g(e,!0),a.debug("Entity: $save: update",e,f,b),d.resolve(e)},function(b){g(e,!1),a.error("Entity: $save: update",e,f,b),d.reject(b)})}else f=e.$model.preCreate(f),e.$model.adapter.create(e.$model,f,c).then(function(b){var c=e.$model.transformResult(b.data);e.$model.extendFromRawObject(e,c),g(e,!0),a.debug("Entity: $save: create",e,f,b),d.resolve(e)},function(b){g(e,!1),a.error("Entity: $save: create",e,f,b),d.reject(b)});return d.promise},c.prototype.$remove=function(c){return this[this.$model.primaryKeyFieldName]?this.$model.adapter.remove(this.$model,this[this.$model.primaryKeyFieldName],c):(a.error("Entity: $remove","The primary key was not found"),b.reject("The primary key was not found."))},c.prototype.$storeState=function(){this.$entity.storedState=this.$model.getRawModelObject(this,!1),this.$entity.lastDirtyCheck=(new Date).getTime(),this.$entity.lastDirtyState=!1},c.prototype.$isDirty=function(){if(this.$entity.saveInProgress)return!1;
if(!this.$entity.storedState)return!1;var b=(new Date).getTime(),c=b-this.$entity.lastDirtyCheck;if(this.$entity.lastDirtyCheck&&c<this.$model.dirtyCheckThreshold)return this.$entity.lastDirtyState;this.$entity.lastDirtyCheck=(new Date).getTime();var d,e,f;for(d in this.$model.fields)if(this.$model.fields.hasOwnProperty(d)&&(f=this.$entity.storedState[d],e=this[d],f!==e))return a.debug("Entity: $isDirty",this[this.$model.primaryKeyFieldName],!0,c),this.$entity.lastDirtyState=!0,!0;return a.debug("Entity: $isDirty",this[this.$model.primaryKeyFieldName],!1,c),this.$entity.lastDirtyState=!1,!1},c.prototype.$reset=function(){if(!this.$entity.storedState)return this.$storeState(),[];var b,c=[];for(b in this.$entity.storedState)this.$entity.storedState.hasOwnProperty(b)&&this[b]!==this.$entity.storedState[b]&&(c.push({name:b,before:this[b],after:this.$entity.storedState[b]}),this[b]=this.$entity.storedState[b]);return this.$entity.lastDirtyState=!1,this.$entity.lastDirtyCheck=(new Date).getTime(),a.debug("Entity: $reset",this[this.$model.primaryKeyFieldName],c),c},c}]),angular.module("recall").factory("recallLocalStorage",["$document","$window",function(a,b){var c={keys:{LAST_SYNC:"LAST_SYNC"}},d=function(a){return void 0!==c.keys[a]},e=function(a,b){return b&&(a+="_"+b),a};return c.registerKey=function(a){d(a)||(c.keys[a]=a)},c.set=function(f,g,h){if(d(f))if(f=e(f,h),c.supportsLocalStorage())b.localStorage.setItem(f,g);else{var i=432e3,j=encodeURIComponent(g);a.cookie=f+"="+j+"; max-age="+i+";"}},c.get=function(f,g){var h="";if(d(f))if(f=e(f,g),c.supportsLocalStorage())h=b.localStorage.getItem(f)||"";else{var i=new RegExp(f+"=([^;]+)","g"),j=i.exec(a.cookie);j&&(h=decodeURIComponent(j[1]))}return h},c.remove=function(f,g){d(f)&&(f=e(f,g),c.supportsLocalStorage()?b.localStorage.removeItem(f):a.cookie=f+"=; max-age=0;")},c.supportsLocalStorage=function(){try{return"localStorage"in b&&null!==b.localStorage}catch(a){return!1}},c}]),angular.module("recall").factory("recallModel",["$log","$q","recallAssociation","recallEntity","recallModelField",function(a,b,c,d,e){var f=function(a){return b.reject(a)},g=function(a){this.modelName=a.name,this.dataSourceName=a.dataSourceName||a.name,Object.defineProperty(this,"modelDefinition",{value:a,writable:!1});var b=this;Object.defineProperty(this,"Entity",{writable:!1,configurable:!1,value:function(a,c){return new d(a,b,c===!0)}}),this.fields={},this.associations=[],this.dirtyCheckThreshold=30,this.primaryKeyFieldName=null,this.lastModifiedFieldName=null,this.deletedFieldName=null,this.adapter=null};return g.prototype.setLastModifiedFieldName=function(a){this.lastModifiedFieldName=a},g.prototype.setDeletedFieldName=function(a){this.deletedFieldName=a},g.prototype.setAdapter=function(a){this.adapter=a},g.prototype.setDirtyCheckThreshold=function(a){this.dirtyCheckThreshold=a},g.prototype.initializeModelFields=function(){var b,c,d,f,g=this.modelDefinition.fields;for(b in g)if(g.hasOwnProperty(b)){if(c=new e(b,g[b]),c.primaryKey&&(this.primaryKeyFieldName=b),c.invalid)return!1;this.fields[b]=c,b===this.lastModifiedFieldName&&(d=c),b===this.deletedFieldName&&(f=b)}return d&&"DATE"!==d.type?(a.error("Model: The last modified field is not a Date field"),!1):(this.lastModifiedFieldName&&!d&&(this.fields[this.lastModifiedFieldName]=new e(this.lastModifiedFieldName,{type:"DATE",index:!0,getDefaultValue:function(){return(new Date).toISOString()}})),f&&"BOOLEAN"!==f.type?(a.error("Model: The deletedField field is not a Boolean field"),!1):(this.deletedFieldName&&!f&&(this.fields[this.deletedFieldName]=new e(this.deletedFieldName,{type:"BOOLEAN",index:!0,getDefaultValue:function(){return!1}})),!0))},g.prototype.initializeAssociations=function(){var a=this.modelDefinition.associations;if(a){var b,d;for(b=0;b<a.length;b++)d=new c(a[b]),d&&!d.invalid&&("hasOne"===d.type&&(this.fields[d.mappedBy]?this.fields[d.mappedBy].index=d.mappedBy:this.fields[d.mappedBy]=new e(d.mappedBy,{type:this.fields[this.primaryKeyFieldName].type,index:d.mappedBy})),this.associations.push(d))}},g.prototype.getAssociationByAlias=function(a){var b;for(b=0;b<this.associations.length;b++)if(this.associations[b].alias===a)return this.associations[b];return null},g.prototype.extendFromRawObject=function(a,b){angular.extend(a,this.getRawModelObject(b))},g.prototype.getRawModelObject=function(a,b){var c,d={};for(c in this.fields)this.fields.hasOwnProperty(c)&&(d[c]=a[c]);var e,f,g,h,i;for(e=0;e<this.associations.length;e++)if(f=this.associations[e].alias,h=this.associations[e].getModel(),"hasOne"===this.associations[e].type)void 0!==a[f]&&null!==a[f]&&(g=a[f][h.primaryKeyFieldName],d[this.associations[e].mappedBy]=g,b!==!1&&(d[f]=h.getRawModelObject(a[f])));else if("hasMany"===this.associations[e].type&&b!==!1&&void 0!==a[f]&&a[f]instanceof Array)for(d[f]=[],i=0;i<a[f].length;i++)d[f].push(h.getRawModelObject(a[f][i]));return d},g.prototype.applyDefaultValues=function(a){var b;for(b in this.fields)this.fields.hasOwnProperty(b)&&"function"==typeof this.fields[b].getDefaultValue&&void 0===a[b]&&(a[b]=this.fields[b].getDefaultValue(a))},g.prototype.transformResult=function(a){var b,c,d,e;for(b=0;b<this.associations.length;b++)if(c=this.associations[b].alias,d=this.associations[b].getModel(),"hasOne"===this.associations[b].type)void 0!==a[c]&&(a[c]=d.transformResult(a[c]));else if("hasMany"===this.associations[b].type&&void 0!==a[c]&&a[c]instanceof Array)for(e=0;e<a[c].length;e++)a[c][e]=d.transformResult(a[c][e]);return a=this.getRawModelObject(a),"function"==typeof this.modelDefinition.transformResult&&(a=this.modelDefinition.transformResult(a)),a},g.prototype.preSave=function(a){return a=this.getRawModelObject(a),"function"==typeof this.modelDefinition.preSave?this.modelDefinition.preSave(a):a},g.prototype.preCreate=function(a){return this.applyDefaultValues(a),"function"==typeof this.modelDefinition.preCreate?this.modelDefinition.preCreate(a):a},g.prototype.preUpdate=function(a){return"function"==typeof this.modelDefinition.preUpdate?this.modelDefinition.preUpdate(a):a},g.prototype.findOne=function(c,e){var g=this;return c?this.adapter.findOne(this,c,e).then(function(b){var c=g.transformResult(b.data),f=new d(c,g,!0);return a.debug("Model: FindOne",f,b,e),f},f):(a.error("Model: FindOne","The primary key was not supplied"),b.reject("The primary key was not supplied."))},g.prototype.find=function(b){var c=this;return this.adapter.find(this,b).then(function(e){var f,g=[];for(f=0;f<e.data.length;f++)g.push(new d(c.transformResult(e.data[f]),c,!0));var h={results:g,totalCount:e.count};return a.debug("Model: Find",h,e,b),h},f)},g.prototype.remove=function(c,d){return c?this.adapter.remove(this,c,d):(a.error("Model: Remove","The primary key was not supplied"),b.reject("The primary key was not supplied."))},g}]),angular.module("recall").factory("recallModelField",["$log",function(a){var b=function(b,e){this.invalid=!1,this.name=b,this.primaryKey=!1,this.unique=!1,this.index=!1,this.notNull=!1,"string"==typeof e?this.type=e.toUpperCase():e.primaryKey===!0?c(this,e):d(this,e),this.validateField()||a.error("ModelField: The field definition is invalid",this,e)};b.prototype.validateField=function(){return this.name&&this.type?null!==this.name.match(/[^\w+]/)?(this.invalid=!0,!1):(this.invalid=!1,!0):(this.invalid=!0,!1)};var c=function(b,c){b.primaryKey=!0,b.type=c.type?c.type.toUpperCase():null,b.notNull=!1,b.unique=!1,b.index=!1,"function"==typeof c.getDefaultValue&&a.warn("ModelField: getDefaultValue is ignored for the primary key"),"function"==typeof c.validate&&a.warn("ModelField: validate is ignored for the primary key")},d=function(a,b){a.type=b.type?b.type.toUpperCase():null,a.unique=b.unique===!0,a.index="string"==typeof b.index?b.index:b.index===!0?a.name:!1,a.notNull=b.notNull===!0,"function"==typeof b.getDefaultValue&&(a.getDefaultValue=b.getDefaultValue),"function"==typeof b.validate&&(a.validate=b.validate)};return b}]),Date.prototype.toISOString||!function(){function a(a){return 10>a?"0"+a:a}Date.prototype.toISOString=function(){return this.getUTCFullYear()+"-"+a(this.getUTCMonth()+1)+"-"+a(this.getUTCDate())+"T"+a(this.getUTCHours())+":"+a(this.getUTCMinutes())+":"+a(this.getUTCSeconds())+"."+(this.getUTCMilliseconds()/1e3).toFixed(3).slice(2,5)+"Z"}}(),angular.module("recall").factory("recallPredicate",[function(){function a(a,b){return this.property=a,this.parser=b,this}a.join=function(b,c){return b instanceof Array&&b.length>0?(new a).join(b,c):null},a.prototype.setProperty=function(a){return this.property=a,this},a.prototype.equals=function(a){return this.parser=function(){return this.property+" eq "+c(a)},this},a.prototype.notEqualTo=function(a){return this.parser=function(){return this.property+" ne "+c(a)},this},a.prototype.greaterThan=function(a){return this.parser=function(){return this.property+" gt "+c(a)},this},a.prototype.greaterThanOrEqualTo=function(a){return this.parser=function(){return this.property+" ge "+c(a)},this},a.prototype.lessThan=function(a){return this.parser=function(){return this.property+" lt "+c(a)},this},a.prototype.lessThanOrEqualTo=function(a){return this.parser=function(){return this.property+" le "+c(a)},this},a.prototype.contains=function(a){return this.parser=function(){return"substringof("+c(a)+", "+this.property+")"},this},a.prototype.startsWith=function(a){return this.parser=function(){return"startswith("+this.property+", "+c(a)+")"},this},a.prototype.endsWith=function(a){return this.parser=function(){return"endswith("+this.property+", "+c(a)+")"},this},a.prototype.join=function(b,c){var d;this.property&&"function"==typeof this.parser&&(d=new a(this.property,this.parser));var e=[];if(b instanceof a)e.push(b);else if(b instanceof Array&&b.length>0){var f;for(f=0;f<b.length;f++)b[f]&&e.push(b[f])}return e.length>0&&(delete this.parser,delete this.property,this.joinedPredicates=this.joinedPredicates?this.joinedPredicates.concat(e):e,(c||!this.groupOperator)&&(this.groupOperator="or"===c?"or":"and"),d&&this.joinedPredicates.unshift(d)),this},a.prototype.and=function(a){return this.join(a,"and")},a.prototype.or=function(a){return this.join(a,"or")},a.prototype.test=function(a,b){return f(this,a,b)},a.prototype.parsePredicate=function(a){a=a===!0;var b="";if(this.property&&"function"==typeof this.parser)return this.parser();if(this.joinedPredicates&&this.joinedPredicates.length>0){var c,d,e;for(c=0;c<this.joinedPredicates.length;c++)d=this.joinedPredicates[c],e=d.parsePredicate(!0),b+=c>0?" "+this.groupOperator+" "+e:e}return a?"("+b+")":b},a.fromString=function(a){if("string"!=typeof a)return null;var c=new RegExp("(substringof\\(.+?\\)|startswith\\(.+?\\)|endswith\\(.+?\\)|[\\w\\.]+?\\s(?:eq|ne|gt|ge|lt|le)\\s(?:\\w+|\\'.+?\\'))","g"),d=a.match(c);if(!d)return null;var e;for(e=0;e<d.length;e++)if(d[e]=k(d[e]),null===d[e])return null;return 0===d.length?null:(e=0,a=a.replace(c,function(){return e++}),1===d.length?""!==a.replace(/[0-9]|\s|and|or/g,"")?null:d[0]:b(a,d))};var b=function(b,c){for(var d,e,f,g,h,i,j=null,k=!0;k;){if(d=b.indexOf(")"),-1!==d?(e=b.lastIndexOf("(",d),f=b.substring(e+1,d),b=b.substring(0,e)+c.length+b.substring(d+1)):(f=b,k=!1),""!==f.replace(/[0-9]|\s|and|or/g,""))return null;if(f.indexOf("and")>=0&&f.indexOf("or")>=0)return null;g=f.match(/[0-9]+/g),h=[];var l;for(l=0;l<g.length;l++)h.push(c[Number(g[l])]);i=f.indexOf("or")>=0?"or":"and",j=(new a).join(h,i),c.push(j)}return j},c=function(a){return a instanceof Date&&(a=a.toISOString()),"string"==typeof a?"'"+a+"'":a.toString()},d=function(a){if("string"==typeof a){if(a.indexOf("'")>=0)return a.replace(/\'/g,"");if("true"===a.toLowerCase())return!0;if("false"===a.toLowerCase())return!1}return isNaN(a)?a:Number(a)},e=function(a,b){var c,d;for(d=0;d<a.joinedPredicates.length;d++){if(c=f(a.joinedPredicates[d],b),"and"===a.groupOperator&&c===!1)return!1;if("or"===a.groupOperator&&c===!0)return!0}return"and"===a.groupOperator},f=function(a,b,c){if(a.joinedPredicates&&a.joinedPredicates.length>0)return e(a,b);if(a.property){var d,f=a.property.split("."),i=b;for(d=0;d<f.length;d++){if(!i.hasOwnProperty(f[d])||void 0===i[f[d]])return c===!1;i=i[f[d]]}var j=a.parsePredicate();return j.indexOf("(")>=0?g(j,i):h(j,i)}return!1},g=function(a,b){var c,d=a.substr(0,a.indexOf("(")),e=a.indexOf("(")+1,f=a.indexOf(")")-e,g=a.substr(e,f);switch(g=g.replace(/\'/g,"").split(", "),d){case"startswith":return c=g[1].toLowerCase(),0===b.indexOf(c);case"endswith":return c=g[1].toLowerCase(),b.indexOf(c)===b.length-1-c.length;case"substringof":return c=g[0].toLowerCase(),b.indexOf(c)>=0}return!1},h=function(a,b){var c=a.split(" "),e=c[1],f=c.slice(2).join(" ");switch(f=d(f),b instanceof Date&&!isNaN(Date.parse(f))?(f=Date.parse(f),b=b.getTime()):"string"!=typeof b||isNaN(Date.parse(b))||(b=Date.parse(b),f=Date.parse(f)),e){case"lt":return f>b;case"gt":return b>f;case"le":return f>=b;case"ge":return b>=f;case"ne":return b!=f;case"eq":return b==f}return!1},i=function(b){var c,e,f=b.indexOf("("),g=b.substring(0,f),h=b.substring(f+1,b.indexOf(")")).split(", ");switch(g){case"startswith":e=d(h[1]),c=new a(h[0]).startsWith(e);break;case"endswith":e=d(h[1]),c=new a(h[0]).endsWith(e);break;case"substringof":e=d(h[0]),c=new a(h[1]).contains(e)}return c},j=function(b){var c=b.split(" "),e=c[1],f=d(c.slice(2).join(" ")),g=new a(c[0]);switch(e){case"eq":g.equals(f);break;case"ne":g.notEqualTo(f);break;case"gt":g.greaterThan(f);break;case"ge":g.greaterThanOrEqualTo(f);break;case"lt":g.lessThan(f);break;case"le":g.lessThanOrEqualTo(f)}return g},k=function(a){return a.indexOf("(")>=0?i(a):j(a)};return a}]),angular.module("recall").factory("recallPreparedQueryOptions",["recallPredicate",function(a){function b(){this.options={}}var c=function(a){return a&&"object"==typeof a&&"function"==typeof a.parsePredicate};return b.prototype.preferMaster=function(a){return 0===arguments.length?this.options.preferMaster||null:null===a?(delete this.options.preferMaster,this):(this.options.preferMaster=a===!0,this)},b.prototype.$top=function(a){return 0===arguments.length?this.options.$top||null:("number"==typeof a&&a>=0&&(this.options.$top=a),null===a&&delete this.options.$top,this)},b.prototype.$skip=function(a){return 0===arguments.length?this.options.$skip||null:("number"==typeof a&&a>=0&&(this.options.$skip=a),null===a&&delete this.options.$skip,this)},b.prototype.$orderBy=function(a){return 0===arguments.length?this.options.$orderby||null:(a&&"string"==typeof a&&(this.options.$orderby=a),null===a&&delete this.options.$orderby,this)},b.prototype.$expand=function(a){return 0===arguments.length?this.options.$expand||null:("string"==typeof a?this.options.$expand=a:a instanceof Array&&(this.options.$expand=a.join(",")),null===a&&delete this.options.$expand,this)},b.prototype.$select=function(a){return 0===arguments.length?this.options.$select||null:("string"==typeof a?this.options.$select=a:a instanceof Array&&(this.options.$select=a.join(",")),null===a&&delete this.options.$select,this)},b.prototype.$inlineCount=function(a){return 0===arguments.length?this.options.$inlinecount||null:(a!==!1&&null!==a?this.options.$inlinecount="allpages":delete this.options.$inlinecount,this)},b.prototype.$filter=function(b){return 0===arguments.length?this.options.$filter||null:(b&&"string"==typeof b?this.options.$filter=a.fromString(b):c(b)&&(this.options.$filter=b),null===b&&delete this.options.$filter,this)},b.prototype.custom=function(a,b){return 1===arguments.length?this.options[a]||null:(a&&"string"==typeof a&&0!==a.indexOf("$")&&b&&("string"==typeof b||"number"==typeof b||"boolean"==typeof b)&&(this.options[a]=b),a&&null===b&&delete this.options[a],this)},b.prototype.extend=function(a){var b;for(b in a.options)a.options.hasOwnProperty(b)&&(this.options[b]=a.options[b]);return this},b.prototype.parseOptions=function(){var a,b="",d=function(){b+=""===b?"?":"&"};for(a in this.options)this.options.hasOwnProperty(a)&&(d(),b+=c(this.options[a])?a+"="+this.options[a].parsePredicate():a+"="+this.options[a]);return b},b.fromObject=function(a){var c,d=new b;for(c in a)a.hasOwnProperty(c)&&"function"==typeof d[c]&&d[c](a[c]);return d},b}]),angular.module("recall").provider("recall",[function(){var a={};a.adapter=null,this.setAdapter=function(b){return a.adapter=b,this},a.dirtyCheckThreshold=30,this.setDirtyCheckThreshold=function(b){return a.dirtyCheckThreshold=b,this},a.lastModifiedFieldName=null,this.setLastModifiedFieldName=function(b){return a.lastModifiedFieldName=b,this},a.deletedFieldName=null,this.setDeletedFieldName=function(b){return a.deletedFieldName=b,this},this.$get=["$injector","recallModel",function(b,c){var d={adapter:a.adapter,lastModifiedFieldName:a.lastModifiedFieldName,deletedFieldName:a.deletedFieldName,dirtyCheckThreshold:a.dirtyCheckThreshold,models:{}};return d.getModels=function(){var a,b=[];for(a in this.models)this.models.hasOwnProperty(a)&&b.push(this.models[a]);return b},d.getModel=function(a){return this.models[a]||null},d.defineModel=function(a,d){if(d=d||this.adapter,d="string"==typeof d?b.get(d):d,!d)return null;if(!a||!a.name)return null;if(this.models[a.name])return this.models[a.name];var e=new c(a);e.setLastModifiedFieldName(this.lastModifiedFieldName),e.setDeletedFieldName(this.deletedFieldName),e.setAdapter(d),e.setDirtyCheckThreshold(this.dirtyCheckThreshold);var f=e.initializeModelFields();return f?(e.initializeAssociations(),"function"!=typeof d.modelValidationHook||d.modelValidationHook(e)?(this.models[e.modelName]=e,e):null):null},d}]}]);
//# sourceMappingURL=recall.min.map