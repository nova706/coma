/*! recall 22-04-2015 */

angular.module("recall",[]),angular.module("recall").factory("recallAdapterResponse",[function(){var a=function(b,c,d,e,f){this.data=b,this.count=c>=0?c:null,this.status=d||a.OK,this.headers=e,this.config=f};return a.OK=200,a.CREATED=201,a.ACCEPTED=202,a.NO_CONTENT=204,a.BAD_REQUEST=400,a.UNAUTHORIZED=401,a.NOT_FOUND=404,a.CONFLICT=409,a.INTERNAL_SERVER_ERROR=500,a.NOT_IMPLEMENTED=501,a}]),angular.module("recall.adapter.indexedDB",["recall"]).provider("recallIndexedDBAdapter",[function(){var a={};a.dbName="recall",this.setDbName=function(b){return a.dbName=b,this},a.dbVersion=1,this.setDbVersion=function(b){return a.dbVersion=b,this},a.pkGenerator=function(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()},this.setPkGenerator=function(b){return a.pkGenerator=b,this},this.dropDatabase=function(){try{window.indexedDB.deleteDatabase(a.dbName)}catch(b){return b}return!0},this.$get=["$log","$q","$window","recall","recallAdapterResponse",function(b,c,d,e,f){var g,h,i={},j=a.pkGenerator,k=function(a){var b,c,d,f,g,h=e.getModels();for(b=0;b<h.length;b++)if(c=h[b],!a.objectStoreNames.contains(c.dataSourceName)){g=a.createObjectStore(c.dataSourceName,{keyPath:c.primaryKeyFieldName});for(d in c.fields)c.fields.hasOwnProperty(d)&&(c.fields[d].unique===!0||c.fields[d].index!==!1)&&(f=c.fields[d].index===!0?d:c.fields[d].index,g.createIndex(d,f,{unique:c.fields[d].unique}))}},l=function(a){h=a,h.onversionchange=function(){h.close(),b.error("IndexedDBAdapter: DB version changed in a different window"),alert("A new version of this page is ready. Please reload!")}},m=function(){var e=c.defer();if(h)e.resolve(h);else{if(g)return g;var f=d.indexedDB.open(a.dbName,a.dbVersion);f.onupgradeneeded=function(a){b.info("IndexedDBAdapter: Migrating...",a),l(a.target.result),k(a.target.result)},f.onsuccess=function(a){b.debug("IndexedDBAdapter: Connection Success",a),l(a.target.result),e.resolve(h)},f.onerror=function(a){b.error("IndexedDBAdapter: Connection Error",a),e.reject(a.target.errorCode)}}return g=e.promise,e.promise};i.create=function(a,d){var e,g=c.defer(),i=function(c){return e=new f(c,0,f.INTERNAL_SERVER_ERROR),b.error("IndexedDBAdapter: Create "+a.modelName,e,d),e};return d[a.primaryKeyFieldName]=j(),d=a.getRawModelObject(d,!1),d[a.lastModifiedFieldName]=(new Date).toISOString(),m().then(function(){var c=h.transaction([a.dataSourceName],"readwrite"),j=c.objectStore(a.dataSourceName),k=j.add(d);k.onsuccess=function(){e=new f(d,1,f.CREATED),b.debug("IndexedDBAdapter: Create "+a.modelName,e),g.resolve(e)},k.onerror=function(){g.reject(i(this.error))}},function(a){g.reject(i(a))}),g.promise},i.findOne=function(a,d,e,g){var i,j=c.defer(),k=function(c,g){return i=new f(c,0,g||f.INTERNAL_SERVER_ERROR),b.error("IndexedDBAdapter: FindOne "+a.modelName,i,d,e),i};return m().then(function(){var c=h.transaction([a.dataSourceName]),l=c.objectStore(a.dataSourceName),m=l.get(d);m.onsuccess=function(){!m.result||!g&&m.result[a.deletedFieldName]?j.reject(k("Not Found",f.NOT_FOUND)):s(m.result,a,e,h).then(function(){i=new f(m.result,1),b.debug("IndexedDBAdapter: FindOne "+a.modelName,i,d,e),j.resolve(i)},function(a){j.reject(k(a))})},m.onerror=function(){j.reject(k(this.error))}},function(a){j.reject(k(a))}),j.promise},i.find=function(a,d,e){var g,i=c.defer(),j=function(c){return g=new f(c,0,f.INTERNAL_SERVER_ERROR),b.error("IndexedDBAdapter: Find "+a.modelName,g,d),g};return m().then(function(){var k,l=h.transaction([a.dataSourceName]),m=l.objectStore(a.dataSourceName),n=m.openCursor(),o=[];d&&d.$filter()&&(k=d.$filter()),n.onsuccess=function(l){var m=l.target.result;if(m)(e||!m.value[a.deletedFieldName])&&(k?t(m.value,k)&&o.push(m.value):o.push(m.value)),m["continue"]();else{var n,p=[];for(n=0;n<o.length;n++)p.push(s(o[n],a,d,h));c.all(p).then(function(){o=u(o,k),o=v(a,o,d);var c=o.length;o=w(o,d),g=new f(o,c),b.debug("IndexedDBAdapter: Find "+a.modelName,g,d),i.resolve(g)},function(a){i.reject(j(a))})}},n.onerror=function(){i.reject(j(this.error))}},function(a){i.reject(j(a))}),i.promise},i.update=function(a,d,e,g){var i,j=c.defer(),k=function(c){return i=new f(c,0,f.INTERNAL_SERVER_ERROR),b.error("IndexedDBAdapter: Update "+a.modelName,i,e),i};return m().then(function(){var c=h.transaction([a.dataSourceName],"readwrite"),l=c.objectStore(a.dataSourceName),m=l.get(d);m.onsuccess=function(){if(!m.result||!g&&m.result[a.deletedFieldName])j.reject(k("Not Found",f.NOT_FOUND));else{var c=m.result;delete e[a.primaryKeyFieldName],angular.extend(c,e),c[a.lastModifiedFieldName]=(new Date).toISOString(),c=a.getRawModelObject(c,!1);var d=l.put(c);d.onsuccess=function(){i=new f(c,1),b.debug("IndexedDBAdapter: Update "+a.modelName,i,e),j.resolve(i)},d.onerror=function(){j.reject(k(this.error))}}},m.onerror=function(){j.reject(k(this.error))}},function(a){j.reject(k(a))}),j.promise},i.remove=function(a,d){var e,g=c.defer(),i=function(c){return e=new f(c,0,f.INTERNAL_SERVER_ERROR),b.error("IndexedDBAdapter: Remove "+a.modelName,e),e};return m().then(function(){var c=h.transaction([a.dataSourceName],"readwrite"),j=c.objectStore(a.dataSourceName),k=j.get(d);k.onsuccess=function(){if(k.result&&!k.result[a.deletedFieldName]){var c=k.result;c[a.deletedFieldName]=!0,c[a.lastModifiedFieldName]=(new Date).toISOString();var d=j.put(c);d.onsuccess=function(){e=new f(null,1,f.NO_CONTENT),b.debug("IndexedDBAdapter: Remove "+a.modelName,e),g.resolve(e)},d.onerror=function(){g.reject(i(this.error))}}else g.reject(i("Not Found",f.NOT_FOUND))},k.onerror=function(){g.reject(i(this.error))}},function(a){g.reject(i(a))}),g.promise},i.synchronize=function(a,d){var e,g=c.defer(),i=function(c){return e=new f(c,0,f.INTERNAL_SERVER_ERROR),b.error("IndexedDBAdapter: Synchronize "+a.modelName,e,d),e};return m().then(function(){var j,k=h.transaction([a.dataSourceName],"readwrite"),l=k.objectStore(a.dataSourceName),m=[];for(j=0;j<d.length;j++)m.push(d[j][a.deletedFieldName]?o(a,l,d[j][a.primaryKeyFieldName]):n(a,l,d[j]));c.all(m).then(function(c){e=new f(c,c.length,f.OK),b.debug("IndexedDBAdapter: Synchronize "+a.modelName,e,d),g.resolve(e)},function(a){g.reject(i(a))})},function(a){g.reject(i(a))}),g.promise};var n=function(a,b,d){var e=c.defer(),f=b.get(d[a.primaryKeyFieldName]);return f.onsuccess=function(){var c=f.result;if(c){angular.extend(c,d),c=a.getRawModelObject(c,!1);var g=b.put(c);g.onsuccess=function(){e.resolve(c)},g.onerror=function(){e.reject(this.error)}}else{var h=b.add(d);h.onsuccess=function(){e.resolve(d)},h.onerror=function(){e.reject(this.error)}}},f.onerror=function(){e.reject(this.error)},e.promise},o=function(a,b,d){var e=c.defer(),f=b["delete"](d);return f.onsuccess=function(){e.resolve()},f.onerror=function(){e.reject(this.error)},e.promise},p=function(a,b,d,e,f){var g=c.defer();if(void 0===b[d.mappedBy])return b[d.mappedBy]=null,g.resolve(),g.promise;var h=e.transaction([a.dataSourceName]),i=h.objectStore(a.dataSourceName),j=f.join("."),k=i.get(b[d.mappedBy]);return k.onsuccess=function(){k.result&&!k.result[a.deletedFieldName]?(b[d.alias]=k.result,f.length>1?r(k.result,a,j.substring(j.indexOf(".")+1),e).then(function(){g.resolve()},function(a){g.reject(a)}):g.resolve()):(b[d.alias]=null,g.resolve())},k.onerror=function(){g.reject(this.error)},g.promise},q=function(a,b,d,e,f){var g=c.defer(),h=e.transaction([a.dataSourceName]),i=h.objectStore(a.dataSourceName),j=f.join("."),k=i.index(d.mappedBy),l=k.openCursor(),m=[];return l.onsuccess=function(h){var i=h.target.result;if(i)i.value[a.deletedFieldName]||i.key!==b[a.primaryKeyFieldName]||m.push(i.value),i["continue"]();else{var k=d.getOptions(b).$filter();if(k&&(m=u(m,k)),b[d.alias]=m,f.length>1){var l,n=[];for(l=0;l<m.length;l++)n.push(r(m[l],a,j.substring(j.indexOf(".")+1),e));c.all(n).then(function(){g.resolve()},function(a){g.reject(a)})}else g.resolve()}},l.onerror=function(){g.reject(this.error)},g.promise},r=function(a,b,d,e){var f=d.split("."),g=f[0];if(g){var h=b.getAssociationByAlias(g),i=h.getModel();if(h&&i){if("hasOne"===h.type)return p(i,a,h,e,f);if("hasMany"===h.type)return q(i,a,h,e,f)}}var j=c.defer();return j.resolve(),j.promise},s=function(a,d,e,f){var g,h=c.defer(),i=[];if(e&&(g=e.$expand()),g){var j,k=g.split(",");for(j=0;j<k.length;j++)i.push(r(a,d,k[j],f));c.all(i).then(function(){h.resolve()},function(c){b.error("IndexedDBAdapter: PerformExpand",c,g,a),h.reject(c)})}else h.resolve();return h.promise},t=function(a,b){return b.test(a)},u=function(a,b){return b&&a&&(a=a.filter(function(a){return t(a,b)})),a},v=function(a,b,c){if(!c)return b;var d=c.$orderBy();if(d){var e=d.split(" ")[0],f=d.split(" ")[1]||"",g=!1;a.fields[e]&&"DATE"===a.fields[e].type&&(g=!0),b.sort(function(a,b){var c=a[e],d=b[e];return g&&(c=new Date(c),d=new Date(d)),c>d?"desc"===f.toLowerCase()?-1:1:d>c?"desc"===f.toLowerCase()?1:-1:0})}return b},w=function(a,b){if(!b)return a;var c=b.$top(),d=b.$skip();return c>0&&d>=0&&(a=a.slice(d,d+c)),a};return i}]}]),angular.module("recall.adapter.oDataREST",["recall"]).provider("recallODataRESTAdapter",[function(){var a={};a.serverAPILocation="/api/",this.setServerAPILocation=function(b){return"/"!==b.substring(b.length-1)&&(b+="/"),a.serverAPILocation=b,this},a.resultsField="results",this.setResultsField=function(b){return a.resultsField=b,this},a.totalCountFiled="totalCount",this.setTotalCountFiled=function(b){return a.totalCountFiled=b,this},this.$get=["$http","$log","$q","recallAdapterResponse",function(b,c,d,e){var f={},g=function(a,b){return a+=b?b.parseOptions():""};return f.create=function(f,g){var h,i=d.defer(),j=a.serverAPILocation+f.dataSourceName;return b.post(j,g).success(function(a,b,d,g){h=new e(a,1,b,d,g),c.debug("ODataRESTAdapter: Create "+f.modelName,h),i.resolve(h)}).error(function(a,b,d,j){h=new e(a,0,b,d,j),c.error("ODataRESTAdapter: Create "+f.modelName,h,g),i.reject(h)}),i.promise},f.findOne=function(f,h,i){var j,k=d.defer();if(!h)return j=new e("No Primary Key was supplied",0,e.BAD_REQUEST),c.error("ODataRESTAdapter: FindOne "+f.modelName,j,h,i),d.reject(j);var l=g(a.serverAPILocation+f.dataSourceName+"/"+h,i);return b.get(l).success(function(a,b,d,g){j=new e(a,1,b,d,g),c.debug("ODataRESTAdapter: FindOne "+f.modelName,j,h,i),k.resolve(j)}).error(function(a,b,d,g){j=new e(a,0,b,d,g),c.error("ODataRESTAdapter: FindOne "+f.modelName,j,h,i),k.reject(j)}),k.promise},f.find=function(f,h){var i,j=d.defer(),k=g(a.serverAPILocation+f.dataSourceName,h);return b.get(k).success(function(b,d,g,k){var l,m=b;a.resultsField&&(m=b[a.resultsField],a.totalCountFiled&&b[a.totalCountFiled]&&(l=b[a.totalCountFiled])),i=new e(m,l,d,g,k),c.debug("ODataRESTAdapter: Find "+f.modelName,i,h),j.resolve(i)}).error(function(a,b,d,g){i=new e(a,0,b,d,g),c.error("ODataRESTAdapter: Find "+f.modelName,i,h),j.reject(i)}),j.promise},f.update=function(f,g,h){var i,j=d.defer();if(!g)return i=new e("No Primary Key was supplied",0,e.BAD_REQUEST),c.error("ODataRESTAdapter: Update "+f.modelName,i,h),d.reject(i);var k=a.serverAPILocation+f.dataSourceName+"/"+g;return b.put(k,h).success(function(a,b,d,g){i=new e(a,1,b,d,g),c.debug("ODataRESTAdapter: Update "+f.modelName,i,h),j.resolve(i)}).error(function(a,b,d,g){i=new e(a,0,b,d,g),c.error("ODataRESTAdapter: Update "+f.modelName,i,h),j.reject(i)}),j.promise},f.remove=function(f,g){var h,i=d.defer();if(!g)return h=new e("No Primary Key was supplied",0,e.BAD_REQUEST),c.error("ODataRESTAdapter: Remove "+f.modelName,h,g),d.reject(h);var j=a.serverAPILocation+f.dataSourceName+"/"+g;return b({method:"DELETE",url:j}).success(function(a,b,d,j){h=new e(a,1,b,d,j),c.debug("ODataRESTAdapter: Remove "+f.modelName,h,g),i.resolve(h)}).error(function(a,b,d,j){h=new e(a,0,b,d,j),c.error("ODataRESTAdapter: Remove "+f.modelName,h,g),i.reject(h)}),i.promise},f.synchronize=function(f,g,h){var i,j=d.defer(),k=a.serverAPILocation+f.dataSourceName;return b.put(k,{data:g,lastSync:h}).success(function(b,d,h,k){var l,m=b;a.resultsField&&(m=b[a.resultsField],a.totalCountFiled&&b[a.totalCountFiled]&&(l=b[a.totalCountFiled])),i=new e(m,l,d,h,k),c.debug("ODataRESTAdapter: Synchronize "+f.modelName,i,g),j.resolve(i)}).error(function(a,b,d,h){i=new e(a,0,b,d,h),c.error("ODataRESTAdapter: Synchronize "+f.modelName,i,g),j.reject(i)}),j.promise},f}]}]),angular.module("recall.adapter.sync",["recall"]).provider("recallSyncAdapter",[function(){var a={};a.masterAdapter="",this.setMaster=function(b){return a.masterAdapter=b,this},a.slaveAdapter="",this.setSlave=function(b){return a.slaveAdapter=b,this},this.$get=["$injector","$log","$q","recallAdapterResponse","recallLocalStorage","recallPredicate","recallPreparedQueryOptions",function(b,c,d,e,f,g,h){var i={};i.modelValidationHook=function(a){var b=k(),d=l();return b?d?"function"!=typeof b.synchronize?(c.error("SyncAdapter: Synchronize handler not found on the master adapter",this,a),!1):"function"!=typeof d.synchronize?(c.error("SyncAdapter: Synchronize handler not found on the slave adapter",this,a),!1):("function"!=typeof b.modelValidationHook||b.modelValidationHook(a))&&("function"!=typeof d.modelValidationHook||d.modelValidationHook(a))?!0:!1:(c.error("SyncAdapter: Slave Adapter not Set",this,a),!1):(c.error("SyncAdapter: Master Adapter not Set",this,a),!1)},i.create=function(a,b,c){return c&&c.preferMaster()===!0?k().create(a,b):l().create(a,b)},i.findOne=function(a,b,f){var g;return b?f&&f.preferMaster()===!0?k().findOne(a,b,f):l().findOne(a,b,f):(g=new e("No Primary Key was supplied",0,e.BAD_REQUEST),c.error("SyncAdapter: FindOne "+a.modelName,g,b,f),d.reject(g))},i.find=function(a,b){return b&&b.preferMaster()===!0?k().find(a,b):l().find(a,b)},i.update=function(a,b,f,g){var h;return b?g&&g.preferMaster()===!0?k().update(a,b,f):l().update(a,b,f):(h=new e("No Primary Key was supplied",0,e.BAD_REQUEST),c.error("SyncAdapter: Update "+a.modelName,h,f),d.reject(h))},i.remove=function(a,b,f){var g;return b?f&&f.preferMaster()===!0?k().remove(a,b):l().remove(a,b):(g=new e("No Primary Key was supplied",0,e.BAD_REQUEST),c.error("SyncAdapter: Remove "+a.modelName,g,b),d.reject(g))},i.synchronize=function(a){if(a instanceof Array){var b,c=[];for(b=0;b<a.length;b++)c.push(r(a[b]));return d.all(c)}return r(a)};var j=function(a){return"string"==typeof a?b.get(a):a},k=function(){return j(a.masterAdapter)},l=function(){return j(a.slaveAdapter)},m=function(a,b,c,d){this.sent=a,this.returned=b,this.totalProcessed=c,this.status=d},n=function(a){return f.get(f.keys.LAST_SYNC,a.modelName)},o=function(a){f.set(f.keys.LAST_SYNC,(new Date).toISOString(),a.modelName)},p=function(a,b){var c=n(a);return k().synchronize(a,b,c)},q=function(a,b){var c=n(a);return l().synchronize(a,b,c)},r=function(a){var b,e=d.defer(),f=[],i=[],j=0,k=function(d){b=new m(f,i,j,d),c.error("SyncAdapter: "+a.modelName,b),e.reject(b)},r=function(){b=new m(f,i,j,"Complete"),c.debug("SyncAdapter: "+a.modelName,"Sync Complete",b),o(a),e.resolve(b)};c.debug("SyncAdapter: "+a.modelName+" Sync Started");var s=n(a),t=new h;if(s){var u=new g("lastModified").greaterThanOrEqualTo(s);t.$filter(u)}return l().find(a,t,!0).then(function(b){c.debug("SyncAdapter: Sending "+b.count+" local item(s) to sync"),j+=b.count,f=b.data,p(a,b.data).then(function(b){c.debug("SyncAdapter: Found "+b.data.length+" remote item(s) to sync"),j+=b.data.length,i=b.data,b.data.length>0?q(a,b.data).then(r,k):r()},k)},k),e.promise};return i}]}]),angular.module("recall.adapter.webSQL",["recall"]).provider("recallWebSQLAdapter",[function(){var a={};a.dbName="recall",this.setDbName=function(b){return a.dbName=b,this},a.dbVersion=1,this.setDbVersion=function(b){return a.dbVersion=b,this},a.dbSize=5242880,this.setDbSize=function(b){return a.dbSize=b,this},a.pkGenerator=function(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()},this.setPkGenerator=function(b){return a.pkGenerator=b,this},this.dropDatabase=function(){return!0},this.$get=["$log","$q","$window","recall","recallAdapterResponse",function(b,c,d,e,f){var g,h,i={},j=a.pkGenerator,k=function(a,d,e){var f=c.defer(),g="CREATE TABLE IF NOT EXISTS `"+a.dataSourceName+"` ("+d.join(", ")+")";return b.debug("WebSQLAdapter: "+g),e.executeSql(g,[],function(){f.resolve()},function(a,b){f.reject(b)}),f.promise},l=function(a){var d=[];return a.transaction(function(a){var c,f,g,h,i,j=e.getModels();for(c=0;c<j.length;c++){f=j[c],i=[];for(g in f.fields)if(f.fields.hasOwnProperty(g)){switch(h="`"+f.fields[g].name+"`",f.fields[g].type){case"STRING":h+=" TEXT";break;case"NUMBER":h+=" REAL";break;case"DATE":h+=" TEXT";break;case"BOOLEAN":h+=" INTEGER";break;default:return void b.error("WebSQLAdapter: Migrate - An unknown field type was found.")}f.fields[g].primaryKey&&(h+=" PRIMARY KEY"),f.fields[g].unique&&(h+=" UNIQUE"),f.fields[g].notNull&&(h+=" NOT NULL"),i.push(h)}d.push(k(f,i,a))}}),c.all(d)},m=function(a,d,e){var f=c.defer(),g="`"+a.name+"`";switch(a.type){case"STRING":g+=" TEXT";break;case"NUMBER":g+=" REAL";break;case"DATE":g+=" TEXT";break;case"BOOLEAN":g+=" INTEGER";break;default:return void b.error("WebSQLAdapter: Migrate - An unknown field type was found.")}a.primaryKey&&(g+=" PRIMARY KEY"),a.unique&&(g+=" UNIQUE"),a.notNull&&(g+=" NOT NULL");var h="ALTER TABLE `"+d+"` ADD "+g;return b.debug("WebSQLAdapter: "+h),e.executeSql(h,[],function(){f.resolve()},function(a,b){f.reject(b)}),f.promise},n=function(a,b,d){var e,f,g=[],h=null;for(e=0;e<b.length;e++)if(f=b[e],f.tbl_name===a.dataSourceName){h=f.sql;break}if(h){var i,j=[];for(i in a.fields)a.fields.hasOwnProperty(i)&&-1===h.indexOf("`"+i+"`")&&j.push(a.fields[i]);for(e=0;e<j.length;e++)g.push(m(j[e],a.dataSourceName,d))}return c.all(g)},o=function(a){var d=c.defer();return a.transaction(function(a){var f="SELECT tbl_name, sql from sqlite_master WHERE type = 'table'";b.debug("WebSQLAdapter: "+f),a.executeSql(f,[],function(a,b){var f,g,h=e.getModels(),i=[],j=[];for(g=0;g<b.rows.length;g++)j.push(b.rows.item(g));for(g=0;g<h.length;g++)f=h[g],i.push(n(f,j,a));c.all(i).then(function(){d.resolve()},function(a){d.reject(a)})},function(a,b){d.reject(b)})}),d.promise},p=function(a){var d=c.defer();return l(a).then(function(){o(a).then(function(){d.resolve()},function(a){b.error("WebSQLAdapter: Table Migration Failed",a),d.reject(a)})},function(a){b.error("WebSQLAdapter: Table Creation Failed",a),d.reject(a)}),d.promise},q=function(){var b=c.defer();if(h)b.resolve(h);else{if(g)return g;try{var e=d.openDatabase(a.dbName,a.dbVersion.toString(),"Recall WebSQL Database",a.dbSize);p(e).then(function(){h=e,b.resolve(h)},function(a){b.reject(a)})}catch(f){b.reject(f)}}return g=b.promise,b.promise};i.create=function(a,d){var e,g=c.defer(),i=function(c){return e=new f(c,0,f.INTERNAL_SERVER_ERROR),b.error("WebSQLAdapter: Create "+a.modelName,e,d),e};return d[a.primaryKeyFieldName]=j(),d=a.getRawModelObject(d,!1),d[a.lastModifiedFieldName]=new Date,q().then(function(){h.transaction(function(c){var h,j=[],k=[],l=[];for(h in a.fields)a.fields.hasOwnProperty(h)&&d.hasOwnProperty(h)&&(j.push("`"+h+"`"),k.push(B(a.fields[h],d)),l.push("?"));var m="INSERT INTO `"+a.dataSourceName+"` ("+j.join(",")+") VALUES ("+l.join(",")+")";b.debug("WebSQLAdapter: "+m,k),c.executeSql(m,k,function(){e=new f(d,1,f.CREATED),b.debug("WebSQLAdapter: Create "+a.modelName,e),g.resolve(e)},function(a,b){g.reject(i(b))})})},function(a){g.reject(i(a))}),g.promise},i.findOne=function(a,d,e,g){var i,j=c.defer(),k=function(c,g){return i=new f(c,0,g||f.INTERNAL_SERVER_ERROR),b.error("WebSQLAdapter: FindOne "+a.modelName,i,d,e),i};return q().then(function(){h.transaction(function(c){var h="SELECT * FROM `"+a.dataSourceName+"` WHERE `"+a.primaryKeyFieldName+"`=?";!g&&a.deletedFieldName&&(h+=" AND `"+a.deletedFieldName+"`=0"),b.debug("WebSQLAdapter: "+h,[d]),c.executeSql(h,[d],function(c,g){var h=E(a,g);h[0]?w(h[0],a,e,c).then(function(){i=new f(h[0],1),b.debug("WebSQLAdapter: FindOne "+a.modelName,i,d,e),j.resolve(i)},function(a){j.reject(k(a))}):j.reject(k("Not Found",f.NOT_FOUND))},function(a,b){j.reject(k(b))})})},function(a){j.reject(k(a))}),j.promise},i.find=function(a,d,e){var g,i=c.defer(),j=function(c){return g=new f(c,0,f.INTERNAL_SERVER_ERROR),b.error("WebSQLAdapter: Find "+a.modelName,g,d),g};return q().then(function(){h.transaction(function(h){var k;d&&d.$filter()&&(k=d.$filter());var l="SELECT * FROM `"+a.dataSourceName+"`";!e&&a.deletedFieldName&&(l+=" WHERE `"+a.deletedFieldName+"`=0"),b.debug("WebSQLAdapter: "+l),h.executeSql(l,[],function(e,h){var l,m=E(a,h),n=[];for(l=0;l<m.length;l++)n.push(w(m[l],a,d,e));c.all(n).then(function(){m=y(m,k),m=z(a,m,d);var c=m.length;m=A(m,d),g=new f(m,c),b.debug("WebSQLAdapter: Find "+a.modelName,g,d),i.resolve(g)},function(a){i.reject(j(a))})},function(a,b){i.reject(j(b))})})},function(a){i.reject(j(a))}),i.promise},i.update=function(a,d,e,g){var i,j=c.defer(),k=function(c){return i=new f(c,0,f.INTERNAL_SERVER_ERROR),b.error("WebSQLAdapter: Update "+a.modelName,i,e),i};return e=a.getRawModelObject(e,!1),e[a.lastModifiedFieldName]=new Date,q().then(function(){h.transaction(function(c){var h,l=[],m=[];for(h in a.fields)a.fields.hasOwnProperty(h)&&e.hasOwnProperty(h)&&h!==a.primaryKeyFieldName&&(l.push("`"+h+"`=?"),m.push(B(a.fields[h],e)));m.push(d);var n="UPDATE `"+a.dataSourceName+"` SET "+l.join(",")+" WHERE `"+a.primaryKeyFieldName+"`=?";!g&&a.deletedFieldName&&(n+=" AND `"+a.deletedFieldName+"`=0"),b.debug("WebSQLAdapter: "+n,m),c.executeSql(n,m,function(){i=new f(e,1),b.debug("WebSQLAdapter: Update "+a.modelName,i,e),j.resolve(i)},function(a,b){j.reject(k(b))})})},function(a){j.reject(k(a))}),j.promise},i.remove=function(a,d){var e,g=c.defer(),i=function(c){return e=new f(c,0,f.INTERNAL_SERVER_ERROR),b.error("WebSQLAdapter: Remove "+a.modelName,e),e},j=["`"+a.lastModifiedFieldName+"`=?","`"+a.deletedFieldName+"`=?"],k=[(new Date).toISOString(),1,d];return q().then(function(){h.transaction(function(c){var d="UPDATE `"+a.dataSourceName+"` SET "+j.join(",")+" WHERE `"+a.primaryKeyFieldName+"`=?";b.debug("WebSQLAdapter: "+d,k),c.executeSql(d,k,function(){e=new f(null,1,f.NO_CONTENT),b.debug("WebSQLAdapter: Remove "+a.modelName,e),g.resolve(e)},function(a,b){g.reject(i(b))})})},function(a){g.reject(i(a))}),g.promise},i.synchronize=function(a,d){var e,g=c.defer(),i=function(c){return e=new f(c,0,f.INTERNAL_SERVER_ERROR),b.error("WebSQLAdapter: Synchronize "+a.modelName,e,d),e};return q().then(function(){h.transaction(function(h){var j,k=[];for(j=0;j<d.length;j++)k.push(d[j][a.deletedFieldName]?s(a,h,d[j][a.primaryKeyFieldName]):r(a,h,d[j]));c.all(k).then(function(c){e=new f(c,c.length,f.OK),b.debug("WebSQLAdapter: Synchronize "+a.modelName,e,d),g.resolve(e)},function(a){g.reject(i(a))})})},function(a){g.reject(i(a))}),g.promise};var r=function(a,d,e){var f,g=c.defer(),h=[],i=[],j=[];for(f in a.fields)a.fields.hasOwnProperty(f)&&e.hasOwnProperty(f)&&(h.push("`"+f+"`"),i.push(B(a.fields[f],e)),j.push("?"));var k="INSERT OR REPLACE INTO `"+a.dataSourceName+"` ("+h.join(",")+") VALUES ("+j.join(",")+")";return b.debug("WebSQLAdapter: "+k,i),d.executeSql(k,i,function(b,c){var d=E(a,c);g.resolve(d[0])},function(a,b){g.reject(b)}),g.promise},s=function(a,d,e){var f=c.defer(),g="DELETE FROM `"+a.dataSourceName+"` WHERE `"+a.primaryKeyFieldName+"`=?";return b.debug("WebSQLAdapter: "+g,[e]),d.executeSql(g,[e],function(){f.resolve()},function(a,b){f.reject(b)}),f.promise},t=function(a,d,e,f,g){var h=c.defer(),i=g.join(".");if(void 0===d[e.mappedBy])return d[e.mappedBy]=null,h.resolve(),h.promise;var j="SELECT * FROM `"+a.dataSourceName+"` WHERE `"+a.primaryKeyFieldName+"`=?";return a.deletedFieldName&&(j+=" AND `"+a.deletedFieldName+"`=0"),b.debug("WebSQLAdapter: "+j,[d[e.mappedBy]]),f.executeSql(j,[d[e.mappedBy]],function(b,c){var f=E(a,c);f[0]?(d[e.alias]=f[0],g.length>1?v(f[0],a,i.substring(i.indexOf(".")+1),b).then(function(){h.resolve()},function(a){h.reject(a)}):h.resolve()):(d[e.alias]=null,h.resolve())},function(a,b){h.reject(b)}),h.promise},u=function(a,d,e,f,g){var h=c.defer(),i=g.join("."),j="SELECT * FROM `"+a.dataSourceName+"` WHERE `"+e.mappedBy+"`=?";return a.deletedFieldName&&(j+=" AND `"+a.deletedFieldName+"`=0"),b.debug("WebSQLAdapter: "+j,[d[a.primaryKeyFieldName]]),f.executeSql(j,[d[a.primaryKeyFieldName]],function(b,f){var j=E(a,f),k=e.getOptions(d).$filter();if(k&&(j=y(j,k)),d[e.alias]=j,g.length>1){var l,m=[];for(l=0;l<j.length;l++)m.push(v(j[l],a,i.substring(i.indexOf(".")+1),b));c.all(m).then(function(){h.resolve()},function(a){h.reject(a)})}else h.resolve()},function(a,b){h.reject(b)}),h.promise},v=function(a,b,d,e){var f=d.split("."),g=f[0];if(g){var h=b.getAssociationByAlias(g),i=h.getModel();if(h&&i){if("hasOne"===h.type)return t(i,a,h,e,f);if("hasMany"===h.type)return u(i,a,h,e,f)}}var j=c.defer();return j.resolve(),j.promise},w=function(a,d,e,f){var g,h=c.defer(),i=[];if(e&&(g=e.$expand()),g){var j,k=g.split(",");for(j=0;j<k.length;j++)i.push(v(a,d,k[j],f));c.all(i).then(function(){h.resolve()},function(c){b.error("WebSQLAdapter: PerformExpand",c,g,a),h.reject(c)})}else h.resolve();return h.promise},x=function(a,b){return b.test(a)},y=function(a,b){return b&&a&&(a=a.filter(function(a){return x(a,b)})),a},z=function(a,b,c){if(!c)return b;var d=c.$orderBy();if(d){var e=d.split(" ")[0],f=d.split(" ")[1]||"",g=!1;a.fields[e]&&"DATE"===a.fields[e].type&&(g=!0),b.sort(function(a,b){var c=a[e],d=b[e];return g&&(c=new Date(c),d=new Date(d)),c>d?"desc"===f.toLowerCase()?-1:1:d>c?"desc"===f.toLowerCase()?1:-1:0})}return b},A=function(a,b){if(!b)return a;var c=b.$top(),d=b.$skip();return c>0&&d>=0&&(a=a.slice(d,d+c)),a},B=function(a,b){switch(a.type){case"STRING":case"NUMBER":return b[a.name];case"DATE":return b[a.name]instanceof Date?b[a.name].toISOString():new Date(b[a.name]).toISOString();case"BOOLEAN":return b[a.name]===!0||1===b[a.name]?1:0}},C=function(a,b){switch(a.type){case"STRING":case"NUMBER":case"DATE":return b[a.name];case"BOOLEAN":return 1===b[a.name]}},D=function(a,b){var c,d={};for(c in a.fields)a.fields.hasOwnProperty(c)&&b.hasOwnProperty(c)&&(d[c]=C(a.fields[c],b));return d},E=function(a,b){var c,d=[];for(c=0;c<b.rows.length;c++)d.push(D(a,b.rows.item(c)));return d};return i}]}]),angular.module("recall").factory("recallAssociation",["$injector","$log","$q","recallPredicate","recallPreparedQueryOptions",function(a,b,c,d,e){var f=function(a){this.invalid=!1,a.type?this.type=a.type:"string"==typeof a.hasOne?this.type="hasOne":"string"==typeof a.hasMany&&(this.type="hasMany"),this.modelName=a.modelName||a.hasOne||a.hasMany,this.alias=a.as||a.alias||this.modelName,this.mappedBy=a.mappedBy||a.foreignKey,this.getOptions=a.getOptions||function(){return new e},this.modelName&&this.type&&this.mappedBy||(b.error("Association: The association definition is invalid",a),this.invalid=!0)};return f.prototype.getModel=function(){var b=a.get("recall");return b.getModel(this.modelName)},f.prototype.expand=function(a){var e=c.defer(),f=this,g=f.getModel();if(!g)return c.reject("Association: Expand could not find the association's Model");var h=f.getOptions(a);if("hasOne"===f.type)g.adapter.findOne(g,a[f.mappedBy],h).then(function(c){a[f.alias]=g.getRawModelObject(c.data),a.$entity.storedState[f.alias]=g.getRawModelObject(c.data),b.debug("Association: Expand",f.type,f.alias,a,c),e.resolve()},function(c){b.error("Association: Expand",f.type,f.alias,a,c),e.reject(c)});else if("hasMany"===f.type){var i=new d(f.mappedBy).equals(a.$getPrimaryKey()),j=h.$filter();j&&(i=d.join([i,j])),h.$filter(i),g.adapter.find(g,h).then(function(c){var d,h=[],i=[];for(d=0;d<c.data.length;d++)h.push(g.getRawModelObject(c.data[d])),i.push(g.getRawModelObject(c.data[d]));a[f.alias]=h,a.$entity.storedState[f.alias]=i,b.debug("Association: Expand",f.type,f.alias,a,c),e.resolve()},function(c){b.error("Association: Expand",f.type,f.alias,a,c),e.reject(c)})}else b.error("Association: Expand Association type not supported",f.type,f.alias,a),e.reject("Association type not supported");return e.promise},f}]),angular.module("recall").factory("recallEntity",["$log","$q",function(a,b){var c=function(a,b,c){b.extendFromRawObject(this,a||{}),Object.defineProperty(this,"$entity",{value:{lastDirtyCheck:(new Date).getTime(),lastDirtyState:!1,persisted:c===!0,saveInProgress:!1,storedState:null}}),Object.defineProperty(this,"$model",{value:b}),this.$convertAssociationsToEntities(),this.$storeState()};return c.prototype.$getPrimaryKey=function(){return this[this.$model.primaryKeyFieldName]},c.prototype.$convertAssociationsToEntities=function(){var a,b,c,d;for(a=0;a<this.$model.associations.length;a++)if(b=this.$model.associations[a].alias,c=this.$model.associations[a].getModel(),"hasOne"===this.$model.associations[a].type)void 0===this[b]||this[b].$entity||(this[b]=new c.Entity(this[b],this.$entity.persisted));else if("hasMany"===this.$model.associations[a].type&&void 0!==this[b]&&this[b]instanceof Array)for(d=0;d<this[b].length;d++)this[b][d].$entity||(this[b][d]=new c.Entity(this[b][d],this.$entity.persisted))},c.prototype.$expand=function(a){var c=this.$model.getAssociationByAlias(a);return c?c.expand(this):b.reject("Entity: $expand could not find the association.")},c.prototype.$isValid=function(){var b,c,d=!1;for(b in this.$model.fields)if(this.$model.fields.hasOwnProperty(b)){if(c=null===this[b]||void 0===this[b],this.$model.fields[b].notNull===!0&&c)return a.debug("Entity: $isValid returned false","NotNull field was null",b,this),!1;switch(this.$model.fields[b].type){case"STRING":d="string"==typeof this[b];break;case"NUMBER":d="number"==typeof this[b];break;case"BOOLEAN":d=this[b]===!0||this[b]===!1;break;case"DATE":d=this[b]instanceof Date||!isNaN(Date.parse(this[b]))}if(!d&&!c)return a.debug("Entity: $isValid returned false",b+" was not a "+this.$model.fields[b].type,this),!1;if("function"==typeof this.$model.fields[b].validate&&!this.$model.fields[b].validate(this[b]))return a.debug("Entity: $isValid returned false","Custom validator failed",b,this),!1}return!0},c.prototype.$save=function(c){var d=b.defer(),e=this;if(!e.$isValid())return a.warn("Entity: $save: aborted",e,e[e.$model.primaryKeyFieldName]),e.$reset(),b.reject("aborted");e.$entity.saveInProgress=!0;var f=e.$model.preSave(e),g=function(a,b){a.$entity.saveInProgress=!1,b!==!1?(a.$storeState(),a.$entity.persisted=!0):a.$reset()};if(e.$entity.persisted&&f[e.$model.primaryKeyFieldName]){f=e.$model.preUpdate(f);var h=f[e.$model.primaryKeyFieldName];e.$model.adapter.update(e.$model,h,f,c).then(function(b){var c=e.$model.transformResult(b.data);e.$model.extendFromRawObject(e,c),g(e,!0),a.debug("Entity: $save: update",e,f,b),d.resolve(e)},function(b){g(e,!1),a.error("Entity: $save: update",e,f,b),d.reject(b)})}else f=e.$model.preCreate(f),e.$model.adapter.create(e.$model,f,c).then(function(b){var c=e.$model.transformResult(b.data);e.$model.extendFromRawObject(e,c),g(e,!0),a.debug("Entity: $save: create",e,f,b),d.resolve(e)},function(b){g(e,!1),a.error("Entity: $save: create",e,f,b),d.reject(b)});return d.promise},c.prototype.$remove=function(c){return this[this.$model.primaryKeyFieldName]?this.$model.adapter.remove(this.$model,this[this.$model.primaryKeyFieldName],c):(a.error("Entity: $remove","The primary key was not found"),b.reject("The primary key was not found."))},c.prototype.$storeState=function(){this.$entity.storedState=this.$model.getRawModelObject(this,!1),this.$entity.lastDirtyCheck=(new Date).getTime(),this.$entity.lastDirtyState=!1},c.prototype.$isDirty=function(){if(this.$entity.saveInProgress)return!1;if(!this.$entity.storedState)return!1;var b=(new Date).getTime(),c=b-this.$entity.lastDirtyCheck;if(this.$entity.lastDirtyCheck&&c<this.$model.dirtyCheckThreshold)return this.$entity.lastDirtyState;this.$entity.lastDirtyCheck=(new Date).getTime();var d,e,f;for(d in this.$model.fields)if(this.$model.fields.hasOwnProperty(d)&&(f=this.$entity.storedState[d],e=this[d],f!==e))return a.debug("Entity: $isDirty",this[this.$model.primaryKeyFieldName],!0,c),
this.$entity.lastDirtyState=!0,!0;return a.debug("Entity: $isDirty",this[this.$model.primaryKeyFieldName],!1,c),this.$entity.lastDirtyState=!1,!1},c.prototype.$reset=function(){if(!this.$entity.storedState)return this.$storeState(),[];var b,c=[];for(b in this.$entity.storedState)this.$entity.storedState.hasOwnProperty(b)&&this[b]!==this.$entity.storedState[b]&&(c.push({name:b,before:this[b],after:this.$entity.storedState[b]}),this[b]=this.$entity.storedState[b]);return this.$entity.lastDirtyState=!1,this.$entity.lastDirtyCheck=(new Date).getTime(),a.debug("Entity: $reset",this[this.$model.primaryKeyFieldName],c),c},c}]),angular.module("recall").factory("recallLocalStorage",["$document","$window",function(a,b){var c={keys:{LAST_SYNC:"LAST_SYNC"}},d=function(a){return void 0!==c.keys[a]},e=function(a,b){return b&&(a+="_"+b),a};return c.registerKey=function(a){d(a)||(c.keys[a]=a)},c.set=function(f,g,h){if(d(f))if(f=e(f,h),c.supportsLocalStorage())b.localStorage.setItem(f,g);else{var i=432e3,j=encodeURIComponent(g);a.cookie=f+"="+j+"; max-age="+i+";"}},c.get=function(f,g){var h="";if(d(f))if(f=e(f,g),c.supportsLocalStorage())h=b.localStorage.getItem(f)||"";else{var i=new RegExp(f+"=([^;]+)","g"),j=i.exec(a.cookie);j&&(h=decodeURIComponent(j[1]))}return h},c.remove=function(f,g){d(f)&&(f=e(f,g),c.supportsLocalStorage()?b.localStorage.removeItem(f):a.cookie=f+"=; max-age=0;")},c.supportsLocalStorage=function(){try{return"localStorage"in b&&null!==b.localStorage}catch(a){return!1}},c}]),angular.module("recall").factory("recallModel",["$log","$q","recallAssociation","recallEntity","recallModelField",function(a,b,c,d,e){var f=function(a){return b.reject(a)},g=function(a){this.modelName=a.name,this.dataSourceName=a.dataSourceName||a.name,Object.defineProperty(this,"modelDefinition",{value:a,writable:!1});var b=this;Object.defineProperty(this,"Entity",{writable:!1,configurable:!1,value:function(a,c){return new d(a,b,c===!0)}}),this.fields={},this.associations=[],this.dirtyCheckThreshold=30,this.primaryKeyFieldName=null,this.lastModifiedFieldName=null,this.deletedFieldName=null,this.adapter=null};return g.prototype.setLastModifiedFieldName=function(a){this.lastModifiedFieldName=a},g.prototype.setDeletedFieldName=function(a){this.deletedFieldName=a},g.prototype.setAdapter=function(a){this.adapter=a},g.prototype.setDirtyCheckThreshold=function(a){this.dirtyCheckThreshold=a},g.prototype.initializeModelFields=function(){var b,c,d,f,g=this.modelDefinition.fields;for(b in g)if(g.hasOwnProperty(b)){if(c=new e(b,g[b]),c.primaryKey&&(this.primaryKeyFieldName=b),c.invalid)return!1;this.fields[b]=c,b===this.lastModifiedFieldName&&(d=c),b===this.deletedFieldName&&(f=b)}return d&&"DATE"!==d.type?(a.error("Model: The last modified field is not a Date field"),!1):(this.lastModifiedFieldName&&!d&&(this.fields[this.lastModifiedFieldName]=new e(this.lastModifiedFieldName,{type:"DATE",index:!0,getDefaultValue:function(){return(new Date).toISOString()}})),f&&"BOOLEAN"!==f.type?(a.error("Model: The deletedField field is not a Boolean field"),!1):(this.deletedFieldName&&!f&&(this.fields[this.deletedFieldName]=new e(this.deletedFieldName,{type:"BOOLEAN",index:!0,getDefaultValue:function(){return!1}})),!0))},g.prototype.initializeAssociations=function(){var a=this.modelDefinition.associations;if(a){var b,d;for(b=0;b<a.length;b++)d=new c(a[b]),d&&!d.invalid&&("hasOne"===d.type&&(this.fields[d.mappedBy]?this.fields[d.mappedBy].index=d.mappedBy:this.fields[d.mappedBy]=new e(d.mappedBy,{type:this.fields[this.primaryKeyFieldName].type,index:d.mappedBy})),this.associations.push(d))}},g.prototype.getAssociationByAlias=function(a){var b;for(b=0;b<this.associations.length;b++)if(this.associations[b].alias===a)return this.associations[b];return null},g.prototype.extendFromRawObject=function(a,b){angular.extend(a,this.getRawModelObject(b))},g.prototype.getRawModelObject=function(a,b){var c,d={};for(c in this.fields)this.fields.hasOwnProperty(c)&&(d[c]=a[c]);var e,f,g,h,i;for(e=0;e<this.associations.length;e++)if(f=this.associations[e].alias,h=this.associations[e].getModel(),"hasOne"===this.associations[e].type)void 0!==a[f]&&(g=a[f][h.primaryKeyFieldName],d[this.associations[e].mappedBy]=g,b!==!1&&(d[f]=h.getRawModelObject(a[f])));else if("hasMany"===this.associations[e].type&&b!==!1&&void 0!==a[f]&&a[f]instanceof Array)for(d[f]=[],i=0;i<a[f].length;i++)d[f].push(h.getRawModelObject(a[f][i]));return d},g.prototype.applyDefaultValues=function(a){var b;for(b in this.fields)this.fields.hasOwnProperty(b)&&"function"==typeof this.fields[b].getDefaultValue&&void 0===a[b]&&(a[b]=this.fields[b].getDefaultValue(a))},g.prototype.transformResult=function(a){var b,c,d,e;for(b=0;b<this.associations.length;b++)if(c=this.associations[b].alias,d=this.associations[b].getModel(),"hasOne"===this.associations[b].type)void 0!==a[c]&&(a[c]=d.transformResult(a[c]));else if("hasMany"===this.associations[b].type&&void 0!==a[c]&&a[c]instanceof Array)for(e=0;e<a[c].length;e++)a[c][e]=d.transformResult(a[c][e]);return a=this.getRawModelObject(a),"function"==typeof this.modelDefinition.transformResult&&(a=this.modelDefinition.transformResult(a)),a},g.prototype.preSave=function(a){return a=this.getRawModelObject(a),"function"==typeof this.modelDefinition.preSave?this.modelDefinition.preSave(a):a},g.prototype.preCreate=function(a){return this.applyDefaultValues(a),"function"==typeof this.modelDefinition.preCreate?this.modelDefinition.preCreate(a):a},g.prototype.preUpdate=function(a){return"function"==typeof this.modelDefinition.preUpdate?this.modelDefinition.preUpdate(a):a},g.prototype.findOne=function(c,e){var g=this;return c?this.adapter.findOne(this,c,e).then(function(b){var c=g.transformResult(b.data),f=new d(c,g,!0);return a.debug("Model: FindOne",f,b,e),f},f):(a.error("Model: FindOne","The primary key was not supplied"),b.reject("The primary key was not supplied."))},g.prototype.find=function(b){var c=this;return this.adapter.find(this,b).then(function(e){var f,g=[];for(f=0;f<e.data.length;f++)g.push(new d(c.transformResult(e.data[f]),c,!0));var h={results:g,totalCount:e.count};return a.debug("Model: Find",h,e,b),h},f)},g.prototype.remove=function(c,d){return c?this.adapter.remove(this,c,d):(a.error("Model: Remove","The primary key was not supplied"),b.reject("The primary key was not supplied."))},g}]),angular.module("recall").factory("recallModelField",["$log",function(a){var b=function(b,e){this.invalid=!1,this.name=b,this.primaryKey=!1,this.unique=!1,this.index=!1,this.notNull=!1,"string"==typeof e?this.type=e.toUpperCase():e.primaryKey===!0?c(this,e):d(this,e),this.validateField()||a.error("ModelField: The field definition is invalid",this,e)};b.prototype.validateField=function(){return this.name&&this.type?null!==this.name.match(/[^\w+]/)?(this.invalid=!0,!1):(this.invalid=!1,!0):(this.invalid=!0,!1)};var c=function(b,c){b.primaryKey=!0,b.type=c.type?c.type.toUpperCase():null,b.notNull=!1,b.unique=!1,b.index=!1,"function"==typeof c.getDefaultValue&&a.warn("ModelField: getDefaultValue is ignored for the primary key"),"function"==typeof c.validate&&a.warn("ModelField: validate is ignored for the primary key")},d=function(a,b){a.type=b.type?b.type.toUpperCase():null,a.unique=b.unique===!0,a.index="string"==typeof b.index?b.index:b.index===!0?a.name:!1,a.notNull=b.notNull===!0,"function"==typeof b.getDefaultValue&&(a.getDefaultValue=b.getDefaultValue),"function"==typeof b.validate&&(a.validate=b.validate)};return b}]),Date.prototype.toISOString||!function(){function a(a){return 10>a?"0"+a:a}Date.prototype.toISOString=function(){return this.getUTCFullYear()+"-"+a(this.getUTCMonth()+1)+"-"+a(this.getUTCDate())+"T"+a(this.getUTCHours())+":"+a(this.getUTCMinutes())+":"+a(this.getUTCSeconds())+"."+(this.getUTCMilliseconds()/1e3).toFixed(3).slice(2,5)+"Z"}}(),angular.module("recall").factory("recallPredicate",[function(){function a(a,b){return this.property=a,this.parser=b,this}a.join=function(b,c){return b instanceof Array&&b.length>0?(new a).join(b,c):null},a.prototype.setProperty=function(a){return this.property=a,this},a.prototype.equals=function(a){return this.parser=function(){return this.property+" eq "+c(a)},this},a.prototype.notEqualTo=function(a){return this.parser=function(){return this.property+" ne "+c(a)},this},a.prototype.greaterThan=function(a){return this.parser=function(){return this.property+" gt "+c(a)},this},a.prototype.greaterThanOrEqualTo=function(a){return this.parser=function(){return this.property+" ge "+c(a)},this},a.prototype.lessThan=function(a){return this.parser=function(){return this.property+" lt "+c(a)},this},a.prototype.lessThanOrEqualTo=function(a){return this.parser=function(){return this.property+" le "+c(a)},this},a.prototype.contains=function(a){return this.parser=function(){return"substringof("+c(a)+", "+this.property+")"},this},a.prototype.startsWith=function(a){return this.parser=function(){return"startswith("+this.property+", "+c(a)+")"},this},a.prototype.endsWith=function(a){return this.parser=function(){return"endswith("+this.property+", "+c(a)+")"},this},a.prototype.join=function(b,c){var d;this.property&&"function"==typeof this.parser&&(d=new a(this.property,this.parser));var e=[];if(b instanceof a)e.push(b);else if(b instanceof Array&&b.length>0){var f;for(f=0;f<b.length;f++)b[f]&&e.push(b[f])}return e.length>0&&(delete this.parser,delete this.property,this.joinedPredicates=this.joinedPredicates?this.joinedPredicates.concat(e):e,(c||!this.groupOperator)&&(this.groupOperator="or"===c?"or":"and"),d&&this.joinedPredicates.unshift(d)),this},a.prototype.and=function(a){return this.join(a,"and")},a.prototype.or=function(a){return this.join(a,"or")},a.prototype.test=function(a,b){return f(this,a,b)},a.prototype.parsePredicate=function(a){a=a===!0;var b="";if(this.property&&"function"==typeof this.parser)return this.parser();if(this.joinedPredicates&&this.joinedPredicates.length>0){var c,d,e;for(c=0;c<this.joinedPredicates.length;c++)d=this.joinedPredicates[c],e=d.parsePredicate(!0),b+=c>0?" "+this.groupOperator+" "+e:e}return a?"("+b+")":b},a.fromString=function(a){if("string"!=typeof a)return null;var c=new RegExp("(substringof\\(.+?\\)|startswith\\(.+?\\)|endswith\\(.+?\\)|[\\w\\.]+?\\s(?:eq|ne|gt|ge|lt|le)\\s(?:\\w+|\\'.+?\\'))","g"),d=a.match(c);if(!d)return null;var e;for(e=0;e<d.length;e++)if(d[e]=k(d[e]),null===d[e])return null;return 0===d.length?null:(e=0,a=a.replace(c,function(){return e++}),1===d.length?""!==a.replace(/[0-9]|\s|and|or/g,"")?null:d[0]:b(a,d))};var b=function(b,c){for(var d,e,f,g,h,i,j=null,k=!0;k;){if(d=b.indexOf(")"),-1!==d?(e=b.lastIndexOf("(",d),f=b.substring(e+1,d),b=b.substring(0,e)+c.length+b.substring(d+1)):(f=b,k=!1),""!==f.replace(/[0-9]|\s|and|or/g,""))return null;if(f.indexOf("and")>=0&&f.indexOf("or")>=0)return null;g=f.match(/[0-9]+/g),h=[];var l;for(l=0;l<g.length;l++)h.push(c[Number(g[l])]);i=f.indexOf("or")>=0?"or":"and",j=(new a).join(h,i),c.push(j)}return j},c=function(a){return a instanceof Date&&(a=a.toISOString()),"string"==typeof a?"'"+a+"'":a.toString()},d=function(a){if("string"==typeof a){if(a.indexOf("'")>=0)return a.replace(/\'/g,"");if("true"===a.toLowerCase())return!0;if("false"===a.toLowerCase())return!1}return isNaN(a)?a:Number(a)},e=function(a,b){var c,d;for(d=0;d<a.joinedPredicates.length;d++){if(c=f(a.joinedPredicates[d],b),"and"===a.groupOperator&&c===!1)return!1;if("or"===a.groupOperator&&c===!0)return!0}return"and"===a.groupOperator},f=function(a,b,c){if(a.joinedPredicates&&a.joinedPredicates.length>0)return e(a,b);if(a.property){var d,f=a.property.split("."),i=b;for(d=0;d<f.length;d++){if(!i.hasOwnProperty(f[d])||void 0===i[f[d]])return c===!1;i=i[f[d]]}var j=a.parsePredicate();return j.indexOf("(")>=0?g(j,i):h(j,i)}return!1},g=function(a,b){var c,d=a.substr(0,a.indexOf("(")),e=a.indexOf("(")+1,f=a.indexOf(")")-e,g=a.substr(e,f);switch(g=g.replace(/\'/g,"").split(", "),d){case"startswith":return c=g[1].toLowerCase(),0===b.indexOf(c);case"endswith":return c=g[1].toLowerCase(),b.indexOf(c)===b.length-1-c.length;case"substringof":return c=g[0].toLowerCase(),b.indexOf(c)>=0}return!1},h=function(a,b){var c=a.split(" "),e=c[1],f=c.slice(2).join(" ");switch(f=d(f),b instanceof Date&&!isNaN(Date.parse(f))?(f=Date.parse(f),b=b.getTime()):"string"!=typeof b||isNaN(Date.parse(b))||(b=Date.parse(b),f=Date.parse(f)),e){case"lt":return f>b;case"gt":return b>f;case"le":return f>=b;case"ge":return b>=f;case"ne":return b!=f;case"eq":return b==f}return!1},i=function(b){var c,e,f=b.indexOf("("),g=b.substring(0,f),h=b.substring(f+1,b.indexOf(")")).split(", ");switch(g){case"startswith":e=d(h[1]),c=new a(h[0]).startsWith(e);break;case"endswith":e=d(h[1]),c=new a(h[0]).endsWith(e);break;case"substringof":e=d(h[0]),c=new a(h[1]).contains(e)}return c},j=function(b){var c=b.split(" "),e=c[1],f=d(c.slice(2).join(" ")),g=new a(c[0]);switch(e){case"eq":g.equals(f);break;case"ne":g.notEqualTo(f);break;case"gt":g.greaterThan(f);break;case"ge":g.greaterThanOrEqualTo(f);break;case"lt":g.lessThan(f);break;case"le":g.lessThanOrEqualTo(f)}return g},k=function(a){return a.indexOf("(")>=0?i(a):j(a)};return a}]),angular.module("recall").factory("recallPreparedQueryOptions",["recallPredicate",function(a){function b(){this.options={}}var c=function(a){return a&&"object"==typeof a&&"function"==typeof a.parsePredicate};return b.prototype.preferMaster=function(a){return 0===arguments.length?this.options.preferMaster||null:null===a?(delete this.options.preferMaster,this):(this.options.preferMaster=a===!0,this)},b.prototype.$top=function(a){return 0===arguments.length?this.options.$top||null:("number"==typeof a&&a>=0&&(this.options.$top=a),null===a&&delete this.options.$top,this)},b.prototype.$skip=function(a){return 0===arguments.length?this.options.$skip||null:("number"==typeof a&&a>=0&&(this.options.$skip=a),null===a&&delete this.options.$skip,this)},b.prototype.$orderBy=function(a){return 0===arguments.length?this.options.$orderby||null:(a&&"string"==typeof a&&(this.options.$orderby=a),null===a&&delete this.options.$orderby,this)},b.prototype.$expand=function(a){return 0===arguments.length?this.options.$expand||null:("string"==typeof a?this.options.$expand=a:a instanceof Array&&(this.options.$expand=a.join(",")),null===a&&delete this.options.$expand,this)},b.prototype.$select=function(a){return 0===arguments.length?this.options.$select||null:("string"==typeof a?this.options.$select=a:a instanceof Array&&(this.options.$select=a.join(",")),null===a&&delete this.options.$select,this)},b.prototype.$inlineCount=function(a){return 0===arguments.length?this.options.$inlinecount||null:(a!==!1&&null!==a?this.options.$inlinecount="allpages":delete this.options.$inlinecount,this)},b.prototype.$filter=function(b){return 0===arguments.length?this.options.$filter||null:(b&&"string"==typeof b?this.options.$filter=a.fromString(b):c(b)&&(this.options.$filter=b),null===b&&delete this.options.$filter,this)},b.prototype.custom=function(a,b){return 1===arguments.length?this.options[a]||null:(a&&"string"==typeof a&&0!==a.indexOf("$")&&b&&("string"==typeof b||"number"==typeof b||"boolean"==typeof b)&&(this.options[a]=b),a&&null===b&&delete this.options[a],this)},b.prototype.extend=function(a){var b;for(b in a.options)a.options.hasOwnProperty(b)&&(this.options[b]=a.options[b]);return this},b.prototype.parseOptions=function(){var a,b="",d=function(){b+=""===b?"?":"&"};for(a in this.options)this.options.hasOwnProperty(a)&&(d(),b+=c(this.options[a])?a+"="+this.options[a].parsePredicate():a+"="+this.options[a]);return b},b.fromObject=function(a){var c,d=new b;for(c in a)a.hasOwnProperty(c)&&"function"==typeof d[c]&&d[c](a[c]);return d},b}]),angular.module("recall").provider("recall",[function(){var a={};a.adapter=null,this.setAdapter=function(b){return a.adapter=b,this},a.dirtyCheckThreshold=30,this.setDirtyCheckThreshold=function(b){return a.dirtyCheckThreshold=b,this},a.lastModifiedFieldName=null,this.setLastModifiedFieldName=function(b){return a.lastModifiedFieldName=b,this},a.deletedFieldName=null,this.setDeletedFieldName=function(b){return a.deletedFieldName=b,this},this.$get=["$injector","recallModel",function(b,c){var d={adapter:a.adapter,lastModifiedFieldName:a.lastModifiedFieldName,deletedFieldName:a.deletedFieldName,dirtyCheckThreshold:a.dirtyCheckThreshold,models:{}};return d.getModels=function(){var a,b=[];for(a in this.models)this.models.hasOwnProperty(a)&&b.push(this.models[a]);return b},d.getModel=function(a){return this.models[a]||null},d.defineModel=function(a,d){if(d=d||this.adapter,d="string"==typeof d?b.get(d):d,!d)return null;if(!a||!a.name)return null;if(this.models[a.name])return this.models[a.name];var e=new c(a);e.setLastModifiedFieldName(this.lastModifiedFieldName),e.setDeletedFieldName(this.deletedFieldName),e.setAdapter(d),e.setDirtyCheckThreshold(this.dirtyCheckThreshold);var f=e.initializeModelFields();return f?(e.initializeAssociations(),"function"!=typeof d.modelValidationHook||d.modelValidationHook(e)?(this.models[e.modelName]=e,e):null):null},d}]}]);
//# sourceMappingURL=recall.min.map