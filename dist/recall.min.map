{"version":3,"file":"recall.min.js","sources":["../src/_module.js","../src/adapterResponse.js","../src/adapters/indexedDB.adapter.js","../src/adapters/odataREST.adapter.js","../src/adapters/sync.adapter.js","../src/adapters/webSQL.adapter.js","../src/association.js","../src/entity.js","../src/localStorage.js","../src/model.js","../src/modelField.js","../src/polyfill.js","../src/predicate.js","../src/preparedQueryOptions.js","../src/recallService.js"],"names":["angular","module","factory","AdapterResponse","data","count","status","headers","config","this","OK","CREATED","ACCEPTED","NO_CONTENT","BAD_REQUEST","UNAUTHORIZED","NOT_FOUND","CONFLICT","INTERNAL_SERVER_ERROR","NOT_IMPLEMENTED","provider","providerConfig","dbName","setDbName","dbVersion","setDbVersion","pkGenerator","s4","Math","floor","random","toString","substring","setPkGenerator","dropDatabase","window","indexedDB","deleteDatabase","e","$get","$log","$q","$window","recall","db","adapter","generatePrimaryKey","migrate","i","model","field","indexName","objectStore","models","getModels","length","objectStoreNames","contains","dataSourceName","createObjectStore","keyPath","primaryKeyFieldName","fields","hasOwnProperty","unique","index","createIndex","useDatabase","theDb","onversionchange","close","error","alert","connect","dfd","defer","resolve","openRequest","open","onupgradeneeded","event","info","target","result","onsuccess","debug","onerror","reject","errorCode","promise","create","theModel","modelInstance","response","buildError","modelName","getRawModelObject","lastModifiedFieldName","Date","toISOString","then","tx","transaction","store","req","add","findOne","pk","queryOptions","includeDeleted","get","deletedFieldName","performExpand","find","filterPredicate","openCursor","results","$filter","cursor","value","resultMatchesFilters","push","promises","all","applyFilter","applyOrderBy","totalCount","applyPaging","update","extend","updateReq","put","remove","synchronize","dataToSync","hardRemove","createOrUpdate","createReq","expandHasOne","association","pathsToExpand","undefined","mappedBy","pathToExpand","join","alias","expandPath","indexOf","expandHasMany","key","filter","getOptions","split","toExpand","getAssociationByAlias","getModel","type","$expand","paths","predicate","test","a","orderBy","$orderBy","property","direction","sort","b","toLowerCase","top","$top","skip","$skip","slice","serverAPILocation","setServerAPILocation","resultsField","setResultsField","totalCountFiled","setTotalCountFiled","$http","getUrlWithOptions","url","parseOptions","post","success","method","lastSync","masterAdapter","setMaster","slaveAdapter","setSlave","$injector","localStorage","Predicate","PreparedQueryOptions","modelValidationHook","master","getMaster","slave","getSlave","preferMaster","Array","processSyncRequest","getAdapter","SyncResult","sent","returned","totalProcessed","getLastSyncTime","keys","LAST_SYNC","updateLastSyncTimeToNow","set","sendSyncRequestData","processSyncResponseData","syncRequestData","syncResponseData","totalItemsProcessed","handleError","handleComplete","greaterThanOrEqualTo","syncResponse","dbSize","setDbSize","createTable","sql","executeSql","column","name","primaryKey","notNull","openDatabase","columns","columnValues","placeholders","convertValueToSQL","transformSQLResult","dir","toUpperCase","convertValueToModel","sqlResultInstance","getSQLModelObject","obj","rows","item","Association","definition","invalid","hasOne","hasMany","as","foreignKey","prototype","recallService","expand","entity","self","Model","$entity","storedState","equals","$getPrimaryKey","existingPredicate","base","stored","Entity","object","persisted","extendFromRawObject","Object","defineProperty","lastDirtyCheck","getTime","lastDirtyState","saveInProgress","$convertAssociationsToEntities","$storeState","$model","ForeignModel","associations","associationName","$isValid","fieldIsUndefined","matchesType","isNaN","parse","validate","$save","warn","$reset","itemToSave","preSave","updateSavedState","succeeded","preUpdate","transformResult","preCreate","$remove","$isDirty","now","delta","dirtyCheckThreshold","viewValue","storedValue","prop","changedProperties","before","after","$document","storage","keyExists","addKeyModifier","modifier","registerKey","keyModifier","supportsLocalStorage","setItem","life","v","encodeURIComponent","cookie","getItem","regexp","RegExp","c","exec","decodeURIComponent","removeItem","ModelField","propagateError","modelDefinition","writable","configurable","setLastModifiedFieldName","setDeletedFieldName","setAdapter","setDirtyCheckThreshold","initializeModelFields","modelField","lastModifiedField","deletedField","modelDefinitionFields","initializeAssociations","modelDefinitionAssociations","rawObject","modelEntity","includeExpandedAssociations","applyDefaultValues","getDefaultValue","resultEntity","rawEntity","clientResponse","asPrimaryKey","fromDefinition","validateField","match","pad","number","getUTCFullYear","getUTCMonth","getUTCDate","getUTCHours","getUTCMinutes","getUTCSeconds","getUTCMilliseconds","toFixed","parser","predicates","groupOperator","setProperty","escapeValue","notEqualTo","greaterThan","lessThan","lessThanOrEqualTo","startsWith","endsWith","initialPredicate","newPredicates","joinedPredicates","concat","unshift","and","or","failOnMissingAssociation","testPredicate","parsePredicate","nested","urlString","predicateString","fromString","conditionMatcher","filters","getPredicateFromSegment","replace","buildPredicateFromMap","predicateMap","closeParenthesisIndex","openParenthesisIndex","groupString","filterIndexes","groupFilters","operator","groupPredicate","testNextLevel","lastIndexOf","Number","convertValueToType","testPredicateGroup","propertyPath","objectValue","condition","testComplexPredicate","testSimplePredicate","substr","start","end","conditionParams","getComplexPredicateFromSegment","parenPos","getSimplePredicateFromSegment","options","isPredicate","arguments","$orderby","$select","$inlineCount","enable","$inlinecount","custom","optionName","preparedQueryOptions","option","parameters","appendSeparator","fromObject","service","theModels","defineModel","fieldsValid"],"mappings":"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","sourcesContent":["angular.module('recall', []);","angular.module('recall').factory(\"recallAdapterResponse\", [\r\n    function () {\r\n\r\n        /**\r\n         * The AdapterResponse class represents a response that is coming back from an adapter. Every Adapter should\r\n         * resolve and reject with a properly formed AdapterResponse so that the Model can handle the response.\r\n         *\r\n         * @param {Object|Array|String} data The raw data from the adapter or an error message\r\n         * @param {Number} [count] The number of records affected by the action. Left null if not set\r\n         * @param {Number} [status=200] The status of the response\r\n         * @param {Object} [headers] The response headers (used by $http)\r\n         * @param {Object} [config] The configuration of the request (used by $http)\r\n         * @constructor\r\n         */\r\n        var AdapterResponse = function (data, count, status, headers, config) {\r\n            this.data = data;\r\n            this.count = (count >= 0) ? count : null;\r\n            this.status = status || AdapterResponse.OK;\r\n            this.headers = headers;\r\n            this.config = config;\r\n        };\r\n\r\n        // 2xx status codes used in OOTB adapters\r\n        AdapterResponse.OK = 200;\r\n        AdapterResponse.CREATED = 201;\r\n        AdapterResponse.ACCEPTED = 202;\r\n        AdapterResponse.NO_CONTENT = 204;\r\n\r\n        // 4xx status codes used in OOTB adapters\r\n        AdapterResponse.BAD_REQUEST = 400;\r\n        AdapterResponse.UNAUTHORIZED = 401;\r\n        AdapterResponse.NOT_FOUND = 404;\r\n        AdapterResponse.CONFLICT = 409;\r\n\r\n        // 5xx status codes used in OOTB adapters\r\n        AdapterResponse.INTERNAL_SERVER_ERROR = 500;\r\n        AdapterResponse.NOT_IMPLEMENTED = 501;\r\n\r\n        return AdapterResponse;\r\n    }\r\n]);","/**\r\n * Due to an iOS 8 bug in IndexedDB, a transaction cannot open multiple data stores at the same time: https://bugs.webkit.org/show_bug.cgi?id=136937\r\n * As a \"Fix\", transactions will only ever only open a single objectStore and multiple transactions will be used.\r\n * Impact to performance and stability is not yet known.\r\n */\r\n\r\nangular.module('recall.adapter.indexedDB', ['recall']).provider('recallIndexedDBAdapter', [\r\n    function () {\r\n\r\n        var providerConfig = {};\r\n\r\n        // Sets the name of the IndexedDB database to use\r\n        providerConfig.dbName = 'recall';\r\n        this.setDbName = function (dbName) {\r\n            providerConfig.dbName = dbName;\r\n            return this;\r\n        };\r\n\r\n        // Sets the version of the IndexedDB to use\r\n        providerConfig.dbVersion = 1;\r\n        this.setDbVersion = function (dbVersion) {\r\n            providerConfig.dbVersion = dbVersion;\r\n            return this;\r\n        };\r\n\r\n        // Sets the default function to be used as a \"GUID\" generator\r\n        providerConfig.pkGenerator = function () {\r\n            function s4() {\r\n                return Math.floor((1 + Math.random()) * 0x10000)\r\n                    .toString(16)\r\n                    .substring(1);\r\n            }\r\n\r\n            return s4() + s4() + '-' + s4() + '-' + s4() + '-' +\r\n                s4() + '-' + s4() + s4() + s4();\r\n        };\r\n        this.setPkGenerator = function (pkGenerator) {\r\n            providerConfig.pkGenerator = pkGenerator;\r\n            return this;\r\n        };\r\n\r\n        // Drops the IndexedDB database\r\n        this.dropDatabase = function () {\r\n            try {\r\n                window.indexedDB.deleteDatabase(providerConfig.dbName);\r\n            } catch (e) {\r\n                return e;\r\n            }\r\n            return true;\r\n        };\r\n\r\n        this.$get = [\r\n            '$log',\r\n            '$q',\r\n            '$window',\r\n            'recall',\r\n            'recallAdapterResponse',\r\n\r\n            function ($log, $q, $window, recall, AdapterResponse) {\r\n\r\n                var adapter = {};\r\n                var db;\r\n\r\n                var generatePrimaryKey = providerConfig.pkGenerator;\r\n\r\n                // Handles version differences in the database and initializes or migrates the db\r\n                var migrate = function (db) {\r\n                    var i;\r\n                    var model;\r\n                    var field;\r\n                    var indexName;\r\n                    var objectStore;\r\n                    var models = recall.getModels();\r\n                    for (i = 0; i < models.length; i++) {\r\n                        model = models[i];\r\n\r\n                        if (!db.objectStoreNames.contains(model.dataSourceName)) {\r\n                            objectStore = db.createObjectStore(model.dataSourceName, { keyPath: model.primaryKeyFieldName });\r\n                            for (field in model.fields) {\r\n                                if (model.fields.hasOwnProperty(field)) {\r\n                                    if (model.fields[field].unique === true || model.fields[field].index !== false) {\r\n                                        indexName = (model.fields[field].index === true) ? field : model.fields[field].index;\r\n                                        objectStore.createIndex(field, indexName, { unique: model.fields[field].unique });\r\n                                    }\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n                };\r\n\r\n                // Sets the database to use in the adapter\r\n                var useDatabase = function (theDb) {\r\n                    db = theDb;\r\n\r\n                    // Handler for when the DB version is changed in another tab\r\n                    db.onversionchange = function () {\r\n                        db.close();\r\n                        $log.error('IndexedDBAdapter: DB version changed in a different window');\r\n                        alert(\"A new version of this page is ready. Please reload!\");\r\n                    };\r\n                };\r\n\r\n                // Connects to the database\r\n                var connect = function () {\r\n                    var dfd = $q.defer();\r\n\r\n                    if (db) {\r\n                        dfd.resolve(db);\r\n                    } else {\r\n                        var openRequest = $window.indexedDB.open(providerConfig.dbName, providerConfig.dbVersion);\r\n\r\n                        openRequest.onupgradeneeded = function (event) {\r\n                            $log.info('IndexedDBAdapter: Migrating...', event);\r\n                            useDatabase(event.target.result);\r\n                            migrate(event.target.result);\r\n                        };\r\n\r\n                        openRequest.onsuccess = function (event) {\r\n                            $log.debug('IndexedDBAdapter: Connection Success', event);\r\n                            useDatabase(event.target.result);\r\n                            dfd.resolve(db);\r\n                        };\r\n\r\n                        openRequest.onerror = function (event) {\r\n                            $log.error('IndexedDBAdapter: Connection Error', event);\r\n                            dfd.reject(event.target.errorCode);\r\n                        };\r\n                    }\r\n\r\n                    return dfd.promise;\r\n                };\r\n\r\n                // TODO: Cascade Create: Cannot do proper cascades until iOS fixes the bug in IndexedDB where a transaction cannot open multiple stores\r\n                /**\r\n                 * Creates a new Entity\r\n                 * @param {Object} theModel The model of the entity to create\r\n                 * @param {Object} modelInstance The entity to create\r\n                 * @returns {promise} Resolved with an AdapterResponse\r\n                 */\r\n                adapter.create = function (theModel, modelInstance) {\r\n                    var dfd = $q.defer();\r\n                    var response;\r\n\r\n                    var buildError = function (e) {\r\n                        response = new AdapterResponse(e, 0, AdapterResponse.INTERNAL_SERVER_ERROR);\r\n                        $log.error('IndexedDBAdapter: Create ' + theModel.modelName, response, modelInstance);\r\n                        return response;\r\n                    };\r\n\r\n                    modelInstance[theModel.primaryKeyFieldName] = generatePrimaryKey();\r\n                    modelInstance = theModel.getRawModelObject(modelInstance, false);\r\n\r\n                    // TODO: Store all dates in ISO format\r\n                    modelInstance[theModel.lastModifiedFieldName] = new Date().toISOString();\r\n\r\n                    connect().then(function () {\r\n                        var tx = db.transaction([theModel.dataSourceName], \"readwrite\");\r\n                        var store = tx.objectStore(theModel.dataSourceName);\r\n                        var req = store.add(modelInstance);\r\n                        req.onsuccess = function () {\r\n                            response = new AdapterResponse(modelInstance, 1, AdapterResponse.CREATED);\r\n                            $log.debug('IndexedDBAdapter: Create ' + theModel.modelName, response);\r\n                            dfd.resolve(response);\r\n                        };\r\n                        req.onerror = function () {\r\n                            dfd.reject(buildError(this.error));\r\n                        };\r\n                    }, function (e) {\r\n                        dfd.reject(buildError(e));\r\n                    });\r\n\r\n                    return dfd.promise;\r\n                };\r\n\r\n                /**\r\n                 * Finds a single entity given a primary key\r\n                 * @param {Object} theModel The model of the entity to find\r\n                 * @param {String|Number} pk The primary key of the entity to find\r\n                 * @param {PreparedQueryOptions} [queryOptions] The query options to use for $expand\r\n                 * @param {Boolean} [includeDeleted=false] If true, includes soft-deleted entities\r\n                 * @returns {promise} Resolved with an AdapterResponse\r\n                 */\r\n                adapter.findOne = function (theModel, pk, queryOptions, includeDeleted) {\r\n                    var dfd = $q.defer();\r\n                    var response;\r\n\r\n                    var buildError = function (e, status) {\r\n                        response = new AdapterResponse(e, 0, status || AdapterResponse.INTERNAL_SERVER_ERROR);\r\n                        $log.error('IndexedDBAdapter: FindOne ' + theModel.modelName, response, pk, queryOptions);\r\n                        return response;\r\n                    };\r\n\r\n                    connect().then(function () {\r\n                        var tx = db.transaction([theModel.dataSourceName]);\r\n                        var store = tx.objectStore(theModel.dataSourceName);\r\n                        var req = store.get(pk);\r\n\r\n                        // TODO: Apply Select\r\n                        req.onsuccess = function () {\r\n                            if (req.result && (includeDeleted || !req.result[theModel.deletedFieldName])) {\r\n                                performExpand(req.result, theModel, queryOptions, db).then(function () {\r\n                                    response = new AdapterResponse(req.result, 1);\r\n                                    $log.debug('IndexedDBAdapter: FindOne ' + theModel.modelName, response, pk, queryOptions);\r\n                                    dfd.resolve(response);\r\n                                }, function (e) {\r\n                                    dfd.reject(buildError(e));\r\n                                });\r\n                            } else {\r\n                                dfd.reject(buildError('Not Found', AdapterResponse.NOT_FOUND));\r\n                            }\r\n                        };\r\n                        req.onerror = function () {\r\n                            dfd.reject(buildError(this.error));\r\n                        };\r\n                    }, function (e) {\r\n                        dfd.reject(buildError(e));\r\n                    });\r\n                    return dfd.promise;\r\n                };\r\n\r\n                /**\r\n                 * Finds a set of Model entities\r\n                 * @param {Object} theModel The model of the entities to find\r\n                 * @param {PreparedQueryOptions} [queryOptions] The query options to use\r\n                 * @param {Boolean} [includeDeleted=false] If true, includes soft-deleted entities\r\n                 * @returns {promise} Resolved with an AdapterResponse\r\n                 */\r\n                adapter.find = function (theModel, queryOptions, includeDeleted) {\r\n                    var dfd = $q.defer();\r\n                    var response;\r\n\r\n                    var buildError = function (e) {\r\n                        response = new AdapterResponse(e, 0, AdapterResponse.INTERNAL_SERVER_ERROR);\r\n                        $log.error('IndexedDBAdapter: Find ' + theModel.modelName, response, queryOptions);\r\n                        return response;\r\n                    };\r\n\r\n                    connect().then(function () {\r\n                        // TODO: Filter using an index if possible\r\n                        var tx = db.transaction([theModel.dataSourceName]);\r\n                        var store = tx.objectStore(theModel.dataSourceName);\r\n                        var req = store.openCursor();\r\n                        var results = [];\r\n                        var filterPredicate;\r\n\r\n                        if (queryOptions && queryOptions.$filter()) {\r\n                            filterPredicate = queryOptions.$filter();\r\n                        }\r\n\r\n                        // TODO: Apply Select\r\n                        req.onsuccess = function (event) {\r\n                            var cursor = event.target.result;\r\n                            if (cursor) {\r\n                                if (includeDeleted || !cursor.value[theModel.deletedFieldName]) {\r\n                                    if (filterPredicate) {\r\n                                        if (resultMatchesFilters(cursor.value, filterPredicate)) {\r\n                                            results.push(cursor.value);\r\n                                        }\r\n                                    } else {\r\n                                        results.push(cursor.value);\r\n                                    }\r\n                                }\r\n                                cursor.continue();\r\n                            } else {\r\n                                var i;\r\n                                var promises = [];\r\n                                for (i = 0; i < results.length; i++) {\r\n                                    promises.push(performExpand(results[i], theModel, queryOptions, db));\r\n                                }\r\n                                $q.all(promises).then(function () {\r\n                                    results = applyFilter(results, filterPredicate);\r\n                                    results = applyOrderBy(results, queryOptions);\r\n\r\n                                    var totalCount = results.length;\r\n\r\n                                    // TODO: This is not very efficient but indexedDB does not seem to support a better way with filters and ordering\r\n                                    results = applyPaging(results, queryOptions);\r\n                                    response = new AdapterResponse(results, totalCount);\r\n\r\n                                    $log.debug('IndexedDBAdapter: Find ' + theModel.modelName, response, queryOptions);\r\n                                    dfd.resolve(response);\r\n                                }, function (e) {\r\n                                    dfd.reject(buildError(e));\r\n                                });\r\n                            }\r\n                        };\r\n                        req.onerror = function () {\r\n                            dfd.reject(buildError(this.error));\r\n                        };\r\n                    }, function (e) {\r\n                        dfd.reject(buildError(e));\r\n                    });\r\n                    return dfd.promise;\r\n                };\r\n\r\n                // TODO: Cascade Update: Cannot do proper cascades until iOS fixes the bug in IndexedDB where a transaction cannot open multiple stores\r\n                /**\r\n                 * Updates a Model entity given the primary key of the entity\r\n                 * @param {Object} theModel The model of the entity to update\r\n                 * @param {String|Number} pk The primary key of the entity\r\n                 * @param {Object} modelInstance The entity to update\r\n                 * @param {Boolean} [includeDeleted=false] If true, includes soft-deleted entities\r\n                 * @returns {promise} Resolved with an AdapterResponse\r\n                 */\r\n                adapter.update = function (theModel, pk, modelInstance, includeDeleted) {\r\n                    var dfd = $q.defer();\r\n                    var response;\r\n\r\n                    var buildError = function (e) {\r\n                        response = new AdapterResponse(e, 0, AdapterResponse.INTERNAL_SERVER_ERROR);\r\n                        $log.error('IndexedDBAdapter: Update ' + theModel.modelName, response, modelInstance);\r\n                        return response;\r\n                    };\r\n\r\n                    connect().then(function () {\r\n                        var tx = db.transaction([theModel.dataSourceName], \"readwrite\");\r\n                        var store = tx.objectStore(theModel.dataSourceName);\r\n                        var req = store.get(pk);\r\n                        req.onsuccess = function () {\r\n                            if (req.result && (includeDeleted || !req.result[theModel.deletedFieldName])) {\r\n                                var result = req.result;\r\n                                delete modelInstance[theModel.primaryKeyFieldName];\r\n                                angular.extend(result, modelInstance);\r\n\r\n                                // TODO: Convert all dates to ISO Format\r\n                                result[theModel.lastModifiedFieldName] = new Date().toISOString();\r\n                                result = theModel.getRawModelObject(result, false);\r\n\r\n                                var updateReq = store.put(result);\r\n                                updateReq.onsuccess = function () {\r\n                                    response = new AdapterResponse(result, 1);\r\n                                    $log.debug('IndexedDBAdapter: Update ' + theModel.modelName, response, modelInstance);\r\n                                    dfd.resolve(response);\r\n                                };\r\n                                updateReq.onerror = function () {\r\n                                    dfd.reject(buildError(this.error));\r\n                                };\r\n                            } else {\r\n                                dfd.reject(buildError('Not Found', AdapterResponse.NOT_FOUND));\r\n                            }\r\n                        };\r\n                        req.onerror = function () {\r\n                            dfd.reject(buildError(this.error));\r\n                        };\r\n\r\n                    }, function (e) {\r\n                        dfd.reject(buildError(e));\r\n                    });\r\n                    return dfd.promise;\r\n                };\r\n\r\n                // TODO: Cascade Delete: Cannot do proper cascades until iOS fixes the bug in IndexedDB where a transaction cannot open multiple stores\r\n                /**\r\n                 * Removes an Entity given the primary key of the entity to remove\r\n                 * @param {Object} theModel The model of the entity to remove\r\n                 * @param {String|Number} pk The primary key of the entity\r\n                 * @returns {promise} Resolved with an AdapterResponse\r\n                 */\r\n                adapter.remove = function (theModel, pk) {\r\n                    var dfd = $q.defer();\r\n                    var response;\r\n\r\n                    var buildError = function (e) {\r\n                        response = new AdapterResponse(e, 0, AdapterResponse.INTERNAL_SERVER_ERROR);\r\n                        $log.error('IndexedDBAdapter: Remove ' + theModel.modelName, response);\r\n                        return response;\r\n                    };\r\n\r\n                    connect().then(function () {\r\n                        var tx = db.transaction([theModel.dataSourceName], \"readwrite\");\r\n                        var store = tx.objectStore(theModel.dataSourceName);\r\n                        var req = store.get(pk);\r\n                        req.onsuccess = function () {\r\n                            if (req.result && !req.result[theModel.deletedFieldName]) {\r\n                                var result = req.result;\r\n                                result[theModel.deletedFieldName] = true;\r\n                                result[theModel.lastModifiedFieldName] = new Date().toISOString();\r\n                                var updateReq = store.put(result);\r\n                                updateReq.onsuccess = function () {\r\n                                    response = new AdapterResponse(null, 1, AdapterResponse.NO_CONTENT);\r\n                                    $log.debug('IndexedDBAdapter: Remove ' + theModel.modelName, response);\r\n                                    dfd.resolve(response);\r\n                                };\r\n                                updateReq.onerror = function () {\r\n                                    dfd.reject(buildError(this.error));\r\n                                };\r\n                            } else {\r\n                                dfd.reject(buildError('Not Found', AdapterResponse.NOT_FOUND));\r\n                            }\r\n                        };\r\n                        req.onerror = function () {\r\n                            dfd.reject(buildError(this.error));\r\n                        };\r\n                    }, function (e) {\r\n                        dfd.reject(buildError(e));\r\n                    });\r\n                    return dfd.promise;\r\n                };\r\n\r\n                /**\r\n                 * Takes an Array of entities and creates/updates/deletes them\r\n                 * @param {Object} theModel The model of the entities to synchronize\r\n                 * @param {Array} dataToSync An array of objects to create/update/delete\r\n                 * @returns {promise} Resolved with an AdapterResponse\r\n                 */\r\n                adapter.synchronize = function (theModel, dataToSync) {\r\n                    var dfd = $q.defer();\r\n                    var response;\r\n\r\n                    var buildError = function (e) {\r\n                        response = new AdapterResponse(e, 0, AdapterResponse.INTERNAL_SERVER_ERROR);\r\n                        $log.error('IndexedDBAdapter: Synchronize ' + theModel.modelName, response, dataToSync);\r\n                        return response;\r\n                    };\r\n\r\n                    connect().then(function () {\r\n                        var tx = db.transaction([theModel.dataSourceName], \"readwrite\");\r\n                        var objectStore = tx.objectStore(theModel.dataSourceName);\r\n\r\n                        var i;\r\n                        var promises = [];\r\n                        for (i = 0; i < dataToSync.length; i++) {\r\n                            if (dataToSync[i][theModel.deletedFieldName]) {\r\n                                promises.push(hardRemove(theModel, objectStore, dataToSync[i][theModel.primaryKeyFieldName]));\r\n                            } else {\r\n                                promises.push(createOrUpdate(theModel, objectStore, dataToSync[i]));\r\n                            }\r\n                        }\r\n\r\n                        $q.all(promises).then(function (results) {\r\n                            response = new AdapterResponse(results, results.length, AdapterResponse.OK);\r\n                            $log.debug('IndexedDBAdapter: Synchronize ' + theModel.modelName, response, dataToSync);\r\n                            dfd.resolve(response);\r\n                        }, function (e) {\r\n                            dfd.reject(buildError(e));\r\n                        });\r\n                    }, function (e) {\r\n                        dfd.reject(buildError(e));\r\n                    });\r\n                    return dfd.promise;\r\n                };\r\n\r\n                // Creates a new Entity if not found or updates the existing one. Used in synchronization.\r\n                var createOrUpdate = function (theModel, objectStore, modelInstance) {\r\n                    var dfd = $q.defer();\r\n\r\n                    var req = objectStore.get(modelInstance[theModel.primaryKeyFieldName]);\r\n                    req.onsuccess = function () {\r\n                        var result = req.result;\r\n                        if (result) {\r\n                            angular.extend(result, modelInstance);\r\n                            result = theModel.getRawModelObject(result, false);\r\n\r\n                            var updateReq = objectStore.put(result);\r\n                            updateReq.onsuccess = function () {\r\n                                dfd.resolve(result);\r\n                            };\r\n                            updateReq.onerror = function () {\r\n                                dfd.reject(this.error);\r\n                            };\r\n                        } else {\r\n                            var createReq = objectStore.add(modelInstance);\r\n                            createReq.onsuccess = function () {\r\n                                dfd.resolve(modelInstance);\r\n                            };\r\n                            createReq.onerror = function () {\r\n                                dfd.reject(this.error);\r\n                            };\r\n                        }\r\n                    };\r\n                    req.onerror = function () {\r\n                        dfd.reject(this.error);\r\n                    };\r\n\r\n                    return dfd.promise;\r\n                };\r\n\r\n                // Hard deletes an Entity. Used in synchronization.\r\n                var hardRemove = function (theModel, objectStore, pk) {\r\n                    var dfd = $q.defer();\r\n\r\n                    var req = objectStore.delete(pk);\r\n                    req.onsuccess = function () {\r\n                        dfd.resolve();\r\n                    };\r\n                    req.onerror = function () {\r\n                        dfd.reject(this.error);\r\n                    };\r\n\r\n                    return dfd.promise;\r\n                };\r\n\r\n                // Expands a has one model association\r\n                var expandHasOne = function (model, result, association, db, pathsToExpand) {\r\n                    var dfd = $q.defer();\r\n\r\n                    if (result[association.mappedBy] === undefined) {\r\n                        result[association.mappedBy] = null;\r\n                        dfd.resolve();\r\n                        return dfd.promise;\r\n                    }\r\n\r\n                    var tx = db.transaction([model.dataSourceName]);\r\n                    var store = tx.objectStore(model.dataSourceName);\r\n                    var pathToExpand = pathsToExpand.join('.');\r\n                    var req = store.get(result[association.mappedBy]);\r\n\r\n                    req.onsuccess = function () {\r\n                        if (req.result && !req.result[model.deletedFieldName]) {\r\n                            result[association.alias] = req.result;\r\n                            if (pathsToExpand.length > 1) {\r\n                                expandPath(req.result, model, pathToExpand.substring(pathToExpand.indexOf('.') + 1), db).then(function () {\r\n                                    dfd.resolve();\r\n                                }, function (e) {\r\n                                    dfd.reject(e);\r\n                                });\r\n                            } else {\r\n                                dfd.resolve();\r\n                            }\r\n                        } else {\r\n                            result[association.alias] = null;\r\n                            dfd.resolve();\r\n                        }\r\n                    };\r\n                    req.onerror = function () {\r\n                        dfd.reject(this.error);\r\n                    };\r\n\r\n                    return dfd.promise;\r\n                };\r\n\r\n                // Expands a has many model association\r\n                var expandHasMany = function (model, result, association, db, pathsToExpand) {\r\n                    var dfd = $q.defer();\r\n                    var tx = db.transaction([model.dataSourceName]);\r\n                    var store = tx.objectStore(model.dataSourceName);\r\n                    var pathToExpand = pathsToExpand.join('.');\r\n                    var index = store.index(association.mappedBy);\r\n                    var req = index.openCursor();\r\n                    var results = [];\r\n\r\n                    req.onsuccess = function (event) {\r\n                        var cursor = event.target.result;\r\n                        if (cursor) {\r\n                            if (!cursor.value[model.deletedFieldName] && cursor.key === result[model.primaryKeyFieldName]) {\r\n                                results.push(cursor.value);\r\n                            }\r\n                            cursor.continue();\r\n                        } else {\r\n\r\n                            var filter = association.getOptions(result).$filter();\r\n                            if (filter) {\r\n                                results = applyFilter(results, filter);\r\n                            }\r\n\r\n                            result[association.alias] = results;\r\n                            if (pathsToExpand.length > 1) {\r\n                                var i;\r\n                                var promises = [];\r\n                                for (i = 0; i < results.length; i++) {\r\n                                    promises.push(expandPath(results[i], model, pathToExpand.substring(pathToExpand.indexOf('.') + 1), db));\r\n                                }\r\n                                $q.all(promises).then(function () {\r\n                                    dfd.resolve();\r\n                                }, function (e) {\r\n                                    dfd.reject(e);\r\n                                });\r\n                            } else {\r\n                                dfd.resolve();\r\n                            }\r\n                        }\r\n                    };\r\n                    req.onerror = function () {\r\n                        dfd.reject(this.error);\r\n                    };\r\n\r\n                    return dfd.promise;\r\n                };\r\n\r\n                // Expands a Model association given an expand path\r\n                // Recursive\r\n                var expandPath = function (result, theModel, pathToExpand, db) {\r\n                    var pathsToExpand = pathToExpand.split('.');\r\n                    var toExpand = pathsToExpand[0];\r\n\r\n                    if (toExpand) {\r\n                        var association = theModel.getAssociationByAlias(toExpand);\r\n                        var model = association.getModel();\r\n                        if (association && model) {\r\n                            if (association.type === 'hasOne') {\r\n                                return expandHasOne(model, result, association, db, pathsToExpand);\r\n                            } else if (association.type === 'hasMany') {\r\n                                return expandHasMany(model, result, association, db, pathsToExpand);\r\n                            }\r\n                        }\r\n                    }\r\n\r\n                    // There is nothing left to expand, just resolve.\r\n                    var dfd = $q.defer();\r\n                    dfd.resolve();\r\n                    return dfd.promise;\r\n                };\r\n\r\n                // Expands all Model associations defined in the query options $expand clause\r\n                var performExpand = function (result, theModel, queryOptions, db) {\r\n                    var dfd = $q.defer();\r\n                    var $expand;\r\n                    var promises = [];\r\n\r\n                    if (queryOptions) {\r\n                        $expand = queryOptions.$expand();\r\n                    }\r\n                    if ($expand) {\r\n                        var paths = $expand.split(',');\r\n                        var i;\r\n                        for (i = 0; i < paths.length; i++) {\r\n                            promises.push(expandPath(result, theModel, paths[i], db));\r\n                        }\r\n                        $q.all(promises).then(function () {\r\n                            dfd.resolve();\r\n                        }, function (e) {\r\n                            $log.error('IndexedDBAdapter: PerformExpand', e, $expand, result);\r\n                            dfd.reject(e);\r\n                        });\r\n                    } else {\r\n                        dfd.resolve();\r\n                    }\r\n\r\n                    return dfd.promise;\r\n                };\r\n\r\n                // Checks if a result matches a predicate filter\r\n                var resultMatchesFilters = function (result, predicate) {\r\n                    return predicate.test(result);\r\n                };\r\n\r\n                // Applies a filter predicate to a set of results and returns an array of the matching results\r\n                var applyFilter = function (results, filterPredicate) {\r\n                    if (filterPredicate && results) {\r\n                        results = results.filter(function (a) {\r\n                            return resultMatchesFilters(a, filterPredicate);\r\n                        });\r\n                    }\r\n                    return results;\r\n                };\r\n\r\n                // Sorts the data given an $orderBy clause in query options\r\n                var applyOrderBy = function (results, queryOptions) {\r\n                    if (!queryOptions) {\r\n                        return results;\r\n                    }\r\n                    var orderBy = queryOptions.$orderBy();\r\n                    if (orderBy) {\r\n                        var property = orderBy.split(' ')[0];\r\n                        var direction = orderBy.split(' ')[1] || \"\";\r\n                        results.sort(function (a, b) {\r\n                            if (a[property] > b[property]) {\r\n                                return (direction.toLowerCase() === 'desc') ? -1 : 1;\r\n                            }\r\n                            if (b[property] > a[property]) {\r\n                                return (direction.toLowerCase() === 'desc') ? 1 : -1;\r\n                            }\r\n                            return 0;\r\n                        });\r\n                    }\r\n                    return results;\r\n                };\r\n\r\n                // Applies paging to a set of results and returns a sliced array of results\r\n                var applyPaging = function (results, queryOptions) {\r\n                    if (!queryOptions) {\r\n                        return results;\r\n                    }\r\n                    var top = queryOptions.$top();\r\n                    var skip = queryOptions.$skip();\r\n                    if (top > 0 && skip >= 0) {\r\n                        results = results.slice(skip, skip + top);\r\n                    }\r\n                    return results;\r\n                };\r\n\r\n                return adapter;\r\n            }\r\n        ];\r\n    }\r\n]);","angular.module('recall.adapter.oDataREST', ['recall']).provider('recallODataRESTAdapter', [\r\n    function () {\r\n\r\n        var providerConfig = {};\r\n\r\n        // Sets the location of the server api endpoint\r\n        providerConfig.serverAPILocation = \"/api/\";\r\n        this.setServerAPILocation = function (serverAPILocation) {\r\n            if (serverAPILocation.substring(serverAPILocation.length - 1) !== \"/\") {\r\n                serverAPILocation += '/';\r\n            }\r\n            providerConfig.serverAPILocation = serverAPILocation;\r\n            return this;\r\n        };\r\n\r\n        // Sets the name of the results property in the server's response\r\n        providerConfig.resultsField = \"results\";\r\n        this.setResultsField = function (resultsField) {\r\n            providerConfig.resultsField = resultsField;\r\n            return this;\r\n        };\r\n\r\n        // Sets the name of the total count property in the server's response\r\n        providerConfig.totalCountFiled = \"totalCount\";\r\n        this.setTotalCountFiled = function (totalCountFiled) {\r\n            providerConfig.totalCountFiled = totalCountFiled;\r\n            return this;\r\n        };\r\n\r\n        this.$get = [\r\n            '$http',\r\n            '$log',\r\n            '$q',\r\n            'recallAdapterResponse',\r\n\r\n            function ($http,\r\n                      $log,\r\n                      $q,\r\n                      AdapterResponse) {\r\n\r\n                var adapter = {};\r\n\r\n                // Appends the query options to the URL\r\n                var getUrlWithOptions = function (url, queryOptions) {\r\n                    url += queryOptions ? queryOptions.parseOptions() : \"\";\r\n                    return url;\r\n                };\r\n\r\n                /**\r\n                 * Creates a new Entity\r\n                 * @param {Object} theModel The model of the entity to create\r\n                 * @param {Object} modelInstance The entity to create\r\n                 * @returns {promise} Resolved with an AdapterResponse\r\n                 */\r\n                adapter.create = function (theModel, modelInstance) {\r\n                    var dfd = $q.defer();\r\n                    var response;\r\n\r\n                    var url = providerConfig.serverAPILocation + theModel.dataSourceName;\r\n\r\n                    $http.post(url, modelInstance)\r\n                        .success(function (data, status, headers, config) {\r\n                            response = new AdapterResponse(data, 1, status, headers, config);\r\n                            $log.debug('ODataRESTAdapter: Create ' + theModel.modelName, response);\r\n                            dfd.resolve(response);\r\n                        })\r\n                        .error(function (error, status, headers, config) {\r\n                            response = new AdapterResponse(error, 0, status, headers, config);\r\n                            $log.error('ODataRESTAdapter: Create ' + theModel.modelName, response, modelInstance);\r\n                            dfd.reject(response);\r\n                        });\r\n\r\n                    return dfd.promise;\r\n                };\r\n\r\n                /**\r\n                 * Finds a single entity given a primary key\r\n                 * @param {Object} theModel The model of the entity to find\r\n                 * @param {String|Number} pk The primary key of the entity to find\r\n                 * @param {PreparedQueryOptions} [queryOptions] The query options to use for $expand\r\n                 * @returns {promise} Resolved with an AdapterResponse\r\n                 */\r\n                adapter.findOne = function (theModel, pk, queryOptions) {\r\n                    var dfd = $q.defer();\r\n                    var response;\r\n\r\n                    if (!pk) {\r\n                        response = new AdapterResponse(\"No Primary Key was supplied\", 0, AdapterResponse.BAD_REQUEST);\r\n                        $log.error('ODataRESTAdapter: FindOne ' + theModel.modelName, response, pk, queryOptions);\r\n                        return $q.reject(response);\r\n                    }\r\n\r\n                    var url = getUrlWithOptions(providerConfig.serverAPILocation + theModel.dataSourceName + \"/\" + pk, queryOptions);\r\n\r\n                    $http.get(url)\r\n                        .success(function (data, status, headers, config) {\r\n                            response = new AdapterResponse(data, 1, status, headers, config);\r\n                            $log.debug('ODataRESTAdapter: FindOne ' + theModel.modelName, response, pk, queryOptions);\r\n                            dfd.resolve(response);\r\n                        })\r\n                        .error(function (error, status, headers, config) {\r\n                            response = new AdapterResponse(error, 0, status, headers, config);\r\n                            $log.error('ODataRESTAdapter: FindOne ' + theModel.modelName, response, pk, queryOptions);\r\n                            dfd.reject(response);\r\n                        });\r\n\r\n                    return dfd.promise;\r\n                };\r\n\r\n                /**\r\n                 * Finds a set of Model entities\r\n                 * @param {Object} theModel The model of the entities to find\r\n                 * @param {PreparedQueryOptions} [queryOptions] The query options to use\r\n                 * @returns {promise} Resolved with an AdapterResponse\r\n                 */\r\n                adapter.find = function (theModel, queryOptions) {\r\n                    var dfd = $q.defer();\r\n                    var response;\r\n\r\n                    var url = getUrlWithOptions(providerConfig.serverAPILocation + theModel.dataSourceName, queryOptions);\r\n\r\n                    $http.get(url)\r\n                        .success(function (data, status, headers, config) {\r\n                            var results = data;\r\n                            var totalCount;\r\n\r\n                            if (providerConfig.resultsField) {\r\n                                results = data[providerConfig.resultsField];\r\n                                if (providerConfig.totalCountFiled && data[providerConfig.totalCountFiled]) {\r\n                                    totalCount = data[providerConfig.totalCountFiled];\r\n                                }\r\n                            }\r\n\r\n                            response = new AdapterResponse(results, totalCount, status, headers, config);\r\n                            $log.debug('ODataRESTAdapter: Find ' + theModel.modelName, response, queryOptions);\r\n                            dfd.resolve(response);\r\n                        })\r\n                        .error(function (error, status, headers, config) {\r\n                            response = new AdapterResponse(error, 0, status, headers, config);\r\n                            $log.error('ODataRESTAdapter: Find ' + theModel.modelName, response, queryOptions);\r\n                            dfd.reject(response);\r\n                        });\r\n\r\n                    return dfd.promise;\r\n                };\r\n\r\n                /**\r\n                 * Updates a Model entity given the primary key of the entity\r\n                 * @param {Object} theModel The model of the entity to update\r\n                 * @param {String|Number} pk The primary key of the entity\r\n                 * @param {Object} modelInstance The entity to update\r\n                 * @returns {promise} Resolved with an AdapterResponse\r\n                 */\r\n                adapter.update = function (theModel, pk, modelInstance) {\r\n                    var dfd = $q.defer();\r\n                    var response;\r\n\r\n                    if (!pk) {\r\n                        response = new AdapterResponse(\"No Primary Key was supplied\", 0, AdapterResponse.BAD_REQUEST);\r\n                        $log.error('ODataRESTAdapter: Update ' + theModel.modelName, response, modelInstance);\r\n                        return $q.reject(response);\r\n                    }\r\n\r\n                    var url = providerConfig.serverAPILocation + theModel.dataSourceName + \"/\" + pk;\r\n\r\n                    $http.put(url, modelInstance)\r\n                        .success(function (data, status, headers, config) {\r\n                            response = new AdapterResponse(data, 1, status, headers, config);\r\n                            $log.debug('ODataRESTAdapter: Update ' + theModel.modelName, response, modelInstance);\r\n                            dfd.resolve(response);\r\n                        })\r\n                        .error(function (error, status, headers, config) {\r\n                            response = new AdapterResponse(error, 0, status, headers, config);\r\n                            $log.error('ODataRESTAdapter: Update ' + theModel.modelName, response, modelInstance);\r\n                            dfd.reject(response);\r\n                        });\r\n\r\n                    return dfd.promise;\r\n                };\r\n\r\n                /**\r\n                 * Removes an Entity given the primary key of the entity to remove\r\n                 * @param {Object} theModel The model of the entity to remove\r\n                 * @param {String|Number} pk The primary key of the entity\r\n                 * @returns {promise} Resolved with an AdapterResponse\r\n                 */\r\n                adapter.remove = function (theModel, pk) {\r\n                    var dfd = $q.defer();\r\n                    var response;\r\n\r\n                    if (!pk) {\r\n                        response = new AdapterResponse(\"No Primary Key was supplied\", 0, AdapterResponse.BAD_REQUEST);\r\n                        $log.error('ODataRESTAdapter: Remove ' + theModel.modelName, response, pk);\r\n                        return $q.reject(response);\r\n                    }\r\n\r\n                    var url = providerConfig.serverAPILocation + theModel.dataSourceName + \"/\" + pk;\r\n\r\n                    $http({method: 'DELETE', url: url})\r\n                        .success(function (data, status, headers, config) {\r\n                            response = new AdapterResponse(data, 1, status, headers, config);\r\n                            $log.debug('ODataRESTAdapter: Remove ' + theModel.modelName, response, pk);\r\n                            dfd.resolve(response);\r\n                        })\r\n                        .error(function (error, status, headers, config) {\r\n                            response = new AdapterResponse(error, 0, status, headers, config);\r\n                            $log.error('ODataRESTAdapter: Remove ' + theModel.modelName, response, pk);\r\n                            dfd.reject(response);\r\n                        });\r\n\r\n                    return dfd.promise;\r\n                };\r\n\r\n                /**\r\n                 * Takes an Array of entities and creates/updates/deletes them\r\n                 * @param {Object} theModel The model of the entities to synchronize\r\n                 * @param {Array} dataToSync An array of objects to create/update/delete\r\n                 * @param {String} lastSync An ISO Date String representing the last sync\r\n                 * @returns {promise} Resolved with an AdapterResponse\r\n                 */\r\n                adapter.synchronize = function (theModel, dataToSync, lastSync) {\r\n                    var dfd = $q.defer();\r\n                    var response;\r\n\r\n                    var url = providerConfig.serverAPILocation + theModel.dataSourceName;\r\n\r\n                    $http.put(url, {data: dataToSync, lastSync: lastSync})\r\n                        .success(function (data, status, headers, config) {\r\n                            var results = data;\r\n                            var totalCount;\r\n\r\n                            if (providerConfig.resultsField) {\r\n                                results = data[providerConfig.resultsField];\r\n                                if (providerConfig.totalCountFiled && data[providerConfig.totalCountFiled]) {\r\n                                    totalCount = data[providerConfig.totalCountFiled];\r\n                                }\r\n                            }\r\n\r\n                            response = new AdapterResponse(results, totalCount, status, headers, config);\r\n                            $log.debug('ODataRESTAdapter: Synchronize ' + theModel.modelName, response, dataToSync);\r\n                            dfd.resolve(response);\r\n                        })\r\n                        .error(function (error, status, headers, config) {\r\n                            response = new AdapterResponse(error, 0, status, headers, config);\r\n                            $log.error('ODataRESTAdapter: Synchronize ' + theModel.modelName, response, dataToSync);\r\n                            dfd.reject(response);\r\n                        });\r\n\r\n                    return dfd.promise;\r\n                };\r\n\r\n                return adapter;\r\n            }\r\n        ];\r\n    }\r\n]);","angular.module('recall.adapter.sync', ['recall']).provider('recallSyncAdapter', [\r\n    function () {\r\n\r\n        var providerConfig = {};\r\n\r\n        // Sets the master adapter\r\n        providerConfig.masterAdapter = \"\";\r\n        this.setMaster = function (masterAdapter) {\r\n            providerConfig.masterAdapter = masterAdapter;\r\n            return this;\r\n        };\r\n\r\n        // Sets the slave adapter\r\n        providerConfig.slaveAdapter = \"\";\r\n        this.setSlave = function (slaveAdapter) {\r\n            providerConfig.slaveAdapter = slaveAdapter;\r\n            return this;\r\n        };\r\n\r\n        this.$get = [\r\n            '$injector',\r\n            '$log',\r\n            '$q',\r\n            'recallAdapterResponse',\r\n            'recallLocalStorage',\r\n            'recallPredicate',\r\n            'recallPreparedQueryOptions',\r\n\r\n            function ($injector,\r\n                      $log,\r\n                      $q,\r\n                      AdapterResponse,\r\n                      localStorage,\r\n                      Predicate,\r\n                      PreparedQueryOptions) {\r\n\r\n                var adapter = {};\r\n\r\n                /**\r\n                 * Validates the Model during creation\r\n                 * @param {Object} theModel\r\n                 * @returns {Boolean} True if the model passes validation\r\n                 */\r\n                adapter.modelValidationHook = function (theModel) {\r\n                    var master = getMaster();\r\n                    var slave = getSlave();\r\n\r\n                    if (!master) {\r\n                        $log.error('SyncAdapter: Master Adapter not Set', this, theModel);\r\n                        return false;\r\n                    }\r\n                    if (!slave) {\r\n                        $log.error('SyncAdapter: Slave Adapter not Set', this, theModel);\r\n                        return false;\r\n                    }\r\n\r\n                    if (typeof master.synchronize !== 'function') {\r\n                        $log.error('SyncAdapter: Synchronize handler not found on the master adapter', this, theModel);\r\n                        return false;\r\n                    }\r\n                    if (typeof slave.synchronize !== 'function') {\r\n                        $log.error('SyncAdapter: Synchronize handler not found on the slave adapter', this, theModel);\r\n                        return false;\r\n                    }\r\n\r\n                    if (typeof master.modelValidationHook === 'function' && !master.modelValidationHook(theModel)) {\r\n                        return false;\r\n                    }\r\n                    if (typeof slave.modelValidationHook === 'function' && !slave.modelValidationHook(theModel)) {\r\n                        return false;\r\n                    }\r\n\r\n                    return true;\r\n                };\r\n\r\n                /**\r\n                 * Creates a new Entity on the Slave and attempts to sync to the Master\r\n                 * @param {Object} theModel The model of the entity to create\r\n                 * @param {Object} modelInstance The entity to create\r\n                 * @param {PreparedQueryOptions} [queryOptions] The query options to use for preferMaster\r\n                 * @returns {promise} Resolved with an AdapterResponse\r\n                 */\r\n                adapter.create = function (theModel, modelInstance, queryOptions) {\r\n                    if (queryOptions && queryOptions.preferMaster() === true) {\r\n                        return getMaster().create(theModel, modelInstance);\r\n                    } else {\r\n                        return getSlave().create(theModel, modelInstance);\r\n                    }\r\n                    // TODO: Sync\r\n                };\r\n\r\n                /**\r\n                 * Finds a single entity given a primary key on the Slave\r\n                 * @param {Object} theModel The model of the entity to find\r\n                 * @param {String|Number} pk The primary key of the entity to find\r\n                 * @param {PreparedQueryOptions} [queryOptions] The query options to use for $expand and preferMaster\r\n                 * @returns {promise} Resolved with an AdapterResponse\r\n                 */\r\n                adapter.findOne = function (theModel, pk, queryOptions) {\r\n                    var response;\r\n\r\n                    if (!pk) {\r\n                        response = new AdapterResponse(\"No Primary Key was supplied\", 0, AdapterResponse.BAD_REQUEST);\r\n                        $log.error('SyncAdapter: FindOne ' + theModel.modelName, response, pk, queryOptions);\r\n                        return $q.reject(response);\r\n                    }\r\n\r\n                    if (queryOptions && queryOptions.preferMaster() === true) {\r\n                        return getMaster().findOne(theModel, pk, queryOptions);\r\n                    } else {\r\n                        return getSlave().findOne(theModel, pk, queryOptions);\r\n                    }\r\n                };\r\n\r\n                /**\r\n                 * Finds a set of Model entities on the Slave\r\n                 * @param {Object} theModel The model of the entities to find\r\n                 * @param {PreparedQueryOptions} [queryOptions] The query options to use\r\n                 * @returns {promise} Resolved with an AdapterResponse\r\n                 */\r\n                adapter.find = function (theModel, queryOptions) {\r\n                    if (queryOptions && queryOptions.preferMaster() === true) {\r\n                        return getMaster().find(theModel, queryOptions);\r\n                    } else {\r\n                        return getSlave().find(theModel, queryOptions);\r\n                    }\r\n                };\r\n\r\n                /**\r\n                 * Updates a Model entity on the Slave given the primary key of the entity. Attempts to sync to the Master.\r\n                 * @param {Object} theModel The model of the entity to update\r\n                 * @param {String|Number} pk The primary key of the entity\r\n                 * @param {Object} modelInstance The entity to update\r\n                 * @param {PreparedQueryOptions} [queryOptions] The query options to use for preferMaster\r\n                 * @returns {promise} Resolved with an AdapterResponse\r\n                 */\r\n                adapter.update = function (theModel, pk, modelInstance, queryOptions) {\r\n                    var response;\r\n\r\n                    if (!pk) {\r\n                        response = new AdapterResponse(\"No Primary Key was supplied\", 0, AdapterResponse.BAD_REQUEST);\r\n                        $log.error('SyncAdapter: Update ' + theModel.modelName, response, modelInstance);\r\n                        return $q.reject(response);\r\n                    }\r\n\r\n                    if (queryOptions && queryOptions.preferMaster() === true) {\r\n                        return getMaster().update(theModel, pk, modelInstance);\r\n                    } else {\r\n                        return getSlave().update(theModel, pk, modelInstance);\r\n                    }\r\n                    // TODO: Sync\r\n                };\r\n\r\n                /**\r\n                 * Removes an Entity from the Slave given the primary key of the entity to remove. Attempts to sync to the Master.\r\n                 * @param {Object} theModel The model of the entity to remove\r\n                 * @param {String|Number} pk The primary key of the entity\r\n                 * @param {PreparedQueryOptions} [queryOptions] The query options to use for preferMaster\r\n                 * @returns {promise} Resolved with an AdapterResponse\r\n                 */\r\n                adapter.remove = function (theModel, pk, queryOptions) {\r\n                    var response;\r\n\r\n                    if (!pk) {\r\n                        response = new AdapterResponse(\"No Primary Key was supplied\", 0, AdapterResponse.BAD_REQUEST);\r\n                        $log.error('SyncAdapter: Remove ' + theModel.modelName, response, pk);\r\n                        return $q.reject(response);\r\n                    }\r\n\r\n                    if (queryOptions && queryOptions.preferMaster() === true) {\r\n                        return getMaster().remove(theModel, pk);\r\n                    } else {\r\n                        return getSlave().remove(theModel, pk);\r\n                    }\r\n                    // TODO: Sync\r\n                };\r\n\r\n                /**\r\n                 * Manually Syncs the Slave and Master adapters\r\n                 * @param {Object|Array} theModel The model of the entities to synchronize or an array of models to synchronize\r\n                 * @returns {promise} Resolved with an AdapterResponse for each model synchronized\r\n                 */\r\n                adapter.synchronize = function (theModel) {\r\n                    if (theModel instanceof Array) {\r\n                        var promises = [];\r\n                        var i;\r\n                        for (i = 0; i < theModel.length; i++) {\r\n                            promises.push(processSyncRequest(theModel[i]));\r\n                        }\r\n                        return $q.all(promises);\r\n                    }\r\n                    return processSyncRequest(theModel);\r\n                };\r\n\r\n                var getAdapter = function (adapter) {\r\n                    return (typeof adapter === 'string') ? $injector.get(adapter) : adapter;\r\n                };\r\n                var getMaster = function () {\r\n                    return getAdapter(providerConfig.masterAdapter);\r\n                };\r\n                var getSlave = function () {\r\n                    return getAdapter(providerConfig.slaveAdapter);\r\n                };\r\n\r\n                /**\r\n                 * Represents the result of a sync operation\r\n                 * @param {Array} sent An array of entities sent to the remote adapter\r\n                 * @param {Array} returned An array of data objects returned from the remote adapter\r\n                 * @param {Number} totalProcessed The total number of entities processed in the sync operation\r\n                 * @param {String} status The operation's status message\r\n                 * @constructor\r\n                 */\r\n                var SyncResult = function (sent, returned, totalProcessed, status) {\r\n                    this.sent = sent;\r\n                    this.returned = returned;\r\n                    this.totalProcessed = totalProcessed;\r\n                    this.status = status;\r\n                };\r\n\r\n                /**\r\n                 * Retrieves the last sync time for a given model in ISO format\r\n                 * @param {Object} theModel The model initiating the sync (the sync time is stored per model)\r\n                 * @returns {String} The last sync date in ISO format\r\n                 */\r\n                var getLastSyncTime = function (theModel) {\r\n                    return localStorage.get(localStorage.keys.LAST_SYNC, theModel.modelName);\r\n                };\r\n\r\n                /**\r\n                 * Updates the last sync time for a model\r\n                 * @param {Object} theModel The model initiating the sync\r\n                 */\r\n                var updateLastSyncTimeToNow = function (theModel) {\r\n                    localStorage.set(localStorage.keys.LAST_SYNC, new Date().toISOString(), theModel.modelName);\r\n                };\r\n\r\n                /**\r\n                 * Sends data from the local adapter to the remote adapter to update.\r\n                 * @param {Object} theModel The model initiating the sync\r\n                 * @param {Array} data An array of objects to send to the remote adapter to sync\r\n                 * @returns {promise}\r\n                 */\r\n                var sendSyncRequestData = function (theModel, data) {\r\n                    var lastSync = getLastSyncTime(theModel);\r\n                    return getMaster().synchronize(theModel, data, lastSync);\r\n                };\r\n\r\n                /**\r\n                 * Processes the data sent back from the remote adapter. This will update/create/delete records in the local\r\n                 * adapter\r\n                 * @param {Object} theModel The model initiating the sync\r\n                 * @param {Array} data An array of data objects to update/create/delete\r\n                 * @returns {promise}\r\n                 */\r\n                var processSyncResponseData = function (theModel, data) {\r\n                    var lastSync = getLastSyncTime(theModel);\r\n                    return getSlave().synchronize(theModel, data, lastSync);\r\n                };\r\n\r\n                /**\r\n                 * Initializes a sync request\r\n                 * @param {Object} theModel The model initiating the sync\r\n                 * @returns {promise}\r\n                 */\r\n                var processSyncRequest = function (theModel) {\r\n                    var dfd = $q.defer();\r\n                    var result;\r\n\r\n                    var syncRequestData = [];\r\n                    var syncResponseData = [];\r\n                    var totalItemsProcessed = 0;\r\n\r\n                    var handleError = function (e) {\r\n                        result = new SyncResult(syncRequestData, syncResponseData, totalItemsProcessed, e);\r\n                        $log.error('SyncAdapter: ' + theModel.modelName, result);\r\n                        dfd.reject(result);\r\n                    };\r\n\r\n                    var handleComplete = function () {\r\n                        result = new SyncResult(syncRequestData, syncResponseData, totalItemsProcessed, 'Complete');\r\n                        $log.debug('SyncAdapter: ' + theModel.modelName, 'Sync Complete', result);\r\n                        updateLastSyncTimeToNow(theModel);\r\n                        dfd.resolve(result);\r\n                    };\r\n\r\n                    $log.debug('SyncAdapter: ' + theModel.modelName + ' Sync Started');\r\n\r\n                    var lastSync = getLastSyncTime(theModel);\r\n                    var queryOptions = new PreparedQueryOptions();\r\n                    if (lastSync) {\r\n                        var predicate = new Predicate('lastModified').greaterThanOrEqualTo(lastSync);\r\n                        queryOptions.$filter(predicate);\r\n                    }\r\n\r\n                    getSlave().find(theModel, queryOptions, true).then(function (response) {\r\n                        $log.debug('SyncAdapter: Sending ' + response.count + ' local item(s) to sync');\r\n                        totalItemsProcessed += response.count;\r\n                        syncRequestData = response.data;\r\n                        sendSyncRequestData(theModel, response.data).then(function (syncResponse) {\r\n                            // TODO: Handle Conflicts\r\n\r\n                            $log.debug('SyncAdapter: Found ' + syncResponse.data.length + ' remote item(s) to sync');\r\n                            totalItemsProcessed += syncResponse.data.length;\r\n                            syncResponseData = syncResponse.data;\r\n\r\n                            if (syncResponse.data.length > 0) {\r\n                                processSyncResponseData(theModel, syncResponse.data).then(handleComplete, handleError);\r\n                            } else {\r\n                                // No data from server to sync\r\n                                handleComplete();\r\n                            }\r\n                        }, handleError);\r\n                    }, handleError);\r\n\r\n                    return dfd.promise;\r\n                };\r\n\r\n                return adapter;\r\n            }\r\n        ];\r\n    }\r\n]);","angular.module('recall.adapter.webSQL', ['recall']).provider('recallWebSQLAdapter', [\r\n\r\n    function () {\r\n\r\n        var providerConfig = {};\r\n\r\n        // Sets the name of the WebSQL DB database to use\r\n        providerConfig.dbName = 'recall';\r\n        this.setDbName = function (dbName) {\r\n            providerConfig.dbName = dbName;\r\n            return this;\r\n        };\r\n\r\n        // Sets the version of the WebSQL DB to use\r\n        providerConfig.dbVersion = 1;\r\n        this.setDbVersion = function (dbVersion) {\r\n            providerConfig.dbVersion = dbVersion;\r\n            return this;\r\n        };\r\n\r\n        // Sets the size of the WebSQL DB\r\n        providerConfig.dbSize = 5 * 1024 * 1024; // 5MB\r\n        this.setDbSize = function (dbSize) {\r\n            providerConfig.dbSize = dbSize;\r\n            return this;\r\n        };\r\n\r\n        // Sets the default function to be used as a \"GUID\" generator\r\n        providerConfig.pkGenerator = function () {\r\n            function s4() {\r\n                return Math.floor((1 + Math.random()) * 0x10000)\r\n                    .toString(16)\r\n                    .substring(1);\r\n            }\r\n\r\n            return s4() + s4() + '-' + s4() + '-' + s4() + '-' +\r\n                s4() + '-' + s4() + s4() + s4();\r\n        };\r\n        this.setPkGenerator = function (pkGenerator) {\r\n            providerConfig.pkGenerator = pkGenerator;\r\n            return this;\r\n        };\r\n\r\n        // Drops the WebSQL DB database\r\n        this.dropDatabase = function () {\r\n            return true;\r\n        };\r\n\r\n        this.$get = [\r\n            '$log',\r\n            '$q',\r\n            '$window',\r\n            'recall',\r\n            'recallAdapterResponse',\r\n\r\n            function ($log, $q, $window, recall, AdapterResponse) {\r\n\r\n                var adapter = {};\r\n                var db;\r\n\r\n                var generatePrimaryKey = providerConfig.pkGenerator;\r\n\r\n                var createTable = function (model, fields, tx) {\r\n                    var dfd = $q.defer();\r\n\r\n                    var sql = 'CREATE TABLE IF NOT EXISTS `' + model.dataSourceName + '` (' + fields.join(', ') + ')';\r\n                    $log.debug(\"WebSQLAdapter: \" + sql);\r\n                    tx.executeSql(sql, [], function () {\r\n                        dfd.resolve();\r\n                    }, function (tx, e) {\r\n                        dfd.reject(e);\r\n                    });\r\n\r\n                    return dfd.promise;\r\n                };\r\n\r\n                // Handles version differences in the database and initializes or migrates the db\r\n                var migrate = function (db) {\r\n                    var dfd = $q.defer();\r\n\r\n                    db.transaction(function (tx) {\r\n                        var i;\r\n                        var model;\r\n                        var field;\r\n                        var column;\r\n                        var fields;\r\n                        var models = recall.getModels();\r\n                        var promises = [];\r\n\r\n                        for (i = 0; i < models.length; i++) {\r\n                            model = models[i];\r\n\r\n                            fields = [];\r\n                            for (field in model.fields) {\r\n                                if (model.fields.hasOwnProperty(field)) {\r\n                                    column = \"`\" + model.fields[field].name + \"`\";\r\n                                    switch (model.fields[field].type) {\r\n                                        case 'STRING':\r\n                                            column += ' TEXT';\r\n                                            break;\r\n                                        case 'NUMBER':\r\n                                            column += ' REAL';\r\n                                            break;\r\n                                        case 'DATE':\r\n                                            column += ' TEXT';\r\n                                            break;\r\n                                        case 'BOOLEAN':\r\n                                            column += ' INTEGER';\r\n                                            break;\r\n                                        default:\r\n                                            $log.error('WebSQLAdapter: Migrate - An unknown field type was found.');\r\n                                            return;\r\n                                    }\r\n\r\n                                    if (model.fields[field].primaryKey) {\r\n                                        column += ' PRIMARY KEY';\r\n                                    }\r\n                                    if (model.fields[field].unique) {\r\n                                        column += ' UNIQUE';\r\n                                    }\r\n                                    if (model.fields[field].notNull) {\r\n                                        column += ' NOT NULL';\r\n                                    }\r\n                                    fields.push(column);\r\n                                }\r\n                            }\r\n                            promises.push(createTable(model, fields, tx));\r\n                        }\r\n\r\n                        $q.all(promises).then(function () {\r\n                            dfd.resolve();\r\n                        }, function (e) {\r\n                            $log.error(\"WebSQLAdapter: Table Creation Failed\", e);\r\n                            dfd.reject(e);\r\n                        });\r\n                    });\r\n\r\n                    return dfd.promise;\r\n                };\r\n\r\n                // Connects to the database\r\n                var connect = function () {\r\n                    var dfd = $q.defer();\r\n\r\n                    if (db) {\r\n                        dfd.resolve(db);\r\n                    } else {\r\n                        try {\r\n                            db = $window.openDatabase(providerConfig.dbName, providerConfig.dbVersion.toString(), 'Recall WebSQL Database', providerConfig.dbSize);\r\n                            migrate(db).then(function () {\r\n                                dfd.resolve(db);\r\n                            }, function (e) {\r\n                                dfd.reject(e);\r\n                            });\r\n                        } catch (e) {\r\n                            dfd.reject(e);\r\n                        }\r\n                    }\r\n\r\n                    return dfd.promise;\r\n                };\r\n\r\n                // TODO: Cascade create\r\n                /**\r\n                 * Creates a new Entity\r\n                 * @param {Object} theModel The model of the entity to create\r\n                 * @param {Object} modelInstance The entity to create\r\n                 * @returns {promise} Resolved with an AdapterResponse\r\n                 */\r\n                adapter.create = function (theModel, modelInstance) {\r\n                    var dfd = $q.defer();\r\n                    var response;\r\n\r\n                    var buildError = function (e) {\r\n                        response = new AdapterResponse(e, 0, AdapterResponse.INTERNAL_SERVER_ERROR);\r\n                        $log.error('WebSQLAdapter: Create ' + theModel.modelName, response, modelInstance);\r\n                        return response;\r\n                    };\r\n\r\n                    modelInstance[theModel.primaryKeyFieldName] = generatePrimaryKey();\r\n                    modelInstance = theModel.getRawModelObject(modelInstance, false);\r\n                    modelInstance[theModel.lastModifiedFieldName] = new Date();\r\n\r\n                    connect().then(function () {\r\n                        db.transaction(function (tx) {\r\n                            var columns = [];\r\n                            var columnValues = [];\r\n                            var placeholders = [];\r\n                            var field;\r\n                            for (field in theModel.fields) {\r\n                                if (theModel.fields.hasOwnProperty(field) && modelInstance.hasOwnProperty(field)) {\r\n                                    columns.push(\"`\" + field + \"`\");\r\n                                    columnValues.push(convertValueToSQL(theModel.fields[field], modelInstance));\r\n                                    placeholders.push('?');\r\n                                }\r\n                            }\r\n                            var sql = \"INSERT INTO `\" + theModel.dataSourceName + \"` (\" + columns.join(',') + \") VALUES (\" + placeholders.join(\",\") +\")\";\r\n                            $log.debug(\"WebSQLAdapter: \" + sql, columnValues);\r\n                            tx.executeSql(sql, columnValues, function (tx, result) {\r\n                                var results = transformSQLResult(theModel, result);\r\n                                response = new AdapterResponse(results[0], 1, AdapterResponse.CREATED);\r\n                                $log.debug('WebSQLAdapter: Create ' + theModel.modelName, response);\r\n                                dfd.resolve(response);\r\n                            }, function (tx, e) {\r\n                                dfd.reject(buildError(e));\r\n                            });\r\n                        });\r\n                    }, function (e) {\r\n                        dfd.reject(buildError(e));\r\n                    });\r\n\r\n                    return dfd.promise;\r\n                };\r\n\r\n                /**\r\n                 * Finds a single entity given a primary key\r\n                 * @param {Object} theModel The model of the entity to find\r\n                 * @param {String|Number} pk The primary key of the entity to find\r\n                 * @param {PreparedQueryOptions} [queryOptions] The query options to use for $expand\r\n                 * @param {Boolean} [includeDeleted=false] If true, includes soft-deleted entities\r\n                 * @returns {promise} Resolved with an AdapterResponse\r\n                 */\r\n                adapter.findOne = function (theModel, pk, queryOptions, includeDeleted) {\r\n                    var dfd = $q.defer();\r\n                    var response;\r\n\r\n                    var buildError = function (e, status) {\r\n                        response = new AdapterResponse(e, 0, status || AdapterResponse.INTERNAL_SERVER_ERROR);\r\n                        $log.error('WebSQLAdapter: FindOne ' + theModel.modelName, response, pk, queryOptions);\r\n                        return response;\r\n                    };\r\n\r\n                    connect().then(function () {\r\n                        db.transaction(function (tx) {\r\n\r\n                            var sql = \"SELECT * FROM `\" + theModel.dataSourceName + \"` WHERE `\" + theModel.primaryKeyFieldName + \"`=?\";\r\n\r\n                            if (!includeDeleted && theModel.deletedFieldName) {\r\n                                sql += \" AND `\" + theModel.deletedFieldName + \"`=0\";\r\n                            }\r\n\r\n                            $log.debug(\"WebSQLAdapter: \" + sql, [pk]);\r\n                            tx.executeSql(sql, [pk], function (tx, result) {\r\n                                var results = transformSQLResult(theModel, result);\r\n                                if (results[0]) {\r\n                                    performExpand(results[0], theModel, queryOptions, tx).then(function () {\r\n                                        response = new AdapterResponse(results[0], 1);\r\n                                        $log.debug('WebSQLAdapter: FindOne ' + theModel.modelName, response, pk, queryOptions);\r\n                                        dfd.resolve(response);\r\n                                    }, function (e) {\r\n                                        dfd.reject(buildError(e));\r\n                                    });\r\n                                } else {\r\n                                    dfd.reject(buildError('Not Found', AdapterResponse.NOT_FOUND));\r\n                                }\r\n                            }, function (tx, e) {\r\n                                dfd.reject(buildError(e));\r\n                            });\r\n                        });\r\n                    }, function (e) {\r\n                        dfd.reject(buildError(e));\r\n                    });\r\n                    return dfd.promise;\r\n                };\r\n\r\n                /**\r\n                 * Finds a set of Model entities\r\n                 * @param {Object} theModel The model of the entities to find\r\n                 * @param {PreparedQueryOptions} [queryOptions] The query options to use\r\n                 * @param {Boolean} [includeDeleted=false] If true, includes soft-deleted entities\r\n                 * @returns {promise} Resolved with an AdapterResponse\r\n                 */\r\n                adapter.find = function (theModel, queryOptions, includeDeleted) {\r\n                    var dfd = $q.defer();\r\n                    var response;\r\n\r\n                    var buildError = function (e) {\r\n                        response = new AdapterResponse(e, 0, AdapterResponse.INTERNAL_SERVER_ERROR);\r\n                        $log.error('WebSQLAdapter: Find ' + theModel.modelName, response, queryOptions);\r\n                        return response;\r\n                    };\r\n\r\n                    connect().then(function () {\r\n                        db.transaction(function (tx) {\r\n                            var filterPredicate;\r\n\r\n                            if (queryOptions && queryOptions.$filter()) {\r\n                                filterPredicate = queryOptions.$filter();\r\n                            }\r\n\r\n                            var sql = \"SELECT * FROM `\" + theModel.dataSourceName + \"`\";\r\n\r\n                            if (!includeDeleted && theModel.deletedFieldName) {\r\n                                sql += \" WHERE `\" + theModel.deletedFieldName + \"`=0\";\r\n                            }\r\n\r\n                            if (queryOptions && queryOptions.$orderBy()) {\r\n                                var field = queryOptions.$orderBy().split(' ')[0];\r\n                                var dir = queryOptions.$orderBy().split(' ')[1] ? queryOptions.$orderBy().split(' ')[1].toUpperCase() : \"ASC\";\r\n                                sql += \" ORDER BY `\" + field + \"` \" + dir;\r\n                            }\r\n\r\n                            $log.debug(\"WebSQLAdapter: \" + sql);\r\n                            tx.executeSql(sql, [], function (tx, result) {\r\n                                var results = transformSQLResult(theModel, result);\r\n                                var i;\r\n                                var promises = [];\r\n                                for (i = 0; i < results.length; i++) {\r\n                                    promises.push(performExpand(results[i], theModel, queryOptions, tx));\r\n                                }\r\n                                $q.all(promises).then(function () {\r\n                                    results = applyFilter(results, filterPredicate);\r\n\r\n                                    var totalCount = results.length;\r\n\r\n                                    // TODO: This is not very efficient but indexedDB does not seem to support a better way with filters and ordering\r\n                                    results = applyPaging(results, queryOptions);\r\n                                    response = new AdapterResponse(results, totalCount);\r\n\r\n                                    $log.debug('WebSQLAdapter: Find ' + theModel.modelName, response, queryOptions);\r\n                                    dfd.resolve(response);\r\n                                }, function (e) {\r\n                                    dfd.reject(buildError(e));\r\n                                });\r\n                            }, function (tx, e) {\r\n                                dfd.reject(buildError(e));\r\n                            });\r\n                        });\r\n                    }, function (e) {\r\n                        dfd.reject(buildError(e));\r\n                    });\r\n                    return dfd.promise;\r\n                };\r\n\r\n                // TODO: Cascade Update\r\n                /**\r\n                 * Updates a Model entity given the primary key of the entity\r\n                 * @param {Object} theModel The model of the entity to update\r\n                 * @param {String|Number} pk The primary key of the entity\r\n                 * @param {Object} modelInstance The entity to update\r\n                 * @param {Boolean} [includeDeleted=false] If true, includes soft-deleted entities\r\n                 * @returns {promise} Resolved with an AdapterResponse\r\n                 */\r\n                adapter.update = function (theModel, pk, modelInstance, includeDeleted) {\r\n                    var dfd = $q.defer();\r\n                    var response;\r\n\r\n                    var buildError = function (e) {\r\n                        response = new AdapterResponse(e, 0, AdapterResponse.INTERNAL_SERVER_ERROR);\r\n                        $log.error('WebSQLAdapter: Update ' + theModel.modelName, response, modelInstance);\r\n                        return response;\r\n                    };\r\n\r\n                    modelInstance = theModel.getRawModelObject(modelInstance, false);\r\n                    modelInstance[theModel.lastModifiedFieldName] = new Date();\r\n\r\n                    connect().then(function () {\r\n                        db.transaction(function (tx) {\r\n                            var columns = [];\r\n                            var columnValues = [];\r\n                            var field;\r\n                            for (field in theModel.fields) {\r\n                                if (theModel.fields.hasOwnProperty(field) && modelInstance.hasOwnProperty(field) && field !== theModel.primaryKeyFieldName) {\r\n                                    columns.push(\"`\" + field + \"`=?\");\r\n                                    columnValues.push(convertValueToSQL(theModel.fields[field], modelInstance));\r\n                                }\r\n                            }\r\n                            columnValues.push(pk);\r\n                            var sql = \"UPDATE `\" + theModel.dataSourceName + \"` SET \" + columns.join(',') + \" WHERE `\" + theModel.primaryKeyFieldName + \"`=?\";\r\n\r\n                            if (!includeDeleted && theModel.deletedFieldName) {\r\n                                sql += \" AND `\" + theModel.deletedFieldName + \"`=0\";\r\n                            }\r\n\r\n                            $log.debug(\"WebSQLAdapter: \" + sql, columnValues);\r\n                            tx.executeSql(sql, columnValues, function (tx, result) {\r\n                                response = new AdapterResponse(modelInstance, 1);\r\n                                $log.debug('WebSQLAdapter: Update ' + theModel.modelName, response, modelInstance);\r\n                                dfd.resolve(response);\r\n                            }, function (tx, e) {\r\n                                dfd.reject(buildError(e));\r\n                            });\r\n                        });\r\n                    }, function (e) {\r\n                        dfd.reject(buildError(e));\r\n                    });\r\n                    return dfd.promise;\r\n                };\r\n\r\n                // TODO: Cascade Delete:\r\n                /**\r\n                 * Removes an Entity given the primary key of the entity to remove\r\n                 * @param {Object} theModel The model of the entity to remove\r\n                 * @param {String|Number} pk The primary key of the entity\r\n                 * @returns {promise} Resolved with an AdapterResponse\r\n                 */\r\n                adapter.remove = function (theModel, pk) {\r\n                    var dfd = $q.defer();\r\n                    var response;\r\n\r\n                    var buildError = function (e) {\r\n                        response = new AdapterResponse(e, 0, AdapterResponse.INTERNAL_SERVER_ERROR);\r\n                        $log.error('WebSQLAdapter: Remove ' + theModel.modelName, response);\r\n                        return response;\r\n                    };\r\n\r\n                    var columns = [\"`\" + theModel.lastModifiedFieldName + \"`=?\", \"`\" + theModel.deletedFieldName + \"`=?\"];\r\n                    var columnValues = [new Date().toISOString(), 1, pk];\r\n\r\n                    connect().then(function () {\r\n                        db.transaction(function (tx) {\r\n\r\n                            var sql = \"UPDATE `\" + theModel.dataSourceName + \"` SET \" + columns.join(',') + \" WHERE `\" + theModel.primaryKeyFieldName + \"`=?\";\r\n\r\n                            $log.debug(\"WebSQLAdapter: \" + sql, columnValues);\r\n                            tx.executeSql(sql, columnValues, function (tx, result) {\r\n                                response = new AdapterResponse(null, 1, AdapterResponse.NO_CONTENT);\r\n                                $log.debug('WebSQLAdapter: Remove ' + theModel.modelName, response);\r\n                                dfd.resolve(response);\r\n                            }, function (tx, e) {\r\n                                dfd.reject(buildError(e));\r\n                            });\r\n                        });\r\n                    }, function (e) {\r\n                        dfd.reject(buildError(e));\r\n                    });\r\n                    return dfd.promise;\r\n                };\r\n\r\n                /**\r\n                 * Takes an Array of entities and creates/updates/deletes them\r\n                 * @param {Object} theModel The model of the entities to synchronize\r\n                 * @param {Array} dataToSync An array of objects to create/update/delete\r\n                 * @returns {promise} Resolved with an AdapterResponse\r\n                 */\r\n                adapter.synchronize = function (theModel, dataToSync) {\r\n                    var dfd = $q.defer();\r\n                    var response;\r\n\r\n                    var buildError = function (e) {\r\n                        response = new AdapterResponse(e, 0, AdapterResponse.INTERNAL_SERVER_ERROR);\r\n                        $log.error('WebSQLAdapter: Synchronize ' + theModel.modelName, response, dataToSync);\r\n                        return response;\r\n                    };\r\n\r\n                    connect().then(function () {\r\n                        db.transaction(function (tx) {\r\n                            var i;\r\n                            var promises = [];\r\n                            for (i = 0; i < dataToSync.length; i++) {\r\n                                if (dataToSync[i][theModel.deletedFieldName]) {\r\n                                    promises.push(hardRemove(theModel, tx, dataToSync[i][theModel.primaryKeyFieldName]));\r\n                                } else {\r\n                                    promises.push(createOrUpdate(theModel, tx, dataToSync[i]));\r\n                                }\r\n                            }\r\n\r\n                            $q.all(promises).then(function (results) {\r\n                                response = new AdapterResponse(results, results.length, AdapterResponse.OK);\r\n                                $log.debug('WebSQLAdapter: Synchronize ' + theModel.modelName, response, dataToSync);\r\n                                dfd.resolve(response);\r\n                            }, function (e) {\r\n                                dfd.reject(buildError(e));\r\n                            });\r\n                        });\r\n                    }, function (e) {\r\n                        dfd.reject(buildError(e));\r\n                    });\r\n                    return dfd.promise;\r\n                };\r\n\r\n                // Creates a new Entity if not found or updates the existing one. Used in synchronization.\r\n                var createOrUpdate = function (theModel, tx, modelInstance) {\r\n                    var dfd = $q.defer();\r\n\r\n                    var columns = [];\r\n                    var columnValues = [];\r\n                    var placeholders = [];\r\n                    var field;\r\n                    for (field in theModel.fields) {\r\n                        if (theModel.fields.hasOwnProperty(field) && modelInstance.hasOwnProperty(field)) {\r\n                            columns.push(\"`\" + field + \"`\");\r\n                            columnValues.push(convertValueToSQL(theModel.fields[field], modelInstance));\r\n                            placeholders.push('?');\r\n                        }\r\n                    }\r\n                    var sql = \"INSERT OR REPLACE INTO `\" + theModel.dataSourceName + \"` (\" + columns.join(',') + \") VALUES (\" + placeholders.join(\",\") +\")\";\r\n                    $log.debug(\"WebSQLAdapter: \" + sql, columnValues);\r\n                    tx.executeSql(sql, columnValues, function (tx, result) {\r\n                        var results = transformSQLResult(theModel, result);\r\n                        dfd.resolve(results[0]);\r\n                    }, function (tx, e) {\r\n                        dfd.reject(e);\r\n                    });\r\n\r\n                    return dfd.promise;\r\n                };\r\n\r\n                // Hard deletes an Entity. Used in synchronization.\r\n                var hardRemove = function (theModel, tx, pk) {\r\n                    var dfd = $q.defer();\r\n\r\n                    var sql = \"DELETE FROM `\" + theModel.dataSourceName + \"` WHERE `\" + theModel.primaryKeyFieldName + \"`=?\";\r\n                    $log.debug(\"WebSQLAdapter: \" + sql, [pk]);\r\n                    tx.executeSql(sql, [pk], function (tx, result) {\r\n                        dfd.resolve();\r\n                    }, function (tx, e) {\r\n                        dfd.reject(e);\r\n                    });\r\n\r\n                    return dfd.promise;\r\n                };\r\n\r\n                // Expands a has one model association\r\n                var expandHasOne = function (model, result, association, tx, pathsToExpand) {\r\n                    var dfd = $q.defer();\r\n                    var pathToExpand = pathsToExpand.join('.');\r\n\r\n                    if (result[association.mappedBy] === undefined) {\r\n                        result[association.mappedBy] = null;\r\n                        dfd.resolve();\r\n                        return dfd.promise;\r\n                    }\r\n\r\n                    var sql = \"SELECT * FROM `\" + model.dataSourceName + \"` WHERE `\" + model.primaryKeyFieldName + \"`=?\";\r\n\r\n                    if (model.deletedFieldName) {\r\n                        sql += \" AND `\" + model.deletedFieldName + \"`=0\";\r\n                    }\r\n\r\n                    $log.debug(\"WebSQLAdapter: \" + sql, [result[association.mappedBy]]);\r\n                    tx.executeSql(sql, [result[association.mappedBy]], function (tx, response) {\r\n                        var results = transformSQLResult(model, response);\r\n                        if (results[0]) {\r\n                            result[association.alias] = results[0];\r\n                            if (pathsToExpand.length > 1) {\r\n                                expandPath(results[0], model, pathToExpand.substring(pathToExpand.indexOf('.') + 1), tx).then(function () {\r\n                                    dfd.resolve();\r\n                                }, function (e) {\r\n                                    dfd.reject(e);\r\n                                });\r\n                            } else {\r\n                                dfd.resolve();\r\n                            }\r\n                        } else {\r\n                            result[association.alias] = null;\r\n                            dfd.resolve();\r\n                        }\r\n                    }, function (tx, e) {\r\n                        dfd.reject(e);\r\n                    });\r\n\r\n                    return dfd.promise;\r\n                };\r\n\r\n                // Expands a has many model association\r\n                var expandHasMany = function (model, result, association, tx, pathsToExpand) {\r\n                    var dfd = $q.defer();\r\n                    var pathToExpand = pathsToExpand.join('.');\r\n\r\n                    var sql = \"SELECT * FROM `\" + model.dataSourceName + \"` WHERE `\" + association.mappedBy + \"`=?\";\r\n\r\n                    if (model.deletedFieldName) {\r\n                        sql += \" AND `\" + model.deletedFieldName + \"`=0\";\r\n                    }\r\n\r\n                    $log.debug(\"WebSQLAdapter: \" + sql, [result[model.primaryKeyFieldName]]);\r\n                    tx.executeSql(sql, [result[model.primaryKeyFieldName]], function (tx, response) {\r\n                        var results = transformSQLResult(model, response);\r\n\r\n                        var filter = association.getOptions(result).$filter();\r\n                        if (filter) {\r\n                            results = applyFilter(results, filter);\r\n                        }\r\n\r\n                        result[association.alias] = results;\r\n                        if (pathsToExpand.length > 1) {\r\n                            var i;\r\n                            var promises = [];\r\n                            for (i = 0; i < results.length; i++) {\r\n                                promises.push(expandPath(results[i], model, pathToExpand.substring(pathToExpand.indexOf('.') + 1), tx));\r\n                            }\r\n                            $q.all(promises).then(function () {\r\n                                dfd.resolve();\r\n                            }, function (e) {\r\n                                dfd.reject(e);\r\n                            });\r\n                        } else {\r\n                            dfd.resolve();\r\n                        }\r\n                    }, function (tx, e) {\r\n                        dfd.reject(e);\r\n                    });\r\n\r\n                    return dfd.promise;\r\n                };\r\n\r\n                // Expands a Model association given an expand path\r\n                // Recursive\r\n                var expandPath = function (result, theModel, pathToExpand, tx) {\r\n                    var pathsToExpand = pathToExpand.split('.');\r\n                    var toExpand = pathsToExpand[0];\r\n\r\n                    if (toExpand) {\r\n                        var association = theModel.getAssociationByAlias(toExpand);\r\n                        var model = association.getModel();\r\n                        if (association && model) {\r\n                            if (association.type === 'hasOne') {\r\n                                return expandHasOne(model, result, association, tx, pathsToExpand);\r\n                            } else if (association.type === 'hasMany') {\r\n                                return expandHasMany(model, result, association, tx, pathsToExpand);\r\n                            }\r\n                        }\r\n                    }\r\n\r\n                    // There is nothing left to expand, just resolve.\r\n                    var dfd = $q.defer();\r\n                    dfd.resolve();\r\n                    return dfd.promise;\r\n                };\r\n\r\n                // Expands all Model associations defined in the query options $expand clause\r\n                var performExpand = function (result, theModel, queryOptions, tx) {\r\n                    var dfd = $q.defer();\r\n                    var $expand;\r\n                    var promises = [];\r\n\r\n                    if (queryOptions) {\r\n                        $expand = queryOptions.$expand();\r\n                    }\r\n                    if ($expand) {\r\n                        var paths = $expand.split(',');\r\n                        var i;\r\n                        for (i = 0; i < paths.length; i++) {\r\n                            promises.push(expandPath(result, theModel, paths[i], tx));\r\n                        }\r\n                        $q.all(promises).then(function () {\r\n                            dfd.resolve();\r\n                        }, function (e) {\r\n                            $log.error('WebSQLAdapter: PerformExpand', e, $expand, result);\r\n                            dfd.reject(e);\r\n                        });\r\n                    } else {\r\n                        dfd.resolve();\r\n                    }\r\n\r\n                    return dfd.promise;\r\n                };\r\n\r\n                // Checks if a result matches a predicate filter\r\n                var resultMatchesFilters = function (result, predicate) {\r\n                    return predicate.test(result);\r\n                };\r\n\r\n                // Applies a filter predicate to a set of results and returns an array of the matching results\r\n                var applyFilter = function (results, filterPredicate) {\r\n                    if (filterPredicate && results) {\r\n                        results = results.filter(function (a) {\r\n                            return resultMatchesFilters(a, filterPredicate);\r\n                        });\r\n                    }\r\n                    return results;\r\n                };\r\n\r\n                // Applies paging to a set of results and returns a sliced array of results\r\n                var applyPaging = function (results, queryOptions) {\r\n                    if (!queryOptions) {\r\n                        return results;\r\n                    }\r\n                    var top = queryOptions.$top();\r\n                    var skip = queryOptions.$skip();\r\n                    if (top > 0 && skip >= 0) {\r\n                        results = results.slice(skip, skip + top);\r\n                    }\r\n                    return results;\r\n                };\r\n\r\n                var convertValueToSQL = function (field, modelInstance) {\r\n                    switch (field.type) {\r\n                    case 'STRING':\r\n                    case 'NUMBER':\r\n                        return modelInstance[field.name];\r\n                    case 'DATE':\r\n                        if (modelInstance[field.name] instanceof Date) {\r\n                            return modelInstance[field.name].toISOString();\r\n                        }\r\n                        return new Date(modelInstance[field.name]).toISOString();\r\n                    case 'BOOLEAN':\r\n                        if (modelInstance[field] === true || modelInstance[field] === 1) {\r\n                            return 1;\r\n                        }\r\n                        return 0;\r\n                    }\r\n                };\r\n\r\n                var convertValueToModel = function (field, sqlResultInstance) {\r\n                    switch (field.type) {\r\n                    case 'STRING':\r\n                    case 'NUMBER':\r\n                    case 'DATE':\r\n                        return sqlResultInstance[field.name];\r\n                    case 'BOOLEAN':\r\n                        return sqlResultInstance[field.name] === 1;\r\n                    }\r\n                };\r\n\r\n                var getSQLModelObject = function (theModel, result) {\r\n                    var field;\r\n                    var obj = {};\r\n                    for (field in theModel.fields) {\r\n                        if (theModel.fields.hasOwnProperty(field) && result.hasOwnProperty(field)) {\r\n                            obj[field] = convertValueToModel(theModel.fields[field], result);\r\n                        }\r\n                    }\r\n                    return obj;\r\n                };\r\n\r\n                var transformSQLResult = function (theModel, result) {\r\n                    var results = [];\r\n                    var i;\r\n                    for (i = 0; i < result.rows.length; i++) {\r\n                        results.push(getSQLModelObject(theModel, result.rows.item(i)));\r\n                    }\r\n\r\n                    return results;\r\n                };\r\n\r\n                return adapter;\r\n            }\r\n        ];\r\n    }\r\n]);","angular.module('recall').factory(\"recallAssociation\", [\r\n    '$injector',\r\n    '$log',\r\n    '$q',\r\n    'recallPredicate',\r\n    'recallPreparedQueryOptions',\r\n\r\n    function ($injector, $log, $q, Predicate, PreparedQueryOptions) {\r\n\r\n        /**\r\n         * Association class\r\n         * @param {Object|Association} definition\r\n         * @constructor\r\n         */\r\n        var Association = function (definition) {\r\n            this.invalid = false;\r\n\r\n            if (definition.type) {\r\n                this.type = definition.type;\r\n            } else if (typeof definition.hasOne === 'string') {\r\n                this.type = 'hasOne';\r\n            } else if (typeof definition.hasMany === 'string') {\r\n                this.type = 'hasMany';\r\n            }\r\n\r\n            this.modelName = definition.modelName || definition.hasOne || definition.hasMany;\r\n            this.alias = definition.as || definition.alias || this.modelName;\r\n            this.mappedBy = definition.mappedBy || definition.foreignKey;\r\n            this.getOptions = definition.getOptions || function () { return new PreparedQueryOptions(); };\r\n\r\n            if (!this.modelName || !this.type || !this.mappedBy) {\r\n                $log.error('Association: The association definition is invalid', definition);\r\n                this.invalid = true;\r\n            }\r\n        };\r\n\r\n        /**\r\n         * Gets the Association's Model\r\n         * @returns {Object} The model\r\n         */\r\n        Association.prototype.getModel = function () {\r\n            var recallService = $injector.get('recall');\r\n            return recallService.getModel(this.modelName);\r\n        };\r\n\r\n        /**\r\n         * Expands the association and adds it to the entity\r\n         * @param {Entity} entity The entity to add the expanded association to\r\n         * @returns {promise}\r\n         */\r\n        Association.prototype.expand = function (entity) {\r\n            var dfd = $q.defer();\r\n            var self = this;\r\n            var Model = self.getModel();\r\n\r\n            if (!Model) {\r\n                return $q.reject('Association: Expand could not find the association\\'s Model');\r\n            }\r\n\r\n            var queryOptions = self.getOptions(entity);\r\n\r\n            if (self.type === 'hasOne') {\r\n\r\n                Model.adapter.findOne(Model, entity[self.mappedBy], queryOptions).then(function (response) {\r\n                    entity[self.alias] = Model.getRawModelObject(response.data);\r\n                    // TODO: The association should be an entity and should have transformResult called\r\n                    entity.$entity.storedState[self.alias] = Model.getRawModelObject(response.data);\r\n                    $log.debug(\"Association: Expand\", self.type, self.alias, entity, response);\r\n                    dfd.resolve();\r\n                }, function (e) {\r\n                    $log.error(\"Association: Expand\", self.type, self.alias, entity, e);\r\n                    dfd.reject(e);\r\n                });\r\n\r\n            } else if (self.type === 'hasMany') {\r\n\r\n                var predicate = new Predicate(self.mappedBy).equals(entity.$getPrimaryKey());\r\n                var existingPredicate = queryOptions.$filter();\r\n                if (existingPredicate) {\r\n                    predicate = Predicate.join([predicate, existingPredicate]);\r\n                }\r\n                queryOptions.$filter(predicate);\r\n\r\n                Model.adapter.find(Model, queryOptions).then(function (response) {\r\n                    var base = [];\r\n                    var stored = [];\r\n                    // TODO: The associations should be entities and should have transformResult called\r\n                    var i;\r\n                    for (i = 0; i < response.data.length; i++) {\r\n                        base.push(Model.getRawModelObject(response.data[i]));\r\n                        stored.push(Model.getRawModelObject(response.data[i]));\r\n                    }\r\n                    entity[self.alias] = base;\r\n                    entity.$entity.storedState[self.alias] = stored;\r\n                    $log.debug(\"Association: Expand\", self.type, self.alias, entity, response);\r\n                    dfd.resolve();\r\n                }, function (e) {\r\n                    $log.error(\"Association: Expand\", self.type, self.alias, entity, e);\r\n                    dfd.reject(e);\r\n                });\r\n            } else {\r\n                $log.error(\"Association: Expand Association type not supported\", self.type, self.alias, entity);\r\n                dfd.reject(\"Association type not supported\");\r\n            }\r\n\r\n            return dfd.promise;\r\n        };\r\n\r\n        return Association;\r\n    }\r\n]);","angular.module('recall').factory(\"recallEntity\", [\r\n    '$log',\r\n    '$q',\r\n\r\n    function ($log, $q) {\r\n\r\n        /**\r\n         * An Entity is an object that represents an instance of a Model. The Entity instance exposes save and remove\r\n         * operations as well as dirty checking and validation.\r\n         *\r\n         * @param {Object} object The object to construct the entity from\r\n         * @param {Object} model The model that created the Entity\r\n         * @param {Boolean} [persisted = false] Set to true if this model was created from an object that came from an adapter.\r\n         * @constructor\r\n         */\r\n        var Entity = function (object, model, persisted) {\r\n            model.extendFromRawObject(this, object);\r\n\r\n            Object.defineProperty(this, \"$entity\", {value: {\r\n                lastDirtyCheck: new Date().getTime(),\r\n                lastDirtyState: false,\r\n                persisted: persisted === true,\r\n                saveInProgress: false,\r\n                storedState: null\r\n            }});\r\n            Object.defineProperty(this, \"$model\", {value: model});\r\n\r\n            this.$convertAssociationsToEntities();\r\n            this.$storeState();\r\n        };\r\n\r\n        /**\r\n         * Retrieves the Primary Key for the Entity.\r\n         * @returns {String|Number} The Primary Key\r\n         */\r\n        Entity.prototype.$getPrimaryKey = function () {\r\n            return this[this.$model.primaryKeyFieldName];\r\n        };\r\n\r\n        /**\r\n         *\r\n         */\r\n        Entity.prototype.$convertAssociationsToEntities = function () {\r\n            var i;\r\n            var alias;\r\n            var ForeignModel;\r\n            var a;\r\n            for (i = 0; i < this.$model.associations.length; i++) {\r\n                alias = this.$model.associations[i].alias;\r\n                ForeignModel = this.$model.associations[i].getModel();\r\n\r\n                if (this.$model.associations[i].type === 'hasOne') {\r\n                    if (this[alias] !== undefined && !this[alias].$entity) {\r\n                        this[alias] = new ForeignModel.Entity(this[alias], this.$entity.persisted);\r\n                    }\r\n                } else if (this.$model.associations[i].type === 'hasMany') {\r\n                    if (this[alias] !== undefined && this[alias] instanceof Array) {\r\n                        for (a = 0; a < this[alias].length; a++) {\r\n                            if (!this[alias][a].$entity) {\r\n                                this[alias][a] = new ForeignModel.Entity(this[alias][a], this.$entity.persisted);\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        };\r\n\r\n        /**\r\n         * Expands a given association on an Entity\r\n         *\r\n         * @param {String} associationName The alias of the association to expand\r\n         * @returns {promise}\r\n         */\r\n        Entity.prototype.$expand = function (associationName) {\r\n            var association = this.$model.getAssociationByAlias(associationName);\r\n\r\n            if (!association) {\r\n                return $q.reject('Entity: $expand could not find the association.');\r\n            }\r\n\r\n            return association.expand(this);\r\n        };\r\n\r\n        /**\r\n         * Validates an entity against the model's field definition.\r\n         * @returns {Boolean} True if the model validation succeeds\r\n         */\r\n        Entity.prototype.$isValid = function () {\r\n            // TODO: This does not validate associations\r\n            var field;\r\n            var matchesType = false;\r\n            var fieldIsUndefined;\r\n            for (field in this.$model.fields) {\r\n                if (this.$model.fields.hasOwnProperty(field)) {\r\n                    fieldIsUndefined = (this[field] === null || this[field] === undefined);\r\n                    if (this.$model.fields[field].notNull === true && fieldIsUndefined) {\r\n                        $log.debug(\"Entity: $isValid returned false\", \"NotNull field was null\", field, this);\r\n                        return false;\r\n                    }\r\n                    switch (this.$model.fields[field].type) {\r\n                        case 'STRING':\r\n                            matchesType = typeof this[field] === 'string';\r\n                            break;\r\n                        case 'NUMBER':\r\n                            matchesType = typeof this[field] === 'number';\r\n                            break;\r\n                        case 'BOOLEAN':\r\n                            matchesType = this[field] === true || this[field] === false;\r\n                            break;\r\n                        case 'DATE':\r\n                            matchesType = this[field] instanceof Date || !isNaN(Date.parse(this[field]));\r\n                            break;\r\n                    }\r\n                    if (!matchesType && !fieldIsUndefined) {\r\n                        $log.debug(\"Entity: $isValid returned false\", field + \" was not a \" + this.$model.fields[field].type, this);\r\n                        return false;\r\n                    }\r\n                    if (typeof this.$model.fields[field].validate === \"function\" && !this.$model.fields[field].validate(this[field])) {\r\n                        $log.debug(\"Entity: $isValid returned false\", \"Custom validator failed\", field, this);\r\n                        return false;\r\n                    }\r\n                }\r\n            }\r\n            return true;\r\n        };\r\n\r\n        /**\r\n         * Persists the model with the adapter. This will update the model if it exists in the adapter or create\r\n         * the model if it does not exist.\r\n         *\r\n         * @method $save\r\n         * @param {PreparedQueryOptions} queryOptions\r\n         * @returns {promise} Resolves with the model\r\n         */\r\n        Entity.prototype.$save = function (queryOptions) {\r\n            var dfd = $q.defer();\r\n            var self = this;\r\n\r\n            if (!self.$isValid()) {\r\n                $log.warn(\"Entity: $save: aborted\", self, self[self.$model.primaryKeyFieldName]);\r\n                self.$reset();\r\n                return $q.reject(\"aborted\");\r\n            }\r\n\r\n            self.$entity.saveInProgress = true;\r\n            var itemToSave = self.$model.preSave(self);\r\n\r\n            var updateSavedState = function (entity, succeeded) {\r\n                entity.$entity.saveInProgress = false;\r\n                if (succeeded !== false) {\r\n                    entity.$storeState();\r\n                    entity.$entity.persisted = true;\r\n                } else {\r\n                    entity.$reset();\r\n                }\r\n            };\r\n\r\n            // The model exists in the DB\r\n            if (self.$entity.persisted && itemToSave[self.$model.primaryKeyFieldName]) {\r\n                itemToSave = self.$model.preUpdate(itemToSave);\r\n\r\n                var pk = itemToSave[self.$model.primaryKeyFieldName];\r\n                self.$model.adapter.update(self.$model, pk, itemToSave, queryOptions).then(function (response) {\r\n                    var result = self.$model.transformResult(response.data);\r\n                    self.$model.extendFromRawObject(self, result);\r\n                    updateSavedState(self, true);\r\n                    $log.debug(\"Entity: $save: update\", self, itemToSave, response);\r\n                    dfd.resolve(self);\r\n                }, function (e) {\r\n                    updateSavedState(self, false);\r\n                    $log.error(\"Entity: $save: update\", self, itemToSave, e);\r\n                    dfd.reject(e);\r\n                });\r\n            } else {\r\n                // The model is new\r\n                itemToSave = self.$model.preCreate(itemToSave);\r\n                self.$model.adapter.create(self.$model, itemToSave, queryOptions).then(function (response) {\r\n                    var result = self.$model.transformResult(response.data);\r\n                    self.$model.extendFromRawObject(self, result);\r\n                    updateSavedState(self, true);\r\n                    $log.debug(\"Entity: $save: create\", self, itemToSave, response);\r\n                    dfd.resolve(self);\r\n                }, function (e) {\r\n                    updateSavedState(self, false);\r\n                    $log.error(\"Entity: $save: create\", self, itemToSave, e);\r\n                    dfd.reject(e);\r\n                });\r\n            }\r\n\r\n            return dfd.promise;\r\n        };\r\n\r\n        /**\r\n         * Removes the model from the adapter.\r\n         *\r\n         * @method $remove\r\n         * @param {PreparedQueryOptions} queryOptions\r\n         * @returns {promise}\r\n         */\r\n        Entity.prototype.$remove = function (queryOptions) {\r\n            if (this[this.$model.primaryKeyFieldName]) {\r\n                return this.$model.adapter.remove(this.$model, this[this.$model.primaryKeyFieldName], queryOptions);\r\n            }\r\n            $log.error('Entity: $remove', 'The primary key was not found');\r\n            return $q.reject(\"The primary key was not found.\");\r\n        };\r\n\r\n        /**\r\n         * Stores the model's state so that it can later be reset to the state if needed. This is called\r\n         * on $save so that the model's state is always at the latest save point.\r\n         *\r\n         * @method $storeState\r\n         */\r\n        Entity.prototype.$storeState = function () {\r\n            this.$entity.storedState = this.$model.getRawModelObject(this, false);\r\n            this.$entity.lastDirtyCheck = new Date().getTime();\r\n            this.$entity.lastDirtyState = false;\r\n        };\r\n\r\n        /**\r\n         * Checks to see if the properties have diverged from the stored state. If so, this means that\r\n         * the properties have been changed and have not been saved.\r\n         *\r\n         * @method $isDirty\r\n         * @returns {Boolean} True if the properties are different than what is in the stored state.\r\n         */\r\n        Entity.prototype.$isDirty = function () {\r\n            if (this.$entity.saveInProgress) {\r\n                return false;\r\n            }\r\n\r\n            if (!this.$entity.storedState) {\r\n                return false;\r\n            }\r\n\r\n            var now = new Date().getTime();\r\n            var delta = now - this.$entity.lastDirtyCheck;\r\n            if (this.$entity.lastDirtyCheck && delta < this.$model.dirtyCheckThreshold) {\r\n                return this.$entity.lastDirtyState;\r\n            }\r\n\r\n            this.$entity.lastDirtyCheck = new Date().getTime();\r\n\r\n            // TODO: This does not dirty check associations\r\n            var field;\r\n            var viewValue;\r\n            var storedValue;\r\n            for (field in this.$model.fields) {\r\n                if (this.$model.fields.hasOwnProperty(field)) {\r\n                    storedValue = this.$entity.storedState[field];\r\n                    viewValue = this[field];\r\n\r\n                    if (storedValue !== viewValue) {\r\n                        $log.debug(\"Entity: $isDirty\", this[this.$model.primaryKeyFieldName], true, delta);\r\n                        this.$entity.lastDirtyState = true;\r\n                        return true;\r\n                    }\r\n                }\r\n            }\r\n\r\n            $log.debug(\"Entity: $isDirty\", this[this.$model.primaryKeyFieldName], false, delta);\r\n            this.$entity.lastDirtyState = false;\r\n            return false;\r\n        };\r\n\r\n        /**\r\n         * Resets a model back to its stored state. This will reset any pending changes back to the\r\n         * entities last save or initial retrieval.\r\n         *\r\n         * @method $reset\r\n         * @returns {Array} A list of the changed field names and their before and after values\r\n         */\r\n        Entity.prototype.$reset = function () {\r\n            if (!this.$entity.storedState) {\r\n                this.$storeState();\r\n                return [];\r\n            }\r\n\r\n            var prop;\r\n            var changedProperties = [];\r\n\r\n            for (prop in this.$entity.storedState) {\r\n                if (this.$entity.storedState.hasOwnProperty(prop) && this[prop] !== this.$entity.storedState[prop]) {\r\n                    changedProperties.push({\r\n                        name: prop,\r\n                        before: this[prop],\r\n                        after: this.$entity.storedState[prop]\r\n                    });\r\n                    this[prop] = this.$entity.storedState[prop];\r\n                }\r\n            }\r\n\r\n            this.$entity.lastDirtyState = false;\r\n            this.$entity.lastDirtyCheck = new Date().getTime();\r\n\r\n            $log.debug(\"Entity: $reset\", this[this.$model.primaryKeyFieldName], changedProperties);\r\n            return changedProperties;\r\n        };\r\n\r\n        return Entity;\r\n    }\r\n]);","angular.module('recall').factory('recallLocalStorage', [\r\n    '$document',\r\n    '$window',\r\n\r\n    function ($document, $window) {\r\n\r\n        /**\r\n         * The localStorage utility helps manage the storage and retrieval of registered application data.\r\n         */\r\n        var storage = {\r\n            keys: {\r\n                LAST_SYNC: 'LAST_SYNC'\r\n            }\r\n        };\r\n\r\n        /**\r\n         * Checks if the key is registered with the class.\r\n         *\r\n         * @param {String} key\r\n         * @returns {Boolean} True if the key exists\r\n         */\r\n        var keyExists = function (key) {\r\n            return storage.keys[key] !== undefined;\r\n        };\r\n\r\n        /**\r\n         * Appends a modifier to a key\r\n         * @param {String} key\r\n         * @param {String} modifier\r\n         * @returns {String} The key with the modifier appended.\r\n         */\r\n        var addKeyModifier = function (key, modifier) {\r\n            if (modifier) {\r\n                key += \"_\" + modifier;\r\n            }\r\n            return key;\r\n        };\r\n\r\n        /**\r\n         * Register a new key with the local storage service.\r\n         * @param {String} key\r\n         */\r\n        storage.registerKey = function (key) {\r\n            if (!keyExists(key)) {\r\n                storage.keys[key] = key;\r\n            }\r\n        };\r\n\r\n        /**\r\n         * Stores data by key in local browser storage.\r\n         *\r\n         * @param {String} key The key to use as the local storage name. Must be a key found in localStorage.keys.\r\n         * @param {String} value The string value to store.\r\n         * @param {String} keyModifier An additional identifier on the key.\r\n         */\r\n        storage.set = function (key, value, keyModifier) {\r\n            if (keyExists(key)) {\r\n                key = addKeyModifier(key, keyModifier);\r\n                if (storage.supportsLocalStorage()) {\r\n                    $window.localStorage.setItem(key, value);\r\n                } else {\r\n                    var life = 60 * 60 * 24 * 5;\r\n                    var v = encodeURIComponent(value);\r\n                    $document.cookie = key + '=' + v + '; max-age=' + life + ';';\r\n                }\r\n            }\r\n        };\r\n\r\n        /**\r\n         * Retrieves stored data by key.\r\n         *\r\n         * @param {String} key The key of the data to retrieve. Must be a key found in localStorage.keys.\r\n         * @param {String} keyModifier An additional identifier on the key.\r\n         * @return {String} The string value stored.\r\n         */\r\n        storage.get = function (key, keyModifier) {\r\n            var value = \"\";\r\n\r\n            if (keyExists(key)) {\r\n                key = addKeyModifier(key, keyModifier);\r\n                if (storage.supportsLocalStorage()) {\r\n                    value = $window.localStorage.getItem(key) || \"\";\r\n                } else {\r\n                    var regexp = new RegExp(key + \"=([^;]+)\", \"g\");\r\n                    var c = regexp.exec($document.cookie);\r\n\r\n                    if (c) {\r\n                        value = decodeURIComponent(c[1]) ;\r\n                    }\r\n                }\r\n            }\r\n\r\n            return value;\r\n        };\r\n\r\n        /**\r\n         * Removes stored data by key.\r\n         *\r\n         * @param {String} key The key of the data to remove. Must be a key found in localStorage.keys.\r\n         * @param {String} keyModifier An additional identifier on the key.\r\n         */\r\n        storage.remove = function (key, keyModifier) {\r\n            if (keyExists(key)) {\r\n                key = addKeyModifier(key, keyModifier);\r\n                if (storage.supportsLocalStorage()) {\r\n                    $window.localStorage.removeItem(key);\r\n                } else {\r\n                    $document.cookie = key + '=; max-age=0;';\r\n                }\r\n            }\r\n        };\r\n\r\n        /**\r\n         * Checks if the browser supports html5 local storage.\r\n         *\r\n         * @private\r\n         * @returns {Boolean} True if the browser does support html5 local storage.\r\n         */\r\n        storage.supportsLocalStorage = function () {\r\n            try {\r\n                return 'localStorage' in $window && $window.localStorage !== null;\r\n            } catch (e) {\r\n                return false;\r\n            }\r\n        };\r\n\r\n        return storage;\r\n    }\r\n]);","angular.module('recall').factory(\"recallModel\", [\r\n    '$log',\r\n    '$q',\r\n    'recallAssociation',\r\n    'recallEntity',\r\n    'recallModelField',\r\n\r\n    function ($log,\r\n              $q,\r\n              Association,\r\n              Entity,\r\n              ModelField) {\r\n\r\n        // Bubbles an error promise to the top.\r\n        var propagateError = function (e) {\r\n            return $q.reject(e);\r\n        };\r\n\r\n        /**\r\n         * A Model is in charge of defining a structure for a type of Entity. The model provides CRUD operations for\r\n         * that type of Entity as well as some other utility functions.\r\n         *\r\n         * Models should not be created directly. Instead, the recall service should be used as a proxy for creating\r\n         * models.\r\n         *\r\n         * @constructor\r\n         */\r\n        var Model = function (modelDefinition) {\r\n            this.modelName = modelDefinition.name;\r\n            this.dataSourceName = modelDefinition.dataSourceName || modelDefinition.name;\r\n\r\n            // Add the model definition to the Model as read only\r\n            Object.defineProperty(this, \"modelDefinition\", {value: modelDefinition, writable: false});\r\n\r\n            // Add a Constructor method to the Model for constructing new Entities from the Model: new Model.Entity();\r\n            var self = this;\r\n            Object.defineProperty(this, \"Entity\", {writable: false, configurable: false, value: function (obj, persisted) {\r\n                return( new Entity(obj, self, persisted === true) );\r\n            }});\r\n\r\n            this.fields = {};\r\n            this.associations = [];\r\n\r\n            this.dirtyCheckThreshold = 30;\r\n\r\n            this.primaryKeyFieldName = null;\r\n            this.lastModifiedFieldName = null;\r\n            this.deletedFieldName = null;\r\n            this.adapter = null;\r\n        };\r\n\r\n        Model.prototype.setLastModifiedFieldName = function (lastModifiedFieldName) {\r\n            this.lastModifiedFieldName = lastModifiedFieldName;\r\n        };\r\n\r\n        Model.prototype.setDeletedFieldName = function (deletedFieldName) {\r\n            this.deletedFieldName = deletedFieldName;\r\n        };\r\n\r\n        Model.prototype.setAdapter = function (adapter) {\r\n            this.adapter = adapter;\r\n        };\r\n\r\n        Model.prototype.setDirtyCheckThreshold = function (dirtyCheckThreshold) {\r\n            this.dirtyCheckThreshold = dirtyCheckThreshold;\r\n        };\r\n\r\n        // Initializes the fields using the common ModelField class\r\n        Model.prototype.initializeModelFields = function () {\r\n            var modelDefinitionFields = this.modelDefinition.fields;\r\n            var field;\r\n            var modelField;\r\n            var lastModifiedField;\r\n            var deletedField;\r\n            for (field in modelDefinitionFields) {\r\n                if (modelDefinitionFields.hasOwnProperty(field)) {\r\n                    modelField = new ModelField(field, modelDefinitionFields[field]);\r\n\r\n                    if (modelField.primaryKey) {\r\n                        this.primaryKeyFieldName = field;\r\n                    }\r\n\r\n                    if (modelField.invalid) {\r\n                        return false;\r\n                    } else {\r\n                        this.fields[field] = modelField;\r\n                    }\r\n\r\n                    if (field === this.lastModifiedFieldName) {\r\n                        lastModifiedField = modelField;\r\n                    }\r\n\r\n                    if (field === this.deletedFieldName) {\r\n                        deletedField = field;\r\n                    }\r\n                }\r\n            }\r\n            if (lastModifiedField && lastModifiedField.type !== \"DATE\") {\r\n                $log.error('Model: The last modified field is not a Date field');\r\n                return false;\r\n            }\r\n            if (this.lastModifiedFieldName && !lastModifiedField) {\r\n                this.fields[this.lastModifiedFieldName] = new ModelField(this.lastModifiedFieldName, {\r\n                    type: \"DATE\",\r\n                    index: true\r\n                });\r\n            }\r\n            if (deletedField && deletedField.type !== \"BOOLEAN\") {\r\n                $log.error('Model: The deletedField field is not a Boolean field');\r\n                return false;\r\n            }\r\n            if (this.deletedFieldName && !deletedField) {\r\n                this.fields[this.deletedFieldName] = new ModelField(this.deletedFieldName, {\r\n                    type: \"BOOLEAN\",\r\n                    index: true\r\n                });\r\n            }\r\n            return true;\r\n        };\r\n\r\n        // TODO: Support many to many associations\r\n        // Initialize the Model associations using the HasOneAssociation and HasManyAssociation classes\r\n        Model.prototype.initializeAssociations = function () {\r\n            var modelDefinitionAssociations = this.modelDefinition.associations;\r\n            if (!modelDefinitionAssociations) {\r\n                return;\r\n            }\r\n            var i;\r\n            var association;\r\n            for (i = 0; i < modelDefinitionAssociations.length; i++) {\r\n                association = new Association(modelDefinitionAssociations[i]);\r\n\r\n                if (association && !association.invalid) {\r\n                    if (association.type === 'hasOne') {\r\n                        if (!this.fields[association.mappedBy]) {\r\n                            // If no field is defined for the foreign key, define one assuming the same foreign key type.\r\n                            this.fields[association.mappedBy] = new ModelField(association.mappedBy, {\r\n                                type: this.fields[this.primaryKeyFieldName].type,\r\n                                index: association.mappedBy\r\n                            });\r\n                        } else {\r\n                            this.fields[association.mappedBy].index = association.mappedBy;\r\n                        }\r\n                    }\r\n\r\n                    this.associations.push(association);\r\n                }\r\n            }\r\n        };\r\n\r\n        /**\r\n         * Gets a Model Association by the alias name. The alias is defined as the \"as\" property on an alias if\r\n         * defined and falls back to the model name if \"as\" is not defined.\r\n         *\r\n         * @param {String} alias The association's alias\r\n         * @returns {Object} The association object\r\n         */\r\n        Model.prototype.getAssociationByAlias = function (alias) {\r\n            var i;\r\n            for (i = 0; i < this.associations.length; i++) {\r\n                if (this.associations[i].alias === alias) {\r\n                    return this.associations[i];\r\n                }\r\n            }\r\n            return null;\r\n        };\r\n\r\n        /**\r\n         * Extends an entity with a raw object. The raw object could be input from a controller or the result from\r\n         * an adapter.\r\n         *\r\n         * @param {Object} entity The entity to extend\r\n         * @param {Object} rawObject The object to extend from.\r\n         */\r\n        Model.prototype.extendFromRawObject = function (entity, rawObject) {\r\n            angular.extend(entity, this.getRawModelObject(rawObject));\r\n        };\r\n\r\n        /**\r\n         * Gets a raw representation of the model object to be used in adapter transactions. This returns an object\r\n         * in which only the Model defined fields are set. This also looks through expanded associations to set the\r\n         * foreignKey field for one to n associations and sets the association to the raw association object.\r\n         *\r\n         * @param {Object} modelEntity\r\n         * @param {Boolean} [includeExpandedAssociations = true] Include the expanded association in the raw object.\r\n         * @returns {Object} The raw object\r\n         */\r\n        Model.prototype.getRawModelObject = function (modelEntity, includeExpandedAssociations) {\r\n            var object = {};\r\n            var field;\r\n            for (field in this.fields) {\r\n                if (this.fields.hasOwnProperty(field)) {\r\n                    object[field] = modelEntity[field];\r\n                }\r\n            }\r\n            var i;\r\n            var alias;\r\n            var foreignKey;\r\n            var ForeignModel;\r\n            var a;\r\n            for (i = 0; i < this.associations.length; i++) {\r\n                alias = this.associations[i].alias;\r\n                ForeignModel = this.associations[i].getModel();\r\n\r\n                if (this.associations[i].type === 'hasOne') {\r\n                    if (modelEntity[alias] !== undefined) {\r\n                        foreignKey = modelEntity[alias][ForeignModel.primaryKeyFieldName];\r\n                        object[this.associations[i].mappedBy] = foreignKey;\r\n\r\n                        if (includeExpandedAssociations !== false) {\r\n                            object[alias] = ForeignModel.getRawModelObject(modelEntity[alias]);\r\n                        }\r\n                    }\r\n                } else if (this.associations[i].type === 'hasMany' && includeExpandedAssociations !== false) {\r\n                    if (modelEntity[alias] !== undefined && modelEntity[alias] instanceof Array) {\r\n                        object[alias] = [];\r\n                        for (a = 0; a < modelEntity[alias].length; a++) {\r\n                            object[alias].push(ForeignModel.getRawModelObject(modelEntity[alias][a]));\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n            return object;\r\n        };\r\n\r\n        /**\r\n         * Applies the default values on any undefined field in an entity.\r\n         *\r\n         * @param {Object} entity The entity to set the default values on\r\n         */\r\n        Model.prototype.applyDefaultValues = function (entity) {\r\n            var field;\r\n            for (field in this.fields) {\r\n                if (this.fields.hasOwnProperty(field)) {\r\n                    if (typeof this.fields[field].getDefaultValue === 'function' && entity[field] === undefined) {\r\n                        entity[field] = this.fields[field].getDefaultValue(entity);\r\n                    }\r\n                }\r\n            }\r\n        };\r\n\r\n        /**\r\n         * Transforms all objects returned by adapter transactions. This calls the transformResult function defined\r\n         * in the model. This also recursively calls transformResult on all associations.\r\n         *\r\n         * @method transformResult\r\n         * @param {Object} resultEntity\r\n         * @returns {Object} The transformed result\r\n         */\r\n        Model.prototype.transformResult = function (resultEntity) {\r\n            var i;\r\n            var alias;\r\n            var ForeignModel;\r\n            var a;\r\n            for (i = 0; i < this.associations.length; i++) {\r\n                alias = this.associations[i].alias;\r\n                ForeignModel = this.associations[i].getModel();\r\n\r\n                if (this.associations[i].type === 'hasOne') {\r\n                    if (resultEntity[alias] !== undefined) {\r\n                        resultEntity[alias] = ForeignModel.transformResult(resultEntity[alias]);\r\n                    }\r\n                } else if (this.associations[i].type === 'hasMany') {\r\n                    if (resultEntity[alias] !== undefined && resultEntity[alias] instanceof Array) {\r\n                        for (a = 0; a < resultEntity[alias].length; a++) {\r\n                            resultEntity[alias][a] = ForeignModel.transformResult(resultEntity[alias][a]);\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n\r\n            resultEntity = this.getRawModelObject(resultEntity);\r\n            if (typeof this.modelDefinition.transformResult === 'function') {\r\n                resultEntity = this.modelDefinition.transformResult(resultEntity);\r\n            }\r\n            return resultEntity;\r\n        };\r\n\r\n        /**\r\n         * Ran before the create and update adapter transactions. This calls the preSave function defined in the\r\n         * model.\r\n         *\r\n         * @method preSave\r\n         * @param {Object} entity\r\n         * @returns {Object} The raw transformed entity\r\n         */\r\n        Model.prototype.preSave = function (entity) {\r\n            entity = this.getRawModelObject(entity);\r\n            if (typeof this.modelDefinition.preSave === 'function') {\r\n                return this.modelDefinition.preSave(entity);\r\n            }\r\n            return entity;\r\n        };\r\n\r\n        /**\r\n         * Ran before the create adapter transaction. This applies the default values to any undefined fields and\r\n         * then calls the preCreate function defined in the model.\r\n         *\r\n         * @method preCreate\r\n         * @param {Object} rawEntity\r\n         * @returns {Object} The raw transformed entity\r\n         */\r\n        Model.prototype.preCreate = function (rawEntity) {\r\n            this.applyDefaultValues(rawEntity);\r\n            if (typeof this.modelDefinition.preCreate === 'function') {\r\n                return this.modelDefinition.preCreate(rawEntity);\r\n            }\r\n            return rawEntity;\r\n        };\r\n\r\n        /**\r\n         * Ran before the update adapter transaction. This calls the preUpdate function defined in the model.\r\n         *\r\n         * @method preUpdate\r\n         * @param {Object} rawEntity\r\n         * @returns {Object} The raw transformed entity\r\n         */\r\n        Model.prototype.preUpdate = function (rawEntity) {\r\n            if (typeof this.modelDefinition.preUpdate === 'function') {\r\n                return this.modelDefinition.preUpdate(rawEntity);\r\n            }\r\n            return rawEntity;\r\n        };\r\n\r\n        /**\r\n         * Retrieves a single model from the adapter given a primary key. Query options can be passed to determine\r\n         * select and expand operations.\r\n         *\r\n         * @method findOne\r\n         * @param {String} pk The primary key of the model to retrieve\r\n         * @param {Object} [queryOptions] Query options to use for retrieval\r\n         * @returns {promise} Resolves with the Entity\r\n         */\r\n        Model.prototype.findOne = function (pk, queryOptions) {\r\n            var self = this;\r\n            if (!pk) {\r\n                $log.error('Model: FindOne', 'The primary key was not supplied');\r\n                return $q.reject(\"The primary key was not supplied.\");\r\n            }\r\n\r\n            return this.adapter.findOne(this, pk, queryOptions).then(function (response) {\r\n                var result = self.transformResult(response.data);\r\n                var entity = new Entity(result, self, true);\r\n                $log.debug(\"Model: FindOne\", entity, response, queryOptions);\r\n                return entity;\r\n            }, propagateError);\r\n        };\r\n\r\n        /**\r\n         * Retrieves a list of models from the adapter. Query options can be passed to determine top, skip, order by,\r\n         * select, expand, and filter operations.\r\n         *\r\n         * @method find\r\n         * @param {Object} [queryOptions] Query options to use for retrieval\r\n         * @returns {promise} Resolves with data.results and data.totalCount where results are Entities\r\n         */\r\n        Model.prototype.find = function (queryOptions) {\r\n            var self = this;\r\n            return this.adapter.find(this, queryOptions).then(function (response) {\r\n                var results = [];\r\n                var i;\r\n                for (i = 0; i < response.data.length; i++) {\r\n                    results.push(new Entity(self.transformResult(response.data[i]), self, true));\r\n                }\r\n\r\n                var clientResponse = {\r\n                    results: results,\r\n                    totalCount: response.count\r\n                };\r\n                $log.debug(\"Model: Find\", clientResponse, response, queryOptions);\r\n                return clientResponse;\r\n            }, propagateError);\r\n        };\r\n\r\n        /**\r\n         * Removes the model from the adapter given a primary key.\r\n         *\r\n         * @method remove\r\n         * @param {String} pk The primary key of the model to remove\r\n         * @param {Object} [queryOptions] Query options\r\n         * @returns {promise}\r\n         */\r\n        Model.prototype.remove = function (pk, queryOptions) {\r\n            if (!pk) {\r\n                $log.error('Model: Remove', 'The primary key was not supplied');\r\n                return $q.reject(\"The primary key was not supplied.\");\r\n            }\r\n            return this.adapter.remove(this, pk, queryOptions);\r\n        };\r\n\r\n        return Model;\r\n    }\r\n]);","angular.module('recall').factory(\"recallModelField\", [\r\n    '$log',\r\n\r\n    function ($log) {\r\n\r\n        /**\r\n         * Model Field class to make all model fields consistent\r\n         * @param {String} name\r\n         * @param {Object | String} definition The Field Definition or the Field Type\r\n         * @constructor\r\n         */\r\n        var ModelField = function (name, definition) {\r\n            this.invalid = false;\r\n            this.name = name;\r\n\r\n            this.primaryKey = false;\r\n            this.unique = false;\r\n            this.index = false;\r\n            this.notNull = false;\r\n\r\n            if (typeof definition === 'string') {\r\n                this.type = definition.toUpperCase();\r\n            } else if (definition.primaryKey === true) {\r\n                asPrimaryKey(this, definition);\r\n            } else {\r\n                fromDefinition(this, definition);\r\n            }\r\n\r\n            if (!this.validateField()) {\r\n                $log.error('ModelField: The field definition is invalid', this, definition);\r\n            }\r\n        };\r\n\r\n        ModelField.prototype.validateField = function () {\r\n            if (!this.name || !this.type) {\r\n                this.invalid = true;\r\n                return false;\r\n            }\r\n            if (this.name.match(/[^\\w+]/) !== null) {\r\n                this.invalid = true;\r\n                return false;\r\n            }\r\n            this.invalid = false;\r\n            return true;\r\n        };\r\n\r\n        var asPrimaryKey = function (field, definition) {\r\n            // The adapter or the adapter's handler should enforce uniqueness of the primary key.\r\n            // The index on the primary key should be handled automatically without needing to specify an index.\r\n            // In order to pass validation during creation, the primary key should not be set as notNull.\r\n            // This of course should be enforced by the adapter or the adapter's handler.\r\n            field.primaryKey = true;\r\n            field.type = definition.type ? definition.type.toUpperCase() : null;\r\n            field.notNull = false;\r\n            field.unique = false;\r\n            field.index = false;\r\n\r\n            if (typeof definition.getDefaultValue === 'function') {\r\n                $log.warn('ModelField: getDefaultValue is ignored for the primary key');\r\n            }\r\n            if (typeof definition.validate === 'function') {\r\n                $log.warn('ModelField: validate is ignored for the primary key');\r\n            }\r\n        };\r\n\r\n        var fromDefinition = function (field, definition) {\r\n            field.type = definition.type ? definition.type.toUpperCase() : null;\r\n            field.unique = definition.unique === true;\r\n            field.index = (typeof definition.index === 'string') ? definition.index : (definition.index === true) ? field.name : false;\r\n            field.notNull = definition.notNull === true;\r\n\r\n            if (typeof definition.getDefaultValue === 'function') {\r\n                field.getDefaultValue = definition.getDefaultValue;\r\n            }\r\n            if (typeof definition.validate === 'function') {\r\n                field.validate = definition.validate;\r\n            }\r\n        };\r\n\r\n        return ModelField;\r\n    }\r\n]);","// Date.toISOString polyfill: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date/toISOString\r\nif (!Date.prototype.toISOString) {\r\n    (function () {\r\n\r\n        function pad(number) {\r\n            if (number < 10) {\r\n                return '0' + number;\r\n            }\r\n            return number;\r\n        }\r\n\r\n        Date.prototype.toISOString = function () {\r\n            return this.getUTCFullYear() +\r\n                '-' + pad(this.getUTCMonth() + 1) +\r\n                '-' + pad(this.getUTCDate()) +\r\n                'T' + pad(this.getUTCHours()) +\r\n                ':' + pad(this.getUTCMinutes()) +\r\n                ':' + pad(this.getUTCSeconds()) +\r\n                '.' + (this.getUTCMilliseconds() / 1000).toFixed(3).slice(2, 5) +\r\n                'Z';\r\n        };\r\n    }());\r\n}","angular.module('recall').factory('recallPredicate', [\r\n    function () {\r\n        /*\r\n         * BASED ON:\r\n         * Predicate\r\n         * version: 1.1.2\r\n         * author: David Hamilton\r\n         * license: https://github.com/nova706/PreparedQueryOptions/blob/master/LICENSE.txt (MIT)\r\n         * https://github.com/nova706/PreparedQueryOptions\r\n         *\r\n         */\r\n\r\n        /**\r\n         * A predicate is used for the $filter operator in a query. Predicates can be joined to query\r\n         * using a group of filters with the 'and' operator.\r\n         *\r\n         * This is a helper class for the PreparedQueryOptions class to assist in building complex\r\n         * filter clauses.\r\n         *\r\n         * @class Predicate\r\n         * @constructor\r\n         * @param {String} [property] The property to filter by.\r\n         * @param {Function} [parser] A function that returns the predicate string.\r\n         */\r\n        function Predicate(property, parser) {\r\n            this.property = property;\r\n            this.parser = parser;\r\n            return this;\r\n        }\r\n\r\n        /**\r\n         * Joins a provided set of predicates using the group operator and returns a new Predicate\r\n         *\r\n         * @method join\r\n         * @param {Predicate[]} predicates Array of predicates to join.\r\n         * @param {String} [groupOperator] The operator for the filter set ('and' 'or').\r\n         * @return {Predicate} Predicate object.\r\n         */\r\n        Predicate.join = function (predicates, groupOperator) {\r\n            if (predicates instanceof Array && predicates.length > 0) {\r\n                return new Predicate().join(predicates, groupOperator);\r\n            }\r\n            return null;\r\n        };\r\n\r\n        /**\r\n         * Sets the property of a predicate\r\n         *\r\n         * @method setProperty\r\n         * @param {String} property\r\n         * @return {Predicate} Predicate object.\r\n         */\r\n        Predicate.prototype.setProperty = function (property) {\r\n            this.property = property;\r\n            return this;\r\n        };\r\n\r\n        /**\r\n         * Modifies an existing predicate setting the operator to 'eq' and the value to the input parameter\r\n         *\r\n         * @method equals\r\n         * @param {String|Number|Boolean} (value) The value to match.\r\n         * @return {Predicate} Used for chaining function calls\r\n         */\r\n        Predicate.prototype.equals = function (value) {\r\n            this.parser = function () {\r\n                return this.property + ' eq ' + escapeValue(value);\r\n            };\r\n            return this;\r\n        };\r\n\r\n        /**\r\n         * Modifies an existing predicate setting the operator to 'ne' and the value to the input parameter\r\n         *\r\n         * @method notEqualTo\r\n         * @param {String|Number|Boolean} (value) The value to match.\r\n         * @return {Predicate} Used for chaining function calls\r\n         */\r\n        Predicate.prototype.notEqualTo = function (value) {\r\n            this.parser = function () {\r\n                return this.property + ' ne ' +  escapeValue(value);\r\n            };\r\n            return this;\r\n        };\r\n\r\n        /**\r\n         * Modifies an existing predicate setting the operator to 'gt' and the value to the input parameter\r\n         *\r\n         * @method greaterThan\r\n         * @param {String|Number|Boolean} (value) The value to match.\r\n         * @return {Predicate} Used for chaining function calls\r\n         */\r\n        Predicate.prototype.greaterThan = function (value) {\r\n            this.parser = function () {\r\n                return this.property + ' gt ' +  escapeValue(value);\r\n            };\r\n            return this;\r\n        };\r\n\r\n        /**\r\n         * Modifies an existing predicate setting the operator to 'ge' and the value to the input parameter\r\n         *\r\n         * @method greaterThanOrEqualTo\r\n         * @param {String|Number|Boolean} (value) The value to match.\r\n         * @return {Predicate} Used for chaining function calls\r\n         */\r\n        Predicate.prototype.greaterThanOrEqualTo = function (value) {\r\n            this.parser = function () {\r\n                return this.property + ' ge ' +  escapeValue(value);\r\n            };\r\n            return this;\r\n        };\r\n\r\n        /**\r\n         * Modifies an existing predicate setting the operator to 'lt' and the value to the input parameter\r\n         *\r\n         * @method lessThan\r\n         * @param {String|Number|Boolean} (value) The value to match.\r\n         * @return {Predicate} Used for chaining function calls\r\n         */\r\n        Predicate.prototype.lessThan = function (value) {\r\n            this.parser = function () {\r\n                return this.property + ' lt ' +  escapeValue(value);\r\n            };\r\n            return this;\r\n        };\r\n\r\n        /**\r\n         * Modifies an existing predicate setting the operator to 'le' and the value to the input parameter\r\n         *\r\n         * @method lessThanOrEqualTo\r\n         * @param {String|Number|Boolean} (value) The value to match.\r\n         * @return {Predicate} Used for chaining function calls\r\n         */\r\n        Predicate.prototype.lessThanOrEqualTo = function (value) {\r\n            this.parser = function () {\r\n                return this.property + ' le ' +  escapeValue(value);\r\n            };\r\n            return this;\r\n        };\r\n\r\n        /**\r\n         * Modifies an existing predicate setting the operation to substringof and the value to the input parameter\r\n         *\r\n         * @method contains\r\n         * @param {String|Number|Boolean} (value) The value to match.\r\n         * @return {Predicate} Used for chaining function calls\r\n         */\r\n        Predicate.prototype.contains = function (value) {\r\n            this.parser = function () {\r\n                return 'substringof(' +  escapeValue(value) + ', ' + this.property + ')';\r\n            };\r\n            return this;\r\n        };\r\n\r\n        /**\r\n         * Modifies an existing predicate setting the operation to startswith and the value to the input parameter\r\n         *\r\n         * @method startsWith\r\n         * @param {String|Number|Boolean} (value) The value to match.\r\n         * @return {Predicate} Used for chaining function calls\r\n         */\r\n        Predicate.prototype.startsWith = function (value) {\r\n            this.parser = function () {\r\n                return 'startswith(' + this.property + ', ' +  escapeValue(value) + ')';\r\n            };\r\n            return this;\r\n        };\r\n\r\n        /**\r\n         * Modifies an existing predicate setting the operation to endswith and the value to the input parameter\r\n         *\r\n         * @method startsWith\r\n         * @param {String|Number|Boolean} (value) The value to match.\r\n         * @return {Predicate} Used for chaining function calls\r\n         */\r\n        Predicate.prototype.endsWith = function (value) {\r\n            this.parser = function () {\r\n                return 'endswith(' + this.property + ', ' +  escapeValue(value) + ')';\r\n            };\r\n            return this;\r\n        };\r\n\r\n        /**\r\n         * Joins an existing predicate with additional predicates using the group operator\r\n         *\r\n         * @method join\r\n         * @param {Predicate|Predicate[]} predicates A single predicate or an array of predicates to join to the existing one.\r\n         * @param {String} [groupOperator] The operator for the filter set ('and' 'or').\r\n         * @return {Predicate} Used for chaining function calls\r\n         */\r\n        Predicate.prototype.join = function (predicates, groupOperator) {\r\n            var initialPredicate;\r\n\r\n            if (this.property && typeof this.parser === 'function') {\r\n                initialPredicate = new Predicate(this.property, this.parser);\r\n            }\r\n\r\n            var newPredicates = [];\r\n            if (predicates instanceof Predicate) {\r\n                newPredicates.push(predicates);\r\n            } else if (predicates instanceof Array && predicates.length > 0) {\r\n                var i;\r\n                for (i = 0; i < predicates.length; i++) {\r\n                    if (predicates[i]) {\r\n                        newPredicates.push(predicates[i]);\r\n                    }\r\n                }\r\n            }\r\n\r\n            if (newPredicates.length > 0) {\r\n                delete this.parser;\r\n                delete this.property;\r\n\r\n                this.joinedPredicates = (this.joinedPredicates) ? this.joinedPredicates.concat(newPredicates) : newPredicates;\r\n                if (groupOperator || !this.groupOperator) {\r\n                    this.groupOperator = (groupOperator === 'or') ? 'or' : 'and';\r\n                }\r\n                if (initialPredicate) {\r\n                    this.joinedPredicates.unshift(initialPredicate);\r\n                }\r\n            }\r\n\r\n            return this;\r\n        };\r\n\r\n        /**\r\n         * Joins an existing predicate with additional predicates using the 'and' group operator\r\n         *\r\n         * @method and\r\n         * @param {Predicate|Predicate[]} predicates A single predicate or an array of predicates to join to the existing one.\r\n         * @return {Predicate} Used for chaining function calls\r\n         */\r\n        Predicate.prototype.and = function (predicates) {\r\n            return this.join(predicates, 'and');\r\n        };\r\n\r\n        /**\r\n         * Joins an existing predicate with additional predicates using the 'or' group operator\r\n         *\r\n         * @method or\r\n         * @param {Predicate|Predicate[]} predicates A single predicate or an array of predicates to join to the existing one.\r\n         * @return {Predicate} Used for chaining function calls\r\n         */\r\n        Predicate.prototype.or = function (predicates) {\r\n            return this.join(predicates, 'or');\r\n        };\r\n\r\n        /**\r\n         * Evaluate an object to see if it matches the predicate filter conditions.\r\n         *\r\n         * @method test\r\n         * @param {Object} object The object to test against the predicate.\r\n         * @param {Boolean} [failOnMissingAssociation=true] Should the test fail when the a filter is performed against an expanded association that is not present\r\n         * @return {Boolean} True if the object matches the filter conditions.\r\n         */\r\n        Predicate.prototype.test = function (object, failOnMissingAssociation) {\r\n            return testPredicate(this, object, failOnMissingAssociation);\r\n        };\r\n\r\n        /**\r\n         * Builds and returns a URL parameter string based on the predicate.\r\n         *\r\n         * @method parsePredicate\r\n         * @param {Boolean} [nested = false] Used for building the nested group during recursion\r\n         * @returns {String}\r\n         */\r\n        Predicate.prototype.parsePredicate = function (nested) {\r\n            nested = (nested === true);\r\n            var urlString = '';\r\n\r\n            if (this.property && typeof this.parser === 'function') {\r\n                return this.parser();\r\n            }\r\n\r\n            if (this.joinedPredicates && this.joinedPredicates.length > 0) {\r\n                var i;\r\n                var predicate;\r\n                var predicateString;\r\n                for (i = 0; i < this.joinedPredicates.length; i++) {\r\n                    predicate = this.joinedPredicates[i];\r\n                    predicateString = predicate.parsePredicate(true);\r\n                    urlString += (i > 0) ? ' ' + this.groupOperator + ' ' + predicateString : predicateString;\r\n                }\r\n            }\r\n\r\n            return nested ? '(' + urlString + ')' : urlString;\r\n        };\r\n\r\n        /**\r\n         * Creates a predicate structure from a string\r\n         *\r\n         * @method fromString\r\n         * @param {String} predicateString\r\n         * @return {Predicate|null} null if the predicate could not be built from the string\r\n         */\r\n        Predicate.fromString = function (predicateString) {\r\n            if (typeof predicateString !== \"string\") {\r\n                return null;\r\n            }\r\n\r\n            // Extract all the filters out of the predicate string\r\n            var conditionMatcher = new RegExp(\"(substringof\\\\(.+?\\\\)|startswith\\\\(.+?\\\\)|endswith\\\\(.+?\\\\)|[\\\\w\\\\.]+?\\\\s(?:eq|ne|gt|ge|lt|le)\\\\s(?:\\\\w+|\\\\'.+?\\\\'))\", \"g\");\r\n            var filters = predicateString.match(conditionMatcher);\r\n\r\n            if (!filters) {\r\n                return null;\r\n            }\r\n\r\n            // Convert each filter into a predicate\r\n            var i;\r\n            for (i = 0; i < filters.length; i++) {\r\n                filters[i] = getPredicateFromSegment(filters[i]);\r\n                if (filters[i] === null) {\r\n                    return null;\r\n                }\r\n            }\r\n\r\n            if (filters.length === 0) {\r\n                return null;\r\n            }\r\n\r\n            // Remove all predicates from string\r\n            i = 0;\r\n            predicateString = predicateString.replace(conditionMatcher, function () {\r\n                return i++;\r\n            });\r\n\r\n            if (filters.length === 1) {\r\n                if (predicateString.replace(/[0-9]|\\s|and|or/g, \"\") !== \"\") {\r\n                    return null;\r\n                }\r\n                return filters[0];\r\n            }\r\n\r\n            return buildPredicateFromMap(predicateString, filters);\r\n        };\r\n\r\n        /**\r\n         * Builds a predicate based on a predicate map and array of extracted filters\r\n         * @param {String} predicateMap A String representing a map of a predicate where the indexes map to the filters array\r\n         *                              \"1 and (2 or 3)\" where filters.length === 3\r\n         * @param {Predicate[]} filters An array of Predicates whose index map to the indexes on the predicateMap\r\n         * @returns {Predicate|Null} The resulting Predicate or null if the map is invalid\r\n         */\r\n        var buildPredicateFromMap = function (predicateMap, filters) {\r\n            var closeParenthesisIndex;\r\n            var openParenthesisIndex;\r\n            var groupString;\r\n            var filterIndexes;\r\n            var groupPredicate = null;\r\n            var groupFilters;\r\n            var operator;\r\n            var testNextLevel = true;\r\n\r\n            while (testNextLevel) {\r\n                closeParenthesisIndex = predicateMap.indexOf(')');\r\n                if (closeParenthesisIndex !== -1) {\r\n                    openParenthesisIndex = predicateMap.lastIndexOf('(', closeParenthesisIndex);\r\n                    groupString = predicateMap.substring(openParenthesisIndex + 1, closeParenthesisIndex);\r\n                    predicateMap = predicateMap.substring(0, openParenthesisIndex) + filters.length + predicateMap.substring(closeParenthesisIndex + 1);\r\n                } else {\r\n                    groupString = predicateMap;\r\n                    testNextLevel = false;\r\n                }\r\n\r\n                // If the group contains invalid characters then return null as an invalid predicate string.\r\n                if (groupString.replace(/[0-9]|\\s|and|or/g, \"\") !== \"\") {\r\n                    return null;\r\n                }\r\n\r\n                // If the group uses both 'and' and 'or' then return null as an invalid predicate string.\r\n                if (groupString.indexOf('and') >= 0 && groupString.indexOf('or') >= 0) {\r\n                    return null;\r\n                }\r\n\r\n                filterIndexes = groupString.match(/[0-9]+/g);\r\n                groupFilters = [];\r\n                var i;\r\n                for (i = 0; i < filterIndexes.length; i++) {\r\n                    groupFilters.push(filters[Number(filterIndexes[i])]);\r\n                }\r\n                operator = groupString.indexOf('or') >= 0 ? 'or' : 'and';\r\n                groupPredicate = new Predicate().join(groupFilters, operator);\r\n                filters.push(groupPredicate);\r\n            }\r\n\r\n            return groupPredicate;\r\n        };\r\n\r\n        /**\r\n         * Takes a predicate's value and if it is a string, adds single quotes around it.\r\n         *\r\n         * @method escapeValue\r\n         * @param {String|Boolean|Number|Date} value\r\n         * @returns {string} The string value\r\n         */\r\n        var escapeValue = function (value) {\r\n            if (value instanceof Date) {\r\n                value = value.toISOString();\r\n            }\r\n            return (typeof value === 'string') ? \"'\" + value + \"'\" : value.toString();\r\n        };\r\n\r\n        /**\r\n         * Returns the raw value of the predicate string\r\n         *\r\n         * @method convertValueToType\r\n         * @param {String} value\r\n         * @returns {String|Boolean|Number}\r\n         */\r\n        var convertValueToType = function (value) {\r\n            if (typeof value === 'string') {\r\n                if (value.indexOf(\"'\") >= 0) {\r\n                    return value.replace(/\\'/g, '');\r\n                }\r\n                if (value.toLowerCase() === 'true') {\r\n                    return true;\r\n                }\r\n                if (value.toLowerCase() === 'false') {\r\n                    return false;\r\n                }\r\n            }\r\n            if (!isNaN(value)) {\r\n                return Number(value);\r\n            }\r\n            return value;\r\n        };\r\n\r\n        /**\r\n         * Tests a predicate group to see if the object matches\r\n         * @param {Predicate} predicate\r\n         * @param {Object} object\r\n         * @returns {Boolean} True if the object matches the predicate\r\n         */\r\n        var testPredicateGroup = function (predicate, object) {\r\n            var result;\r\n            var i;\r\n            for (i = 0; i < predicate.joinedPredicates.length; i++) {\r\n                result = testPredicate(predicate.joinedPredicates[i], object);\r\n\r\n                // If the operator is 'and' and any of the filters do not match, return false.\r\n                if (predicate.groupOperator === 'and' && result === false) {\r\n                    return false;\r\n                }\r\n\r\n                // If the operator is 'or' and any of the filters match, return true.\r\n                if (predicate.groupOperator === 'or' && result === true) {\r\n                    return true;\r\n                }\r\n            }\r\n\r\n            // The operator was 'and' and all of the filters matched or the operator was 'or' and none of the filters matched.\r\n            return predicate.groupOperator === 'and';\r\n        };\r\n\r\n        /**\r\n         * Tests an object to see if the filter conditions match a given predicate. Used for recursive tests.\r\n         *\r\n         * @param {Predicate} predicate\r\n         * @param {Object} object\r\n         * @param {Boolean} [failOnMissingAssociation=true] Should the test fail when the a filter is performed against an expanded association that is not present\r\n         */\r\n        var testPredicate = function (predicate, object, failOnMissingAssociation) {\r\n            if (predicate.joinedPredicates && predicate.joinedPredicates.length > 0) {\r\n                return testPredicateGroup(predicate, object);\r\n            }\r\n            if (predicate.property) {\r\n                var propertyPath = predicate.property.split('.');\r\n                var objectValue = object;\r\n                var i;\r\n                for (i = 0; i < propertyPath.length; i++) {\r\n                    if (objectValue.hasOwnProperty(propertyPath[i]) && objectValue[propertyPath[i]] !== undefined) {\r\n                        objectValue = objectValue[propertyPath[i]];\r\n                    } else {\r\n                        return (failOnMissingAssociation === false);\r\n                    }\r\n                }\r\n\r\n                var condition = predicate.parsePredicate();\r\n                if (condition.indexOf('(') >= 0) {\r\n                    return testComplexPredicate(condition, objectValue);\r\n                }\r\n                return testSimplePredicate(condition, objectValue);\r\n            }\r\n\r\n            return false;\r\n        };\r\n\r\n        /**\r\n         * Tests a complex predicate that uses startswith, endswith, or substringof\r\n         * @param {String} condition The Predicate condition\r\n         * @param {String|Number|Boolean} objectValue The value that is being tested\r\n         * @returns {Boolean} True if the object value matches the condition\r\n         */\r\n        var testComplexPredicate = function (condition, objectValue) {\r\n            var value;\r\n            var operator = condition.substr(0, condition.indexOf('('));\r\n            var start = condition.indexOf('(') + 1;\r\n            var end = condition.indexOf(')') - start;\r\n            var conditionParams = condition.substr(start, end);\r\n            conditionParams = conditionParams.replace(/\\'/g, '').split(', ');\r\n\r\n            switch (operator) {\r\n                case 'startswith':\r\n                    value = conditionParams[1].toLowerCase();\r\n                    return (objectValue.indexOf(value) === 0);\r\n                case 'endswith':\r\n                    value = conditionParams[1].toLowerCase();\r\n                    return (objectValue.indexOf(value) === objectValue.length - 1 - value.length);\r\n                case 'substringof':\r\n                    value = conditionParams[0].toLowerCase();\r\n                    return (objectValue.indexOf(value) >= 0);\r\n            }\r\n\r\n            return false;\r\n        };\r\n\r\n        /**\r\n         * Tests a simple predicate that uses lt, gt, le, ge, ne, or eq\r\n         * @param {String} condition The Predicate condition\r\n         * @param {String|Number|Boolean} objectValue The value that is being tested\r\n         * @returns {Boolean} True if the object value matches the condition\r\n         */\r\n        var testSimplePredicate = function (condition, objectValue) {\r\n            var conditionParams = condition.split(' ');\r\n            var operator = conditionParams[1];\r\n\r\n            var value = conditionParams.slice(2).join(' ');\r\n            value = convertValueToType(value);\r\n\r\n            // If both the predicate value and the object values are Date-like, convert them to dates to compare\r\n            if (objectValue instanceof Date && !isNaN(Date.parse(value))) {\r\n                value = Date.parse(value);\r\n                objectValue = objectValue.getTime();\r\n            } else if (typeof objectValue === 'string' && !isNaN(Date.parse(objectValue))) {\r\n                objectValue = Date.parse(objectValue);\r\n                value = Date.parse(value);\r\n            }\r\n\r\n            /* jshint eqeqeq: false */\r\n            switch (operator) {\r\n                case 'lt':\r\n                    return objectValue < value;\r\n                case 'gt':\r\n                    return objectValue > value;\r\n                case 'le':\r\n                    return objectValue <= value;\r\n                case 'ge':\r\n                    return objectValue >= value;\r\n                case 'ne':\r\n                    return objectValue != value;\r\n                case 'eq':\r\n                    return objectValue == value;\r\n            }\r\n            /* jshint eqeqeq: true */\r\n\r\n            return false;\r\n        };\r\n\r\n        /**\r\n         * Builds a predicate from a complex segment that uses startswith, endswith, or substringof\r\n         * @param {String} condition The predicate condition\r\n         * @returns {Predicate} The resulting Predicate\r\n         */\r\n        var getComplexPredicateFromSegment = function (condition) {\r\n            var predicate;\r\n            var value;\r\n            var parenPos = condition.indexOf('(');\r\n            var operator = condition.substring(0, parenPos);\r\n            var conditionParams = condition.substring(parenPos + 1, condition.indexOf(')')).split(', ');\r\n\r\n            switch (operator) {\r\n                case 'startswith':\r\n                    value = convertValueToType(conditionParams[1]);\r\n                    predicate = new Predicate(conditionParams[0]).startsWith(value);\r\n                    break;\r\n                case 'endswith':\r\n                    value = convertValueToType(conditionParams[1]);\r\n                    predicate = new Predicate(conditionParams[0]).endsWith(value);\r\n                    break;\r\n                case 'substringof':\r\n                    value = convertValueToType(conditionParams[0]);\r\n                    predicate = new Predicate(conditionParams[1]).contains(value);\r\n                    break;\r\n            }\r\n\r\n            return predicate;\r\n        };\r\n\r\n        /**\r\n         * Builds a predicate from a simple segment that uses eq, ne, gt, ge, lt, or le\r\n         * @param {String} condition The predicate condition\r\n         * @returns {Predicate} The resulting Predicate\r\n         */\r\n        var getSimplePredicateFromSegment = function (condition) {\r\n            var conditionParams = condition.split(' ');\r\n            var operator = conditionParams[1];\r\n            var value = convertValueToType(conditionParams.slice(2).join(' '));\r\n\r\n            var predicate = new Predicate(conditionParams[0]);\r\n\r\n            switch (operator) {\r\n                case 'eq':\r\n                    predicate.equals(value);\r\n                    break;\r\n                case 'ne':\r\n                    predicate.notEqualTo(value);\r\n                    break;\r\n                case 'gt':\r\n                    predicate.greaterThan(value);\r\n                    break;\r\n                case 'ge':\r\n                    predicate.greaterThanOrEqualTo(value);\r\n                    break;\r\n                case 'lt':\r\n                    predicate.lessThan(value);\r\n                    break;\r\n                case 'le':\r\n                    predicate.lessThanOrEqualTo(value);\r\n                    break;\r\n            }\r\n            return predicate;\r\n        };\r\n\r\n        /**\r\n         * Creates a predicate from a single condition eg: \"property eq 'value'\"\r\n         *\r\n         * @param {String} condition\r\n         * @return {Predicate} The predicate built from the condition\r\n         */\r\n        var getPredicateFromSegment = function (condition) {\r\n            if (condition.indexOf('(') >= 0) {\r\n                return getComplexPredicateFromSegment(condition);\r\n            }\r\n            return getSimplePredicateFromSegment(condition);\r\n        };\r\n\r\n        return Predicate;\r\n    }\r\n]);","angular.module('recall').factory('recallPreparedQueryOptions', [\r\n    'recallPredicate',\r\n\r\n    function (Predicate) {\r\n        /*\r\n         * BASED ON:\r\n         * PreparedQueryOptions\r\n         * version: 1.1.2\r\n         * author: David Hamilton\r\n         * license: https://github.com/nova706/PreparedQueryOptions/blob/master/LICENSE.txt (MIT)\r\n         * https://github.com/nova706/PreparedQueryOptions\r\n         *\r\n         */\r\n\r\n        /**\r\n         * PreparedQueryOptions are used to set, store and parse OData query parameters. Instead of passing\r\n         * multiple arguments to methods for each query option, simply pass the preparedQueryOptions object.\r\n         * Use the parseOptions method on the object to return an OData string for a query.\r\n         *\r\n         * @class PreparedQueryOptions\r\n         * @constructor\r\n         */\r\n        function PreparedQueryOptions() {\r\n            /**\r\n             * Stores the query options that have been set.\r\n             * @property options\r\n             * @type Object\r\n             * @default {}\r\n             */\r\n            this.options = {};\r\n        }\r\n\r\n        var isPredicate = function (object) {\r\n            return object && typeof object === \"object\" && typeof object.parsePredicate === \"function\";\r\n        };\r\n\r\n        /**\r\n         * Used in Sync Adapters to perform the CRUD operation against the Master instead of the Slave.\r\n         *\r\n         * @method preferMaster\r\n         * @param {Boolean} [preferMaster=false] Whether the SyncAdapter should prefer the slave or master.\r\n         * @return {PreparedQueryOptions|Boolean} PreparedQueryOptions object or the current preferMaster value.\r\n         */\r\n        PreparedQueryOptions.prototype.preferMaster = function (preferMaster) {\r\n            if (arguments.length === 0) {\r\n                return this.options.preferMaster || null;\r\n            }\r\n            if (preferMaster === null) {\r\n                delete this.options.preferMaster;\r\n                return this;\r\n            }\r\n            this.options.preferMaster = preferMaster === true;\r\n            return this;\r\n        };\r\n\r\n        /**\r\n         * Sets the number of results to retrieve. Passing a null top value will clear the top option. Negating the value\r\n         * will return the current top value.\r\n         *\r\n         * @method $top\r\n         * @param {Number} [top] Number of results to query for.\r\n         * @return {PreparedQueryOptions|Number} PreparedQueryOptions object or the current $top value.\r\n         */\r\n        PreparedQueryOptions.prototype.$top = function (top) {\r\n            if (arguments.length === 0) {\r\n                return this.options.$top || null;\r\n            }\r\n            if (typeof top === 'number' && top >= 0) {\r\n                this.options.$top = top;\r\n            }\r\n            if (top === null) {\r\n                delete this.options.$top;\r\n            }\r\n            return this;\r\n        };\r\n\r\n        /**\r\n         * Sets the index of the first result to retrieve. Passing a null skip value will clear the skip option. Negating the\r\n         * value will return the current skip value.\r\n         *\r\n         * @method $skip\r\n         * @param {Number} [skip] The index of the first result to retrieve\r\n         * @return {PreparedQueryOptions|Number} PreparedQueryOptions object or the current $skip value.\r\n         */\r\n        PreparedQueryOptions.prototype.$skip = function (skip) {\r\n            if (arguments.length === 0) {\r\n                return this.options.$skip || null;\r\n            }\r\n            if (typeof skip === 'number' && skip >= 0) {\r\n                this.options.$skip = skip;\r\n            }\r\n            if (skip === null) {\r\n                delete this.options.$skip;\r\n            }\r\n            return this;\r\n        };\r\n\r\n        /**\r\n         * Sets orderBy string. Passing a null order by value will clear the order by option. Negating the value will return\r\n         * the current order by value.\r\n         *\r\n         * @method $orderBy\r\n         * @param {String} [orderBy] The orderBy string used to retrieve the results in a sorted order.\r\n         * @return {PreparedQueryOptions|String} PreparedQueryOptions object or the current $orderby value.\r\n         */\r\n        PreparedQueryOptions.prototype.$orderBy = function (orderBy) {\r\n            if (arguments.length === 0) {\r\n                return this.options.$orderby || null;\r\n            }\r\n            if (orderBy && typeof orderBy === 'string') {\r\n                this.options.$orderby = orderBy;\r\n            }\r\n            if (orderBy === null) {\r\n                delete this.options.$orderby;\r\n            }\r\n            return this;\r\n        };\r\n\r\n        /**\r\n         * Sets expand string. Passing a null expand value will clear the expand option. Negating the value will return the\r\n         * current expand value.\r\n         *\r\n         * @method $expand\r\n         * @param {String | Array} [foreignKey] The foreignKey to expand when retrieving the results.\r\n         * @return {PreparedQueryOptions|String} PreparedQueryOptions object or the current $expand value.\r\n         */\r\n        PreparedQueryOptions.prototype.$expand = function (foreignKey) {\r\n            if (arguments.length === 0) {\r\n                return this.options.$expand || null;\r\n            }\r\n            if (typeof foreignKey === 'string') {\r\n                this.options.$expand = foreignKey;\r\n            } else if (foreignKey instanceof Array) {\r\n                this.options.$expand = foreignKey.join(',');\r\n            }\r\n            if (foreignKey === null) {\r\n                delete this.options.$expand;\r\n            }\r\n            return this;\r\n        };\r\n\r\n        /**\r\n         * Sets select string. Passing a null select value will clear the select option. Negating the value will return the\r\n         * current select value.\r\n         *\r\n         * @method $select\r\n         * @param {String | Array} [property] A single property name or array of property names to select.\r\n         * @return {PreparedQueryOptions|String} PreparedQueryOptions object or the current $select value.\r\n         */\r\n        PreparedQueryOptions.prototype.$select = function (property) {\r\n            if (arguments.length === 0) {\r\n                return this.options.$select || null;\r\n            }\r\n            if (typeof property === 'string') {\r\n                this.options.$select = property;\r\n            } else if (property instanceof Array) {\r\n                this.options.$select = property.join(',');\r\n            }\r\n            if (property === null) {\r\n                delete this.options.$select;\r\n            }\r\n            return this;\r\n        };\r\n\r\n        /**\r\n         * Enables or disables inline count. Passing a null inline count value will clear the inline count option. Negating\r\n         * the value will return the current inline count value: \"allpages\" or null.\r\n         *\r\n         * @method $inlineCount\r\n         * @param {Boolean} [enable=true] Flag to enable or disable inline count.\r\n         * @return {PreparedQueryOptions|String} PreparedQueryOptions object or the current $inlinecount value.\r\n         */\r\n        PreparedQueryOptions.prototype.$inlineCount = function (enable) {\r\n            if (arguments.length === 0) {\r\n                return this.options.$inlinecount || null;\r\n            }\r\n            if (enable !== false && enable !== null) {\r\n                this.options.$inlinecount = \"allpages\";\r\n            } else {\r\n                delete this.options.$inlinecount;\r\n            }\r\n            return this;\r\n        };\r\n\r\n        /**\r\n         * Sets the filter option. Include the Predicate class to assist in building complex filter clauses.\r\n         * Passing a null filter value will clear the filter option. Negating the value will return the current filter value.\r\n         *\r\n         * @method $filter\r\n         * @param {String | Predicate} [filter] The filter clause to use when retrieving the results.\r\n         * @return {PreparedQueryOptions|Predicate} PreparedQueryOptions object or the current $filter predicate.\r\n         */\r\n        PreparedQueryOptions.prototype.$filter = function (filter) {\r\n            if (arguments.length === 0) {\r\n                return this.options.$filter || null;\r\n            }\r\n            if (filter && typeof filter === 'string') {\r\n                this.options.$filter = Predicate.fromString(filter);\r\n            } else if (isPredicate(filter)) {\r\n                this.options.$filter = filter;\r\n            }\r\n            if (filter === null) {\r\n                delete this.options.$filter;\r\n            }\r\n            return this;\r\n        };\r\n\r\n        /**\r\n         * Sets a custom query option parameter. Passing a null value will clear the filter. Negating the value will return\r\n         * the current custom filter value.\r\n         *\r\n         * @method custom\r\n         * @param {String} optionName The name of the option. Must not start with '$'.\r\n         * @param {String|Number|Boolean} [value] The string value of the option.\r\n         * @return {PreparedQueryOptions} PreparedQueryOptions object or the current custom filter value.\r\n         */\r\n        PreparedQueryOptions.prototype.custom = function (optionName, value) {\r\n            if (arguments.length === 1) {\r\n                return this.options[optionName] || null;\r\n            }\r\n            if (optionName && typeof optionName === 'string' && optionName.indexOf('$') !== 0 && value && (typeof value === 'string' || typeof value === 'number' || typeof value === 'boolean')) {\r\n                this.options[optionName] = value;\r\n            }\r\n            if (optionName && value === null) {\r\n                delete this.options[optionName];\r\n            }\r\n            return this;\r\n        };\r\n\r\n        /**\r\n         * Extend existing query with options from another query. Only the original query will be modified. Any\r\n         * matching options will be overridden in the original query.\r\n         *\r\n         * @method extend\r\n         * @param {PreparedQueryOptions} preparedQueryOptions The prepared query objects with the properties to be added.\r\n         * @return {PreparedQueryOptions} PreparedQueryOptions object.\r\n         */\r\n        PreparedQueryOptions.prototype.extend = function (preparedQueryOptions) {\r\n            var key;\r\n            for (key in preparedQueryOptions.options) {\r\n                if (preparedQueryOptions.options.hasOwnProperty(key)) {\r\n                    this.options[key] = preparedQueryOptions.options[key];\r\n                }\r\n            }\r\n            return this;\r\n        };\r\n\r\n        /**\r\n         * Builds and returns a URL parameter string based on the query options.\r\n         *\r\n         * @method parseOptions\r\n         * @returns {String}\r\n         * @example '$top=25&$skip=0'\r\n         */\r\n        PreparedQueryOptions.prototype.parseOptions = function () {\r\n            var parameters = '';\r\n\r\n            var appendSeparator = function () {\r\n                parameters += (parameters === '') ? '?' : '&';\r\n            };\r\n\r\n            var option;\r\n            for (option in this.options) {\r\n                if (this.options.hasOwnProperty(option)) {\r\n                    appendSeparator();\r\n                    if (isPredicate(this.options[option])) {\r\n                        parameters += option + '=' + this.options[option].parsePredicate();\r\n                    } else {\r\n                        parameters += option + '=' + this.options[option];\r\n                    }\r\n                }\r\n            }\r\n\r\n            return parameters;\r\n        };\r\n\r\n        /**\r\n         * Class method to create a new PreparedQueryOptions object from a simple object\r\n         *\r\n         * @method fromObject\r\n         * @param {Object} object the object to build from\r\n         * @returns {PreparedQueryOptions}\r\n         */\r\n        PreparedQueryOptions.fromObject = function (object) {\r\n            var preparedQueryOptions = new PreparedQueryOptions();\r\n            var property;\r\n            for (property in object) {\r\n                if (object.hasOwnProperty(property) && typeof preparedQueryOptions[property] === \"function\") {\r\n                    preparedQueryOptions[property](object[property]);\r\n                }\r\n            }\r\n            return preparedQueryOptions;\r\n        };\r\n\r\n        return PreparedQueryOptions;\r\n    }\r\n]);","/**\r\n * The recallProvider is the entry point for common configuration options. Specific adapters may have their own\r\n * configuration options\r\n */\r\nangular.module('recall').provider('recall', [\r\n    function () {\r\n        var config = {};\r\n\r\n        // The default adapter to use unless otherwise specified by the model Definition\r\n        config.adapter = null;\r\n        this.setAdapter = function (adapter) {\r\n            config.adapter = adapter;\r\n            return this;\r\n        };\r\n\r\n        // Time in milliseconds to throttle Entity dirty checking. This allows for multiple digest cycles to pass\r\n        // between checking if an Entity is dirty by examining its stored state\r\n        config.dirtyCheckThreshold = 30;\r\n        this.setDirtyCheckThreshold = function (dirtyCheckThreshold) {\r\n            config.dirtyCheckThreshold = dirtyCheckThreshold;\r\n            return this;\r\n        };\r\n\r\n        // The default last modified field name. To enable synchronization, this must be set.\r\n        config.lastModifiedFieldName = null;\r\n        this.setLastModifiedFieldName = function (lastModifiedFieldName) {\r\n            config.lastModifiedFieldName = lastModifiedFieldName;\r\n            return this;\r\n        };\r\n\r\n        // The default soft delete field name. To enable synchronization, this must be set.\r\n        config.deletedFieldName = null;\r\n        this.setDeletedFieldName = function (deletedFieldName) {\r\n            config.deletedFieldName = deletedFieldName;\r\n            return this;\r\n        };\r\n\r\n        this.$get = ['$injector', 'recallModel', function ($injector, Model) {\r\n\r\n            var service = {\r\n                adapter: config.adapter,\r\n                lastModifiedFieldName: config.lastModifiedFieldName,\r\n                deletedFieldName: config.deletedFieldName,\r\n                dirtyCheckThreshold: config.dirtyCheckThreshold,\r\n                models: {}\r\n            };\r\n\r\n            /**\r\n             * Get an array of the defined Models.\r\n             * @returns {Entity[]} The models\r\n             */\r\n            service.getModels = function () {\r\n                var theModels = [];\r\n                var model;\r\n                for (model in this.models) {\r\n                    if (this.models.hasOwnProperty(model)) {\r\n                        theModels.push(this.models[model]);\r\n                    }\r\n                }\r\n                return theModels;\r\n            };\r\n\r\n            /**\r\n             * Gets a defined model by its name\r\n             * @param {String} modelName\r\n             * @returns {Entity} The model or null if the model is not found\r\n             */\r\n            service.getModel = function (modelName) {\r\n                return this.models[modelName] || null;\r\n            };\r\n\r\n            /**\r\n             * Creates a model based on a definition.\r\n             * @param {Object} modelDefinition The definition of the model including fields and associations\r\n             * @param {Object|String} [adapter] The adapter that is used to perform the CRUD actions\r\n             * @returns {Object} The model\r\n             */\r\n            service.defineModel = function (modelDefinition, adapter) {\r\n                adapter = adapter || this.adapter;\r\n\r\n                // If the adapter is a string, assume it is the name of the adapter factory and inject it\r\n                adapter = (typeof adapter === 'string') ? $injector.get(adapter) : adapter;\r\n\r\n                // If there was no adapter set, then return out as the model can not be used.\r\n                if (!adapter) {\r\n                    return null;\r\n                }\r\n\r\n                // TODO: Validated the model definition\r\n                if (!modelDefinition || !modelDefinition.name) {\r\n                    return null;\r\n                }\r\n\r\n                // If the model is already defined, just return it.\r\n                if (this.models[modelDefinition.name]) {\r\n                    return this.models[modelDefinition.name];\r\n                }\r\n\r\n                var model = new Model(modelDefinition);\r\n                model.setLastModifiedFieldName(this.lastModifiedFieldName);\r\n                model.setDeletedFieldName(this.deletedFieldName);\r\n                model.setAdapter(adapter);\r\n                model.setDirtyCheckThreshold(this.dirtyCheckThreshold);\r\n\r\n                var fieldsValid = model.initializeModelFields();\r\n\r\n                if (!fieldsValid) {\r\n                    return null;\r\n                }\r\n\r\n                model.initializeAssociations();\r\n\r\n                // Call the model validation on the adapter after all Entity properties and methods are set.\r\n                if (typeof adapter.modelValidationHook === 'function' && !adapter.modelValidationHook(model)) {\r\n                    return null;\r\n                }\r\n\r\n                this.models[model.modelName] = model;\r\n\r\n                return model;\r\n            };\r\n\r\n            return service;\r\n        }];\r\n    }\r\n]);"]}